<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <!-- 修改 1: 增加 viewport-fit=cover 以适配全面屏 -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>博物馆 | MUSEUM</title>

    <!-- 修改 2: 添加 Web App 专属 Meta 标签 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="博物馆" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#FCFCFC" />
    <!-- 图标 (建议替换为你自己的 URL) -->
    <link
      rel="apple-touch-icon"
      href="https://images.unsplash.com/photo-1599305445671-ac291c95aaa9?w=400&h=400&fit=crop"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              serif: ['"Noto Serif SC"', "serif"],
            },
            colors: {
              black: "#0F0F0F",
              sub: "#888888",
              bg: "#FCFCFC",
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-out",
              "slide-up": "slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
            },
            keyframes: {
              fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #fcfcfc;
        color: #0f0f0f;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        /* 防止 iOS 点击高亮 */
        -webkit-tap-highlight-color: transparent;
      }

      /* 修改 3: 适配刘海屏的安全区域 */
      header {
        /* 让 header 的背景色延伸到状态栏 */
        padding-top: env(safe-area-inset-top);
      }
      /* 调整悬浮按钮位置，防止被底部横条挡住 */
      .fixed.bottom-10 {
        bottom: calc(2.5rem + env(safe-area-inset-bottom));
      }

      .no-scroll::-webkit-scrollbar {
        display: none;
      }
      .no-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      img {
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }
      img.loaded {
        opacity: 1;
      }
      .style-btn {
        transition: all 0.3s;
        position: relative;
      }
      .style-btn:hover {
        transform: translateY(-2px);
      }
      .style-btn.active::after {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 1px solid #000;
        border-radius: 50%;
      }
      .tag-link:hover {
        color: #000;
        text-decoration: underline;
      }
    </style>
  </head>
  <!-- 其余 Body 代码保持不变... -->
  <body>
    <!-- ... 这里粘贴你原来 Body 里的所有代码 ... -->
    <!-- 注意：为了代码简洁，请使用你原来 body 里的内容，
         上面的 CSS 修改已经自动应用到了 body 里的元素 -->
    <div
      id="app"
      class="min-h-screen flex flex-col font-sans selection:bg-black selection:text-white"
    >
      <!-- ...此处省略 body 内部代码，与你提供的一致... -->

      <!-- 1. 登录层 -->
      <div
        v-if="!session"
        class="fixed inset-0 z-[100] bg-[#FCFCFC] flex flex-col items-center justify-center p-8"
      >
        <!-- 这里无需改动 -->
        <div class="w-full max-w-xs space-y-12 animate-fade-in text-center">
          <!-- ... -->
          <h1
            class="text-3xl font-serif tracking-[0.3em] font-light border-b border-black/10 pb-4 inline-block"
          >
            博物馆
          </h1>
          <div class="space-y-6">
            <!-- Inputs... -->
            <input
              v-model="config.url"
              type="text"
              placeholder="URL"
              class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
            />
            <input
              v-model="config.key"
              type="password"
              placeholder="KEY"
              class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
            />
            <div class="pt-4 space-y-4">
              <input
                v-model="auth.email"
                type="email"
                placeholder="邮箱"
                class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
              />
              <input
                v-model="auth.password"
                type="password"
                placeholder="密码"
                class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
              />
            </div>
            <button
              @click="handleLogin"
              :disabled="loading"
              class="w-full bg-black text-white py-3 text-[10px] tracking-[0.5em] mt-8 hover:bg-gray-800 transition-colors"
            >
              {{ loading ? '进入中' : '进入' }}
            </button>
            <p v-if="errorMsg" class="text-red-800 text-[10px] mt-4">
              {{ errorMsg }}
            </p>
          </div>
        </div>
      </div>

      <!-- 主界面 -->
      <div v-else class="flex-1 w-full max-w-[1920px] mx-auto relative">
        <!-- 头部 -->
        <header
          class="sticky top-0 z-40 bg-[#FCFCFC]/90 backdrop-blur-md transition-all border-b border-gray-50"
        >
          <!-- ... 原有 header 内容 ... -->
          <div
            class="px-6 py-5 flex flex-col md:flex-row md:items-center justify-between gap-4"
          >
            <!-- 标题区域 -->
            <div @click="resetFilter" class="cursor-pointer group select-none">
              <h1
                class="text-xl font-serif tracking-[0.2em] font-normal flex items-center flex-wrap gap-2"
              >
                博物馆
                <span
                  v-if="currentAlbum"
                  class="text-gray-400 text-xs font-sans tracking-normal group-hover:text-black transition-colors"
                  >/ {{ currentAlbum }}</span
                >
                <span
                  v-if="currentTag"
                  class="text-black bg-gray-100 px-2 py-0.5 rounded text-[10px] font-sans tracking-normal flex items-center gap-2"
                  >#{{ currentTag }}
                  <span
                    class="text-gray-400 hover:text-red-500"
                    @click.stop="resetFilter"
                    >&times;</span
                  ></span
                >
              </h1>
            </div>
            <nav class="flex items-center gap-6 overflow-x-auto no-scroll pr-4">
              <template v-for="(label, key) in filterMap" :key="key">
                <button
                  @click="setFilter(key)"
                  class="text-[11px] tracking-[0.1em] font-serif transition-all duration-300 relative shrink-0"
                  :class="(filter === key && !currentTag) ? 'text-black font-bold' : 'text-gray-400 hover:text-black'"
                >
                  {{ label }}
                  <span
                    v-if="filter === key && !currentTag"
                    class="absolute -bottom-1 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </template>
              <button
                @click="handleLogout"
                class="text-[10px] text-gray-300 hover:text-black ml-4 shrink-0"
              >
                退出
              </button>
            </nav>
          </div>
        </header>

        <!-- Main 内容 (省略，与原代码一致) -->
        <main class="px-4 md:px-6 py-8 min-h-[80vh]">
          <div
            v-if="loading && items.length === 0"
            class="flex justify-center py-40"
          >
            <div
              class="w-5 h-5 border-2 border-gray-100 border-t-black rounded-full animate-spin"
            ></div>
          </div>
          <div v-if="currentAlbum || currentTag" class="mb-6 animate-fade-in">
            <button
              @click="resetFilter"
              class="text-[10px] tracking-widest text-gray-400 hover:text-black transition-colors flex items-center gap-2"
            >
              <span>←</span> 返回全部
            </button>
          </div>
          <!-- 瀑布流内容 ... (省略，保持不变) -->
          <div
            class="columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-6 space-y-6 pb-32 mx-auto"
          >
            <template
              v-if="filter === 'albums' && !currentAlbum && !currentTag"
            >
              <div
                v-for="album in albumList"
                :key="album.name"
                class="break-inside-avoid mb-6 cursor-pointer group animate-slide-up"
                @click="openAlbum(album.name)"
              >
                <div class="aspect-square bg-gray-50 relative overflow-hidden">
                  <img
                    v-if="album.cover"
                    :src="album.cover"
                    @load="$event.target.classList.add('loaded')"
                    class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700"
                  />
                  <div
                    v-else
                    class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-300 tracking-widest"
                  >
                    无封面
                  </div>
                </div>
                <div
                  class="mt-2 flex justify-between items-baseline border-t border-black/5 pt-2"
                >
                  <span class="text-xs font-serif tracking-wider text-black"
                    >{{ album.name }}</span
                  >
                  <span class="text-[9px] text-gray-400 font-sans"
                    >{{ album.count }}</span
                  >
                </div>
              </div>
            </template>
            <template v-else>
              <div
                v-for="item in filteredItems"
                :key="item.id"
                class="break-inside-avoid mb-8 group relative animate-slide-up bg-white"
              >
                <!-- ... 保持原有的 item 渲染代码 ... -->
                <div
                  class="absolute top-2 right-2 z-20 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300"
                >
                  <button
                    @click.stop="handleDownload(item)"
                    title="下载/制作书摘"
                    class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm hover:scale-110 transition-transform"
                  >
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                      ></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                  <button
                    @click.stop="deleteItem(item)"
                    class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-gray-400 hover:text-red-600 shadow-sm hover:scale-110 transition-transform"
                  >
                    &times;
                  </button>
                </div>

                <!-- TEXT -->
                <div
                  v-if="item.type === 'text'"
                  class="p-6 border border-gray-100 hover:border-gray-200 transition-colors bg-white shadow-sm"
                >
                  <p
                    class="font-serif text-[13px] leading-7 text-[#222] whitespace-pre-wrap tracking-wide"
                  >
                    {{ item.content }}
                  </p>
                  <div
                    class="mt-4 flex justify-between items-center pt-3 border-t border-gray-50"
                  >
                    <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                    <span class="text-[9px] text-gray-300 font-sans"
                      >{{ formatDate(item.created_at) }}</span
                    >
                  </div>
                </div>

                <!-- IMAGE -->
                <div v-if="item.type === 'image'" class="relative">
                  <div
                    class="overflow-hidden bg-gray-50 cursor-zoom-in"
                    @click="openLightbox(item.file_url)"
                  >
                    <img
                      :src="item.file_url"
                      loading="lazy"
                      @load="$event.target.classList.add('loaded')"
                      class="w-full h-auto block grayscale-[0.1] group-hover:grayscale-0 transition-all duration-700 ease-out"
                    />
                  </div>
                  <div class="mt-3 px-1">
                    <h3
                      v-if="getRealContent(item)"
                      class="text-xs font-serif text-black mb-1"
                    >
                      {{ getRealContent(item) }}
                    </h3>
                    <div class="flex flex-wrap gap-1.5 mt-2">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- HTML -->
                <div
                  v-if="item.type === 'html'"
                  @click="handleOpenHtml(item)"
                  class="cursor-pointer group/html border border-gray-100 p-1 bg-white hover:shadow-lg transition-shadow"
                >
                  <div
                    class="w-full aspect-[4/3] bg-[#F9F9F9] relative flex flex-col items-center justify-center"
                  >
                    <span class="font-serif text-gray-200 text-3xl">HTML</span>
                  </div>
                  <div class="p-3">
                    <h3 class="text-xs font-medium text-black truncate">
                      {{ getRealContent(item) || '网页快照' }}
                    </h3>
                    <div class="flex flex-wrap gap-1.5 mt-2">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- LINK -->
                <div
                  v-if="item.type === 'link'"
                  class="cursor-pointer group/link"
                  @click="openLink(item.file_url)"
                >
                  <div
                    class="bg-white p-5 border border-gray-100 hover:border-black transition-colors duration-300"
                  >
                    <div class="flex items-start justify-between mb-3">
                      <span class="text-lg font-serif italic text-gray-400"
                        >Link</span
                      >
                      <span
                        class="text-[10px] opacity-0 group-hover/link:opacity-100 transition-opacity"
                        >↗</span
                      >
                    </div>
                    <h3
                      class="text-xs font-medium text-black leading-relaxed line-clamp-2"
                    >
                      {{ getRealContent(item) || item.file_url }}
                    </h3>
                    <div
                      class="flex flex-wrap gap-1.5 mt-3 pt-2 border-t border-gray-50"
                    >
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </main>

        <!-- 悬浮上传 -->
        <button
          @click="showUpload = true"
          class="fixed bottom-10 right-10 w-12 h-12 bg-black text-white flex items-center justify-center hover:scale-105 transition-transform duration-300 z-30 shadow-xl rounded-full"
        >
          <span class="text-xl font-light pb-1">+</span>
        </button>

        <!-- Lightbox / Upload / Export Modal ... (保持不变) -->
        <div
          v-if="lightboxImage"
          class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center animate-fade-in"
          @click="closeLightbox"
        >
          <div
            class="absolute top-6 right-6 text-white/50 hover:text-white cursor-pointer p-4 text-sm tracking-widest"
          >
            CLOSE &times;
          </div>
          <img
            :src="lightboxImage"
            @load="$event.target.classList.add('loaded')"
            class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl select-none transition-transform"
            @click.stop
          />
        </div>

        <div
          v-if="showExport"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4"
        >
          <div
            @click="closeExport"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-5xl shadow-2xl relative z-10 animate-slide-up flex flex-col md:flex-row max-h-[90vh] overflow-hidden border border-gray-100"
          >
            <div
              class="flex-1 bg-[#F5F5F5] p-4 md:p-10 flex items-center justify-center overflow-hidden"
            >
              <div
                class="relative shadow-xl"
                style="max-height: 100%; max-width: 100%"
              >
                <canvas
                  ref="quoteCanvas"
                  class="block w-auto h-auto max-w-full max-h-[60vh] md:max-h-[80vh] object-contain"
                ></canvas>
              </div>
            </div>
            <div
              class="w-full md:w-80 bg-white border-l border-gray-100 flex flex-col shrink-0"
            >
              <div
                class="p-6 border-b border-gray-50 flex justify-between items-center"
              >
                <span class="text-xs font-bold tracking-widest">书摘制作</span
                ><button
                  @click="closeExport"
                  class="text-lg hover:text-red-500 transition-colors"
                >
                  &times;
                </button>
              </div>
              <div class="p-6 flex-1 overflow-y-auto space-y-8">
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    选择风格
                  </p>
                  <div class="grid grid-cols-4 gap-4">
                    <button
                      v-for="(s, k) in styles"
                      :key="k"
                      @click="changeExportStyle(k)"
                      class="style-btn w-10 h-10 rounded-full border border-gray-200 shadow-sm"
                      :class="{active: exportStyle === k}"
                      :style="{background: s.btnColor}"
                      :title="s.name"
                    ></button>
                  </div>
                  <p class="text-center text-xs font-serif mt-3 text-gray-500">
                    {{ styles[exportStyle].name }}
                  </p>
                </div>
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    操作
                  </p>
                  <div class="space-y-3">
                    <button
                      @click="downloadAsImage"
                      class="w-full py-3 bg-black text-white text-[10px] tracking-[0.2em] hover:bg-gray-800 transition-colors"
                    >
                      保存图片
                    </button>
                    <button
                      @click="downloadAsText"
                      class="w-full py-3 border border-gray-200 text-black text-[10px] tracking-[0.2em] hover:bg-gray-50 transition-colors"
                    >
                      仅复制文本
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          v-if="showUpload"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4"
        >
          <div
            @click="showUpload = false"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-md shadow-2xl border border-gray-100 relative z-10 animate-slide-up flex flex-col max-h-[90vh]"
          >
            <!-- Upload Modal Content ... (省略) -->
            <div
              class="px-8 py-6 border-b border-gray-50 flex justify-between items-center"
            >
              <span class="text-[10px] tracking-[0.2em] font-bold uppercase"
                >入库</span
              >
              <button
                @click="showUpload = false"
                class="text-lg text-gray-300 hover:text-black"
              >
                &times;
              </button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto">
              <div class="flex gap-6 border-b border-gray-100 pb-px">
                <button
                  v-for="(label, key) in uploadTypes"
                  :key="key"
                  @click="uploadForm.type = key"
                  class="text-[10px] tracking-widest pb-3 transition-all relative"
                  :class="uploadForm.type === key ? 'text-black' : 'text-gray-400 hover:text-gray-600'"
                >
                  {{ label }}<span
                    v-if="uploadForm.type === key"
                    class="absolute bottom-0 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </div>
              <div class="space-y-4">
                <input
                  v-model="uploadForm.category"
                  type="text"
                  placeholder="标签 (多个标签请用空格或逗号隔开)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <input
                  v-if="uploadForm.type !== 'text'"
                  v-model="uploadForm.title"
                  type="text"
                  placeholder="标题 (可选)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <input
                  v-if="uploadForm.type === 'link'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="链接地址 (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>
              <div v-if="uploadForm.type === 'image'" class="pt-2">
                <label
                  class="flex items-center gap-2 cursor-pointer select-none"
                  ><input
                    type="checkbox"
                    v-model="uploadForm.useAlbum"
                    class="accent-black w-3 h-3"
                  /><span class="text-[10px] tracking-widest text-gray-500"
                    >归档至相册</span
                  ></label
                >
                <input
                  v-if="uploadForm.useAlbum"
                  v-model="uploadForm.albumName"
                  list="albums"
                  placeholder="输入相册名称..."
                  class="mt-3 w-full border-b border-gray-200 py-2 text-xs focus:border-black outline-none bg-transparent"
                />
                <datalist id="albums">
                  <option
                    v-for="a in albumList"
                    :value="a.name"
                    :key="a.name"
                  ></option>
                </datalist>
              </div>
              <textarea
                v-if="uploadForm.type === 'text'"
                v-model="uploadForm.content"
                rows="5"
                placeholder="在此输入文字内容..."
                class="w-full bg-gray-50 p-4 text-sm font-serif leading-relaxed focus:outline-none focus:bg-white focus:ring-1 focus:ring-black resize-none"
              ></textarea>
              <div
                v-if="uploadForm.type === 'image' || uploadForm.type === 'html'"
                class="border border-dashed border-gray-200 h-28 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
              >
                <input
                  type="file"
                  @change="handleFileSelect"
                  multiple
                  class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  :accept="uploadForm.type === 'image' ? 'image/*' : '.html,.htm'"
                />
                <span
                  class="text-2xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                  >+</span
                >
                <span
                  class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >{{ fileStatusText }}</span
                >
              </div>
            </div>
            <button
              @click="submitUpload"
              :disabled="uploading"
              class="w-full py-5 bg-black text-white text-[10px] tracking-[0.3em] hover:bg-gray-800 disabled:bg-gray-300 transition-colors"
            >
              {{ uploading ? 'UPLOADING' : 'CONFIRM' }}
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Script 保持不变 -->
    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const config = ref({ url: "", key: "" });
          const auth = ref({ email: "", password: "" });
          const session = ref(null);
          const items = ref([]);
          const filter = ref("all");
          const currentAlbum = ref(null);
          const currentTag = ref(null);
          const showUpload = ref(false);
          const lightboxImage = ref(null);
          const showExport = ref(false);
          const exportItem = ref(null);
          const exportStyle = ref("classic");
          const quoteCanvas = ref(null);
          const loading = ref(false);
          const uploading = ref(false);
          const errorMsg = ref("");

          const filterMap = {
            all: "全部",
            text: "文字",
            image: "影像",
            albums: "相册",
            html: "网页",
            link: "链接",
          };
          const uploadTypes = {
            text: "文字",
            image: "图片",
            html: "文件",
            link: "链接",
          };
          const uploadForm = ref({
            type: "text",
            category: "",
            title: "",
            url: "",
            content: "",
            files: [],
            useAlbum: false,
            albumName: "",
          });

          const styles = {
            classic: {
              name: "素白",
              btnColor: "#fff",
              bg: "#ffffff",
              text: "#111",
              sub: "#999",
              font: "serif",
            },
            dark: {
              name: "夜航",
              btnColor: "#1a1a1a",
              bg: "#121212",
              text: "#e0e0e0",
              sub: "#666",
              font: "serif",
            },
            cream: {
              name: "羊皮",
              btnColor: "#f5f2e9",
              bg: "#f5f2e9",
              text: "#2c2c2c",
              sub: "#8b8b80",
              font: "serif",
            },
            ink: {
              name: "水墨",
              btnColor: "#e6e6e6",
              bg: "#e8e8e8",
              text: "#000",
              sub: "#555",
              font: "serif",
              border: true,
            },
            film: {
              name: "胶片",
              btnColor: "#000",
              bg: "#000",
              text: "#ffc107",
              sub: "#888",
              font: "sans",
              letter: true,
            },
            red: {
              name: "赤红",
              btnColor: "#8B0000",
              bg: "#fff",
              text: "#8B0000",
              sub: "#D98880",
              font: "serif",
              borderRed: true,
            },
          };

          let supabase = null;

          const formatDate = (str) => {
            if (!str) return "";
            const d = new Date(str);
            return `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
          };

          const getRealContent = (item) => {
            if (!item.content) return null;
            if (item.content.startsWith("hidden:")) return null;
            return item.content;
          };

          const getTags = (item) => {
            if (!item.category) return ["未分类"];
            return item.category
              .replace(/，/g, ",")
              .split(/[, \s]+/)
              .filter((t) => t && t.trim().length > 0);
          };

          const fileStatusText = computed(() =>
            uploadForm.value.files.length === 0
              ? "点击选择文件"
              : `已选 ${uploadForm.value.files.length} 个文件`,
          );

          const albumList = computed(() => {
            const albums = {};
            items.value.forEach((item) => {
              if (item.type === "image" && item.album_name) {
                if (!albums[item.album_name])
                  albums[item.album_name] = {
                    name: item.album_name,
                    count: 0,
                    cover: item.file_url,
                  };
                albums[item.album_name].count++;
              }
            });
            return Object.values(albums);
          });

          const filteredItems = computed(() => {
            if (currentAlbum.value)
              return items.value.filter(
                (i) => i.album_name === currentAlbum.value,
              );
            if (currentTag.value) {
              return items.value.filter((i) =>
                getTags(i).includes(currentTag.value),
              );
            }
            if (filter.value === "all") return items.value;
            if (filter.value === "albums") return [];
            return items.value.filter((i) => i.type === filter.value);
          });

          onMounted(() => {
            const u = localStorage.getItem("sb_url");
            const k = localStorage.getItem("sb_key");
            if (u && k) {
              config.value.url = u;
              config.value.key = k;
              initSupabase();
            }
          });

          const initSupabase = async () => {
            try {
              if (!config.value.url) return;
              supabase = window.supabase.createClient(
                config.value.url.trim(),
                config.value.key.trim(),
              );
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                session.value = data.session;
                fetchData();
              }
            } catch (e) {}
          };

          const handleLogin = async () => {
            loading.value = true;
            errorMsg.value = "";
            try {
              const u = config.value.url.trim(),
                k = config.value.key.trim();
              localStorage.setItem("sb_url", u);
              localStorage.setItem("sb_key", k);
              if (!supabase) supabase = window.supabase.createClient(u, k);
              const { data, error } = await supabase.auth.signInWithPassword({
                email: auth.value.email.trim(),
                password: auth.value.password.trim(),
              });
              if (error) throw error;
              session.value = data.session;
              fetchData();
            } catch (e) {
              errorMsg.value = e.message;
            } finally {
              loading.value = false;
            }
          };

          const handleLogout = async () => {
            if (supabase) await supabase.auth.signOut();
            session.value = null;
            items.value = [];
          };

          const fetchData = async () => {
            if (!supabase) return;
            loading.value = true;
            const { data } = await supabase
              .from("fragments")
              .select("*")
              .order("created_at", { ascending: false });
            items.value = data || [];
            loading.value = false;
          };

          const changeExportStyle = (s) => {
            exportStyle.value = s;
            drawCard();
          };

          const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
            const paragraphs = text.split("\n");
            let currentY = y;
            paragraphs.forEach((paragraph) => {
              const words = paragraph.split("");
              let line = "";
              for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                  ctx.fillText(line, x, currentY);
                  line = words[n];
                  currentY += lineHeight;
                } else {
                  line = testLine;
                }
              }
              ctx.fillText(line, x, currentY);
              currentY += lineHeight * 1.5;
            });
            return currentY;
          };

          const drawCard = () => {
            const cvs = quoteCanvas.value;
            if (!cvs || !exportItem.value) return;
            const ctx = cvs.getContext("2d");
            const s = styles[exportStyle.value];
            const text = exportItem.value.content || "";
            const date = formatDate(exportItem.value.created_at);
            const W = 900;
            const padding = 100;
            const fontSize = 42;
            const lineHeight = 74;
            ctx.font =
              s.font === "sans"
                ? `300 ${fontSize}px "Inter"`
                : `300 ${fontSize}px "Noto Serif SC"`;
            const paragraphs = text.split("\n");
            let lineCount = 0;
            paragraphs.forEach((p) => {
              let width = 0;
              lineCount++;
              for (let char of p) {
                width += ctx.measureText(char).width;
                if (width > W - padding * 2) {
                  lineCount++;
                  width = 0;
                }
              }
            });
            const textHeight =
              lineCount * lineHeight + paragraphs.length * (lineHeight * 0.5);
            const H = Math.max(textHeight + padding * 3 + 120, 600);
            cvs.width = W;
            cvs.height = H;
            ctx.fillStyle = s.bg;
            ctx.fillRect(0, 0, W, H);
            if (s.border) {
              ctx.strokeStyle = "#555";
              ctx.lineWidth = 2;
              ctx.strokeRect(30, 30, W - 60, H - 60);
            }
            if (s.borderRed) {
              ctx.strokeStyle = "#8B0000";
              ctx.lineWidth = 4;
              ctx.strokeRect(20, 20, W - 40, H - 40);
            }
            ctx.fillStyle = s.text;
            ctx.textBaseline = "top";
            ctx.font =
              s.font === "sans"
                ? `300 ${fontSize}px "Inter"`
                : `300 ${fontSize}px "Noto Serif SC"`;
            if (s.letter) ctx.letterSpacing = "2px";
            wrapText(ctx, text, padding, padding, W - padding * 2, lineHeight);
            const footerY = H - padding + 40;
            ctx.font = `400 24px "Inter"`;
            ctx.fillStyle = s.sub;
            ctx.fillText(date, padding, footerY);
            ctx.textAlign = "right";
            ctx.font = `300 24px "Noto Serif SC"`;
            ctx.fillText("博物馆 | MUSEUM", W - padding, footerY);
          };

          const handleDownload = (item) => {
            if (item.type === "text") {
              exportItem.value = item;
              exportStyle.value = "classic";
              showExport.value = true;
              nextTick(() => drawCard());
            } else if (item.type === "link") {
              downloadString(
                `[InternetShortcut]\nURL=${item.file_url}`,
                "link.url",
                "text/plain",
              );
            } else {
              downloadFile(item.file_url, item.content || "file");
            }
          };

          const downloadString = (str, name, type) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([str], { type }));
            a.download = name;
            a.click();
          };

          const downloadFile = async (url, name) => {
            try {
              const res = await fetch(url);
              const blob = await res.blob();
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              let ext = url.split(".").pop().split("?")[0];
              if (ext.length > 4) ext = "png";
              a.download = `${name}.${ext}`;
              a.click();
            } catch {
              window.open(url, "_blank");
            }
          };

          const downloadAsImage = () => {
            const link = document.createElement("a");
            link.download = `excerpt-${Date.now()}.png`;
            link.href = quoteCanvas.value.toDataURL("image/png");
            link.click();
          };

          const downloadAsText = () => {
            navigator.clipboard
              .writeText(exportItem.value.content)
              .then(() => alert("已复制到剪贴板"));
          };

          const deleteItem = async (item) => {
            if (!confirm("确认删除?")) return;
            try {
              if (item.file_url && item.type !== "link") {
                const p = item.file_url.split("/uploads/").pop();
                if (p) await supabase.storage.from("uploads").remove([p]);
              }
              await supabase.from("fragments").delete().eq("id", item.id);
              items.value = items.value.filter((i) => i.id !== item.id);
            } catch (e) {
              alert(e.message);
            }
          };

          const handleOpenHtml = async (item) => {
            try {
              const res = await fetch(item.file_url);
              const blob = await res.blob();
              window.open(
                URL.createObjectURL(new Blob([blob], { type: "text/html" })),
                "_blank",
              );
            } catch (e) {
              alert("加载失败");
            }
          };

          const openLink = (u) =>
            window.open(u.startsWith("http") ? u : "https://" + u, "_blank");

          const handleFileSelect = (e) =>
            (uploadForm.value.files = Array.from(e.target.files));

          const selectTag = (tag) => {
            currentTag.value = tag;
            currentAlbum.value = null;
            filter.value = "all";
          };

          const submitUpload = async () => {
            if (!supabase) return;
            uploading.value = true;
            try {
              const {
                type,
                category,
                content,
                title,
                url,
                files,
                useAlbum,
                albumName,
              } = uploadForm.value;
              const cat = category || "未分类";
              const uid = session.value.user.id;
              if (type === "text")
                await supabase
                  .from("fragments")
                  .insert({ type, category: cat, content, user_id: uid });
              else if (type === "link")
                await supabase.from("fragments").insert({
                  type,
                  category: cat,
                  content: title || url,
                  file_url: url,
                  user_id: uid,
                });
              else if (files.length) {
                await Promise.all(
                  files.map(async (f) => {
                    const ext = f.name.split(".").pop();
                    const fname = `${Date.now()}-${Math.random().toString(36).substr(2, 5)}.${ext}`;
                    const { error } = await supabase.storage
                      .from("uploads")
                      .upload(fname, f, {
                        contentType: ext === "html" ? "text/html" : undefined,
                      });
                    if (error) throw error;
                    const { data } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(fname);
                    return supabase.from("fragments").insert({
                      type,
                      category: cat,
                      content: title,
                      file_url: data.publicUrl,
                      user_id: uid,
                      album_name:
                        type === "image" && useAlbum ? albumName : null,
                    });
                  }),
                );
              }
              showUpload.value = false;
              uploadForm.value = {
                type: "text",
                category: "",
                title: "",
                url: "",
                content: "",
                files: [],
                useAlbum: false,
                albumName: "",
              };
              fetchData();
            } catch (e) {
              alert(e.message);
            } finally {
              uploading.value = false;
            }
          };

          return {
            config,
            auth,
            session,
            items,
            filter,
            filterMap,
            currentAlbum,
            currentTag,
            filteredItems,
            albumList,
            styles,
            showUpload,
            uploadForm,
            loading,
            uploading,
            errorMsg,
            fileStatusText,
            uploadTypes,
            lightboxImage,
            showExport,
            exportItem,
            exportStyle,
            quoteCanvas,
            handleLogin,
            handleLogout,
            handleFileSelect,
            submitUpload,
            deleteItem,
            handleOpenHtml,
            openLink,
            setFilter: (f) => {
              filter.value = f;
              currentAlbum.value = null;
              currentTag.value = null;
            },
            openAlbum: (n) => {
              currentAlbum.value = n;
              currentTag.value = null;
            },
            resetFilter: () => {
              if (currentTag.value) currentTag.value = null;
              else if (currentAlbum.value) currentAlbum.value = null;
              else filter.value = "all";
            },
            openLightbox: (u) => (lightboxImage.value = u),
            closeLightbox: () => (lightboxImage.value = null),
            closeExport: () => {
              showExport.value = false;
              exportItem.value = null;
            },
            handleDownload,
            changeExportStyle,
            downloadAsImage,
            downloadAsText,
            formatDate,
            getRealContent,
            getTags,
            selectTag,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
