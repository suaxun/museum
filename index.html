<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>åšç‰©é¦† | MUSEUM</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="åšç‰©é¦†" />
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg"
    />
    <link rel="icon" href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg" />
    <link rel="manifest" id="my-manifest" href="" />
    <script>
      const manifestData = {
        name: "åšç‰©é¦†",
        short_name: "åšç‰©é¦†",
        start_url: ".",
        display: "standalone",
        background_color: "#FCFCFC",
        theme_color: "#FCFCFC",
        icons: [
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "192x192",
            type: "image/jpeg",
          },
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "512x512",
            type: "image/jpeg",
          },
        ],
      };
      const stringManifest = JSON.stringify(manifestData);
      const blob = new Blob([stringManifest], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);
      document.querySelector("#my-manifest").setAttribute("href", manifestURL);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- å¼•å…¥ TUS å®¢æˆ·ç«¯ç”¨äºå¤§æ–‡ä»¶ä¸Šä¼  -->
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              serif: ['"Noto Serif SC"', "serif"],
            },
            colors: {
              black: "#0F0F0F",
              sub: "#888888",
              bg: "#FCFCFC",
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-out",
              "slide-up": "slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
            },
            keyframes: {
              fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #fcfcfc;
        color: #0f0f0f;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      header {
        padding-top: env(safe-area-inset-top);
      }
      .fullscreen-layer {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .safe-bottom {
        bottom: calc(2.5rem + env(safe-area-inset-bottom));
      }
      .no-scroll::-webkit-scrollbar {
        display: none;
      }
      .no-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* ä¿®å¤å›¾ç‰‡åŠ è½½é—ªçƒé—®é¢˜ */
      .img-loading {
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }
      .img-loaded {
        opacity: 1;
      }
      .style-btn {
        transition: all 0.3s;
        position: relative;
      }
      .style-btn:hover {
        transform: translateY(-2px);
      }
      .style-btn.active::after {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 1px solid #000;
        border-radius: 50%;
      }
      .tag-link:hover {
        color: #000;
        text-decoration: underline;
      }
      .color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .color-dot:hover {
        transform: scale(1.1);
      }
      .color-dot.active {
        transform: scale(1.2);
        box-shadow:
          0 0 0 2px #fff,
          0 0 0 3px #000;
      }
      .ios-install-guide {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .ios-install-guide.show {
        transform: translateY(0);
      }
      .ios-install-arrow {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #000;
        animation: bounce 1s infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateX(-50%) translateY(0);
        }
        50% {
          transform: translateX(-50%) translateY(5px);
        }
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen flex flex-col font-sans selection:bg-black selection:text-white"
    >
      <!-- 1. ç™»å½•å±‚ -->
      <div
        v-if="!session"
        class="fixed inset-0 z-[100] bg-[#FCFCFC] flex flex-col items-center justify-center p-8 fullscreen-layer"
      >
        <div class="w-full max-w-xs space-y-12 animate-fade-in text-center">
          <h1
            class="text-3xl font-serif tracking-[0.3em] font-light border-b border-black/10 pb-4 inline-block"
          >
            åšç‰©é¦†
          </h1>
          <div class="space-y-6">
            <input
              v-model="config.url"
              type="text"
              placeholder="URL"
              class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
            />
            <input
              v-model="config.key"
              type="password"
              placeholder="KEY"
              class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
            />
            <div class="pt-4 space-y-4">
              <input
                v-model="auth.email"
                type="email"
                placeholder="é‚®ç®±"
                class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
              />
              <input
                v-model="auth.password"
                type="password"
                placeholder="å¯†ç "
                class="w-full bg-transparent border-b border-gray-200 py-2 text-[10px] tracking-widest text-center focus:border-black focus:outline-none transition-colors"
              />
            </div>
            <button
              @click="handleLogin"
              :disabled="loading"
              class="w-full bg-black text-white py-3 text-[10px] tracking-[0.5em] mt-8 hover:bg-gray-800 transition-colors"
            >
              {{ loading ? 'è¿›å…¥ä¸­' : 'è¿›å…¥' }}
            </button>
            <p v-if="errorMsg" class="text-red-800 text-[10px] mt-4">
              {{ errorMsg }}
            </p>
          </div>
        </div>
      </div>

      <!-- ä¸»ç•Œé¢ -->
      <div v-else class="flex-1 w-full max-w-[1920px] mx-auto relative">
        <!-- å¤´éƒ¨ -->
        <header
          class="sticky top-0 z-40 bg-[#FCFCFC]/90 backdrop-blur-md transition-all border-b border-gray-50"
        >
          <div
            class="px-6 py-5 flex flex-col md:flex-row md:items-center justify-between gap-4"
          >
            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <div @click="resetFilter" class="cursor-pointer group select-none">
              <h1
                class="text-xl font-serif tracking-[0.2em] font-normal flex items-center flex-wrap gap-2"
              >
                åšç‰©é¦†
                <span
                  v-if="currentAlbum"
                  class="text-gray-400 text-xs font-sans tracking-normal group-hover:text-black transition-colors flex items-center gap-2"
                >
                  / {{ currentAlbum.startsWith('.') ? currentAlbum.substring(1)
                  : currentAlbum }}
                  <button
                    @click.stop="toggleAlbumVisibility"
                    class="ml-1 px-2 py-0.5 text-[9px] rounded border border-gray-200 hover:bg-black hover:text-white hover:border-black transition-all"
                    :class="currentAlbum.startsWith('.') ? 'text-red-500 bg-red-50 border-red-100' : 'text-gray-400'"
                  >
                    {{ currentAlbum.startsWith('.') ? 'ğŸ”’ å·²éšè—' : 'ğŸ”“ å…¬å¼€' }}
                  </button>
                </span>
                <span
                  v-if="currentTag"
                  class="text-black bg-gray-100 px-2 py-0.5 rounded text-[10px] font-sans tracking-normal flex items-center gap-2"
                >
                  #{{ currentTag }}
                  <span
                    class="text-gray-400 hover:text-red-500"
                    @click.stop="resetFilter"
                    >&times;</span
                  >
                </span>
              </h1>
            </div>
            <nav class="flex items-center gap-6 overflow-x-auto no-scroll pr-4">
              <template v-for="(label, key) in filterMap" :key="key">
                <button
                  @click="setFilter(key)"
                  class="text-[11px] tracking-[0.1em] font-serif transition-all duration-300 relative shrink-0"
                  :class="(filter === key && !currentTag && !currentAlbum) ? 'text-black font-bold' : 'text-gray-400 hover:text-black'"
                >
                  {{ label }}
                  <span
                    v-if="filter === key && !currentTag && !currentAlbum"
                    class="absolute -bottom-1 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </template>
              <button
                v-if="showInstallBtn"
                @click="triggerInstall"
                class="text-[10px] bg-black text-white px-3 py-1 rounded-full hover:bg-gray-800 ml-2 shrink-0 animate-fade-in"
              >
                å®‰è£…APP
              </button>
              <button
                @click="handleLogout"
                class="text-[10px] text-gray-300 hover:text-black ml-4 shrink-0"
              >
                é€€å‡º
              </button>
            </nav>
          </div>
        </header>

        <main class="px-4 md:px-6 py-8 min-h-[80vh]">
          <div
            v-if="loading && items.length === 0"
            class="flex justify-center py-40"
          >
            <div
              class="w-5 h-5 border-2 border-gray-100 border-t-black rounded-full animate-spin"
            ></div>
          </div>

          <div v-if="currentAlbum || currentTag" class="mb-6 animate-fade-in">
            <button
              @click="resetFilter"
              class="text-[10px] tracking-widest text-gray-400 hover:text-black transition-colors flex items-center gap-2"
            >
              <span>â†</span> è¿”å›å…¨éƒ¨
            </button>
          </div>

          <div
            class="columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-6 space-y-6 pb-32 mx-auto"
          >
            <!-- ç›¸å†Œåˆ—è¡¨è§†å›¾ -->
            <template
              v-if="filter === 'albums' && !currentAlbum && !currentTag"
            >
              <div
                v-for="album in albumList"
                :key="album.realName"
                class="break-inside-avoid mb-6 cursor-pointer group animate-slide-up"
                @click="openAlbum(album.realName)"
              >
                <div class="aspect-square bg-gray-50 relative overflow-hidden">
                  <img
                    v-if="album.cover"
                    :src="album.cover"
                    @load="$event.target.classList.add('img-loaded')"
                    class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 img-loading"
                  />
                  <div
                    v-else
                    class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-300 tracking-widest"
                  >
                    æ— å°é¢
                  </div>
                </div>
                <div
                  class="mt-2 flex justify-between items-baseline border-t border-black/5 pt-2"
                >
                  <span
                    class="text-xs font-serif tracking-wider text-black flex items-center gap-1"
                  >
                    {{ album.displayName }}
                    <span
                      v-if="album.isHidden"
                      title="ä»…ç›¸å†Œå†…å¯è§"
                      class="text-[9px] text-red-300"
                      >ğŸ”’</span
                    >
                  </span>
                  <span class="text-[9px] text-gray-400 font-sans"
                    >{{ album.count }}</span
                  >
                </div>
              </div>
            </template>

            <!-- å†…å®¹åˆ—è¡¨è§†å›¾ -->
            <template v-else>
              <div
                v-for="item in filteredItems"
                :key="item.id"
                class="break-inside-avoid mb-8 group relative animate-slide-up bg-white"
              >
                <div
                  class="absolute top-2 right-2 z-20 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300"
                >
                  <button
                    @click.stop="handleEdit(item)"
                    title="ç¼–è¾‘ä¿¡æ¯"
                    class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm hover:scale-110 transition-transform"
                  >
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    @click.stop="handleDownload(item)"
                    title="ä¸‹è½½/åˆ¶ä½œä¹¦æ‘˜"
                    class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm hover:scale-110 transition-transform"
                  >
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                      ></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                  <button
                    @click.stop="deleteItem(item)"
                    title="åˆ é™¤"
                    class="w-6 h-6 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-gray-400 hover:text-red-600 shadow-sm hover:scale-110 transition-transform"
                  >
                    &times;
                  </button>
                </div>

                <!-- Text Card -->
                <div
                  v-if="item.type === 'text'"
                  class="p-6 border border-gray-100 hover:border-gray-200 transition-colors bg-white shadow-sm"
                >
                  <p
                    class="font-serif text-[13px] leading-7 text-[#222] whitespace-pre-wrap tracking-wide"
                  >
                    {{ item.content }}
                  </p>
                  <div
                    class="mt-4 flex justify-between items-center pt-3 border-t border-gray-50"
                  >
                    <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                    <span class="text-[9px] text-gray-300 font-sans"
                      >{{ formatDate(item.created_at) }}</span
                    >
                  </div>
                </div>

                <!-- Image Card -->
                <div v-if="item.type === 'image'" class="relative">
                  <div
                    class="overflow-hidden bg-gray-50 cursor-zoom-in"
                    @click="openLightbox(item.file_url)"
                  >
                    <img
                      :src="item.file_url"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-auto block grayscale-[0.1] group-hover:grayscale-0 transition-all duration-700 ease-out img-loading"
                    />
                  </div>
                  <div class="mt-3 px-1">
                    <h3
                      v-if="getRealContent(item)"
                      class="text-xs font-serif text-black mb-1"
                    >
                      {{ getRealContent(item) }}
                    </h3>
                    <div class="flex flex-wrap gap-1.5 mt-2">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Beautify Card -->
                <div
                  v-if="item.type === 'beautify'"
                  class="relative border border-gray-50 bg-white hover:shadow-lg transition-all duration-300"
                >
                  <div
                    class="overflow-hidden bg-gray-50 cursor-zoom-in relative aspect-[9/16]"
                    @click="openLightbox(getBeautifyPreview(item))"
                  >
                    <!-- æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„é¢„è§ˆå›¾ -->
                    <img
                      :src="getBeautifyPreview(item)"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-full object-cover transition-all duration-500 img-loading"
                    />
                    <div
                      class="absolute top-2 left-2 bg-black/50 backdrop-blur px-2 py-1 rounded"
                    >
                      <span class="text-[9px] text-white tracking-widest"
                        >ç¾åŒ–</span
                      >
                    </div>
                  </div>
                  <div class="p-4">
                    <h3 class="text-xs font-serif text-black mb-3 font-bold">
                      {{ getBeautifyData(item).title }}
                    </h3>

                    <!-- é¢œè‰²é€‰æ‹©å™¨ -->
                    <div class="flex items-center gap-3 mb-3 flex-wrap">
                      <div
                        v-for="(variant, idx) in getBeautifyData(item).variations"
                        :key="idx"
                        @click.stop="setBeautifyIndex(item.id, idx)"
                        class="color-dot"
                        :class="{ active: getBeautifyIndex(item.id) === idx }"
                        :style="{ backgroundColor: variant.color }"
                        :title="variant.name"
                      ></div>
                    </div>

                    <div
                      class="flex flex-wrap gap-1.5 pt-2 border-t border-gray-50"
                    >
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Chat Card (NEW æ–°å¢èŠå¤©è®°å½•å¡ç‰‡) -->
                <div
                  v-if="item.type === 'chat'"
                  class="cursor-pointer group/chat border border-gray-100 bg-white hover:shadow-lg transition-all duration-300 relative"
                  @click="handleDownload(item)"
                >
                  <div
                    class="aspect-[4/3] bg-gray-50 flex flex-col items-center justify-center border-b border-gray-50 relative overflow-hidden"
                  >
                    <!-- Icon -->
                    <div
                      class="text-gray-300 group-hover/chat:text-black transition-colors duration-500 transform group-hover/chat:scale-110"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                        ></path>
                      </svg>
                    </div>
                    <span
                      class="mt-2 text-[9px] tracking-[0.2em] text-gray-400 uppercase font-serif"
                      >Chat Log</span
                    >

                    <!-- Hover overlay -->
                    <div
                      class="absolute inset-0 bg-black/5 opacity-0 group-hover/chat:opacity-100 transition-opacity flex items-center justify-center"
                    >
                      <span
                        class="bg-white/90 px-3 py-1 rounded-full text-[9px] shadow-sm"
                        >ç‚¹å‡»ä¸‹è½½</span
                      >
                    </div>
                  </div>
                  <div class="p-4">
                    <h3
                      class="text-xs font-serif text-black leading-relaxed line-clamp-2"
                    >
                      {{ item.content || 'æœªå‘½åè®°å½•' }}
                    </h3>
                    <div
                      class="flex flex-wrap gap-1.5 mt-3 pt-2 border-t border-gray-50"
                    >
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- HTML Card -->
                <div
                  v-if="item.type === 'html'"
                  @click="handleOpenHtml(item)"
                  class="cursor-pointer group/html border border-gray-100 p-1 bg-white hover:shadow-lg transition-shadow"
                >
                  <div
                    class="w-full aspect-[4/3] bg-[#F9F9F9] relative flex flex-col items-center justify-center"
                  >
                    <span class="font-serif text-gray-200 text-3xl">HTML</span>
                  </div>
                  <div class="p-3">
                    <h3 class="text-xs font-medium text-black truncate">
                      {{ getRealContent(item) || 'ç½‘é¡µå¿«ç…§' }}
                    </h3>
                    <div class="flex flex-wrap gap-1.5 mt-2">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Link Card -->
                <div
                  v-if="item.type === 'link'"
                  class="cursor-pointer group/link"
                  @click="openLink(item.file_url)"
                >
                  <div
                    class="bg-white p-5 border border-gray-100 hover:border-black transition-colors duration-300"
                  >
                    <div class="flex items-start justify-between mb-3">
                      <span class="text-lg font-serif italic text-gray-400"
                        >Link</span
                      >
                      <span
                        class="text-[10px] opacity-0 group-hover/link:opacity-100 transition-opacity"
                        >â†—</span
                      >
                    </div>
                    <h3
                      class="text-xs font-medium text-black leading-relaxed line-clamp-2"
                    >
                      {{ getRealContent(item) || item.file_url }}
                    </h3>
                    <div
                      class="flex flex-wrap gap-1.5 mt-3 pt-2 border-t border-gray-50"
                    >
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-gray-400 uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </main>

        <!-- æ‚¬æµ®ä¸Šä¼ æŒ‰é’® -->
        <button
          @click="showUpload = true"
          class="fixed right-10 w-12 h-12 bg-black text-white flex items-center justify-center hover:scale-105 transition-transform duration-300 z-30 shadow-xl rounded-full safe-bottom"
        >
          <span class="text-xl font-light pb-1">+</span>
        </button>

        <!-- ç¯ç®± (Lightbox) -->
        <div
          v-if="lightboxImage"
          class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center animate-fade-in fullscreen-layer"
          @click="closeLightbox"
        >
          <div
            class="absolute top-6 right-6 text-white/50 hover:text-white cursor-pointer p-4 text-sm tracking-widest"
            style="margin-top: env(safe-area-inset-top)"
          >
            CLOSE &times;
          </div>
          <img
            :src="lightboxImage"
            @load="$event.target.classList.add('img-loaded')"
            class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl select-none transition-transform img-loading"
            @click.stop
          />
        </div>

        <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
        <div
          v-if="showExport"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="closeExport"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-5xl shadow-2xl relative z-10 animate-slide-up flex flex-col md:flex-row max-h-[90vh] overflow-hidden border border-gray-100"
          >
            <div
              class="flex-1 bg-[#F5F5F5] p-4 md:p-10 flex items-center justify-center overflow-hidden"
            >
              <div
                class="relative shadow-xl"
                style="max-height: 100%; max-width: 100%"
              >
                <canvas
                  ref="quoteCanvas"
                  class="block w-auto h-auto max-w-full max-h-[60vh] md:max-h-[80vh] object-contain"
                ></canvas>
              </div>
            </div>
            <div
              class="w-full md:w-80 bg-white border-l border-gray-100 flex flex-col shrink-0"
            >
              <div
                class="p-6 border-b border-gray-50 flex justify-between items-center"
              >
                <span class="text-xs font-bold tracking-widest">ä¹¦æ‘˜åˆ¶ä½œ</span>
                <button
                  @click="closeExport"
                  class="text-lg hover:text-red-500 transition-colors"
                >
                  &times;
                </button>
              </div>
              <div class="p-6 flex-1 overflow-y-auto space-y-8">
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    é€‰æ‹©é£æ ¼
                  </p>
                  <div class="grid grid-cols-4 gap-4">
                    <button
                      v-for="(s, k) in styles"
                      :key="k"
                      @click="changeExportStyle(k)"
                      class="style-btn w-10 h-10 rounded-full border border-gray-200 shadow-sm"
                      :class="{active: exportStyle === k}"
                      :style="{background: s.btnColor}"
                      :title="s.name"
                    ></button>
                  </div>
                  <p class="text-center text-xs font-serif mt-3 text-gray-500">
                    {{ styles[exportStyle].name }}
                  </p>
                </div>
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    æ“ä½œ
                  </p>
                  <div class="space-y-3">
                    <button
                      @click="downloadAsImage"
                      class="w-full py-3 bg-black text-white text-[10px] tracking-[0.2em] hover:bg-gray-800 transition-colors"
                    >
                      ä¿å­˜å›¾ç‰‡
                    </button>
                    <button
                      @click="downloadAsText"
                      class="w-full py-3 border border-gray-200 text-black text-[10px] tracking-[0.2em] hover:bg-gray-50 transition-colors"
                    >
                      ä»…å¤åˆ¶æ–‡æœ¬
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ä¸Šä¼ /ç¼–è¾‘ æ¨¡æ€æ¡† -->
        <div
          v-if="showUpload"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="showUpload = false; editingId = null;"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-md shadow-2xl border border-gray-100 relative z-10 animate-slide-up flex flex-col max-h-[90vh]"
          >
            <div
              class="px-8 py-6 border-b border-gray-50 flex justify-between items-center"
            >
              <span class="text-[10px] tracking-[0.2em] font-bold uppercase"
                >{{ editingId ? 'ç¼–è¾‘å†…å®¹' : 'å…¥åº“' }}</span
              >
              <button
                @click="showUpload = false; editingId = null;"
                class="text-lg text-gray-300 hover:text-black"
              >
                &times;
              </button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto">
              <div
                class="flex gap-6 border-b border-gray-100 pb-px overflow-x-auto no-scroll"
              >
                <button
                  v-for="(label, key) in uploadTypes"
                  :key="key"
                  @click="!editingId && (uploadForm.type = key)"
                  class="text-[10px] tracking-widest pb-3 transition-all relative shrink-0"
                  :class="[
                    uploadForm.type === key ? 'text-black' : 'text-gray-400',
                    editingId ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-600'
                  ]"
                >
                  {{ label }}<span
                    v-if="uploadForm.type === key"
                    class="absolute bottom-0 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </div>

              <div class="space-y-4">
                <input
                  v-model="uploadForm.category"
                  type="text"
                  placeholder="æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />

                <!-- é€šç”¨æ ‡é¢˜/é“¾æ¥è¾“å…¥ -->
                <input
                  v-if="uploadForm.type !== 'text'"
                  v-model="uploadForm.title"
                  type="text"
                  :placeholder="uploadForm.type === 'beautify' ? 'ç¾åŒ–ä¸»é¢˜åç§° (å¦‚: iOSå›¾æ ‡åŒ…)' : 'æ ‡é¢˜ (å¯é€‰)'"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <input
                  v-if="uploadForm.type === 'link'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="é“¾æ¥åœ°å€ (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>

              <!-- ç±»å‹ï¼šå›¾ç‰‡ -->
              <div v-if="uploadForm.type === 'image'" class="pt-2">
                <label
                  class="flex items-center gap-2 cursor-pointer select-none"
                >
                  <input
                    type="checkbox"
                    v-model="uploadForm.useAlbum"
                    class="accent-black w-3 h-3"
                  />
                  <span class="text-[10px] tracking-widest text-gray-500"
                    >å½’æ¡£è‡³ç›¸å†Œ</span
                  >
                </label>
                <input
                  v-if="uploadForm.useAlbum"
                  v-model="uploadForm.albumName"
                  list="albums"
                  placeholder="è¾“å…¥ç›¸å†Œåç§°..."
                  class="mt-3 w-full border-b border-gray-200 py-2 text-xs focus:border-black outline-none bg-transparent"
                />
                <datalist id="albums">
                  <option
                    v-for="a in albumList"
                    :value="a.displayName"
                    :key="a.realName"
                  ></option>
                </datalist>
              </div>

              <!-- ç±»å‹ï¼šæ–‡å­— -->
              <textarea
                v-if="uploadForm.type === 'text'"
                v-model="uploadForm.content"
                rows="5"
                placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—å†…å®¹..."
                class="w-full bg-gray-50 p-4 text-sm font-serif leading-relaxed focus:outline-none focus:bg-white focus:ring-1 focus:ring-black resize-none"
              ></textarea>

              <!-- ç±»å‹ï¼šå›¾ç‰‡/HTML/Chat çš„æ–‡ä»¶ä¸Šä¼  -->
              <div
                v-if="!editingId && (uploadForm.type === 'image' || uploadForm.type === 'html' || uploadForm.type === 'chat')"
                class="border border-dashed border-gray-200 h-28 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
              >
                <input
                  type="file"
                  @change="handleFileSelect"
                  multiple
                  class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  :accept="uploadForm.type === 'image' ? 'image/*' : (uploadForm.type === 'html' ? '.html,.htm' : '*/*')"
                />
                <span
                  class="text-2xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                  >+</span
                >
                <span
                  class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >{{ fileStatusText }}</span
                >
              </div>

              <!-- ç±»å‹ï¼šç¾åŒ– (Beautify) çš„ç‰¹æ®Šä¸Šä¼ ç•Œé¢ -->
              <div v-if="uploadForm.type === 'beautify'" class="space-y-6">
                <div
                  v-for="(item, index) in uploadForm.beautifyVariations"
                  :key="index"
                  class="bg-gray-50 p-4 relative border border-gray-200"
                >
                  <button
                    v-if="uploadForm.beautifyVariations.length > 1"
                    @click="removeBeautifyItem(index)"
                    class="absolute top-2 right-2 text-gray-400 hover:text-red-500"
                    title="åˆ é™¤æ­¤æ–¹æ¡ˆ"
                  >
                    &times;
                  </button>
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <input
                        type="color"
                        v-model="item.colorValue"
                        class="h-8 w-8 p-0 border-0 bg-transparent cursor-pointer"
                        title="é€‰æ‹©é¢œè‰²"
                      />
                      <input
                        type="text"
                        v-model="item.colorName"
                        placeholder="é¢œè‰²åç§° (å¦‚: çº¢è‰²)"
                        class="flex-1 bg-white px-2 text-xs border border-gray-200 focus:border-black outline-none"
                      />
                    </div>

                    <!-- é¢„è§ˆå›¾ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >é¢„è§ˆå›¾</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰é¢„è§ˆå›¾ -->
                      <div
                        v-if="item.previewUrl && !item.previewFile"
                        class="mb-2 flex items-center gap-2"
                      >
                        <img
                          :src="item.previewUrl"
                          class="w-10 h-10 object-cover rounded border border-gray-200"
                        />
                        <span class="text-[9px] text-gray-400">å½“å‰é¢„è§ˆå›¾</span>
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.previewFile = e.target.files[0]"
                        accept="image/*"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.previewFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°å›¾: {{ item.previewFile.name }}</span
                      >
                    </div>

                    <!-- çœŸå®æ–‡ä»¶ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >çœŸå®æ–‡ä»¶ (ä¸‹è½½ç”¨)</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰æ–‡ä»¶çŠ¶æ€ -->
                      <div
                        v-if="item.realUrl && !item.realFile"
                        class="mb-1 text-[9px] text-blue-500"
                      >
                        âœ“ å·²åŒ…å«æ–‡ä»¶ (æ— éœ€é‡æ–°ä¸Šä¼ ï¼Œé™¤éè¦æ›¿æ¢)
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.realFile = e.target.files[0]"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.realFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°æ–‡ä»¶: {{ item.realFile.name }}</span
                      >
                    </div>
                  </div>
                </div>
                <button
                  @click="addBeautifyItem"
                  class="w-full py-2 border border-dashed border-gray-300 text-gray-400 text-[10px] hover:border-black hover:text-black transition-colors"
                >
                  + æ·»åŠ å¦ä¸€ç§é¢œè‰²æ–¹æ¡ˆ
                </button>
              </div>
            </div>
            <button
              @click="submitUpload"
              :disabled="uploading"
              class="w-full py-5 bg-black text-white text-[10px] tracking-[0.3em] hover:bg-gray-800 disabled:bg-gray-300 transition-colors"
            >
              {{ uploading ? 'å¤„ç†ä¸­...' : (editingId ? 'ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤å…¥åº“')
              }}
            </button>
          </div>
        </div>

        <!-- iOS å®‰è£…å¼•å¯¼å¼¹çª— -->
        <div id="ios-install-guide" class="ios-install-guide">
          <div class="flex items-start gap-4">
            <div class="bg-gray-100 p-2 rounded-lg shrink-0">
              <img
                src="https://images.unsplash.com/photo-1599305445671-ac291c95aaa9?w=192&h=192&fit=crop"
                class="w-10 h-10 rounded-md"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-black mb-1">æ·»åŠ åˆ°ä¸»å±å¹•</h3>
              <p class="text-xs text-gray-500 leading-relaxed">
                ä¸ºäº†è·å¾—æ›´å¥½çš„å…¨å±ä½“éªŒï¼Œè¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„
                <span class="font-bold text-blue-600">åˆ†äº«æŒ‰é’®</span>ï¼Œç„¶åé€‰æ‹©
                <span class="font-bold text-black">â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span>ã€‚
              </p>
            </div>
            <button
              onclick="
                document
                  .getElementById('ios-install-guide')
                  .classList.remove('show')
              "
              class="text-gray-400 hover:text-black"
            >
              &times;
            </button>
          </div>
          <div class="ios-install-arrow"></div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const config = ref({ url: "", key: "" });
          const auth = ref({ email: "", password: "" });
          const session = ref(null);
          const items = ref([]);
          const filter = ref("all");
          const currentAlbum = ref(null);
          const currentTag = ref(null);
          const showUpload = ref(false);
          const lightboxImage = ref(null);
          const showExport = ref(false);
          const exportItem = ref(null);
          const exportStyle = ref("classic");
          const quoteCanvas = ref(null);
          const loading = ref(false);
          const uploading = ref(false);
          const errorMsg = ref("");
          const editingId = ref(null);

          // ç¾åŒ–ç›¸å…³çš„çŠ¶æ€ç®¡ç†ï¼šå­˜å‚¨æ¯ä¸ªå¡ç‰‡å½“å‰é€‰ä¸­çš„é¢œè‰²ç´¢å¼• { itemId: index }
          const beautifyStates = ref({});

          const showInstallBtn = ref(false);
          const deferredPrompt = ref(null);
          const isIOS =
            /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          const isStandalone =
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true;

          onMounted(() => {
            const u = localStorage.getItem("sb_url");
            const k = localStorage.getItem("sb_key");
            if (u && k) {
              config.value.url = u;
              config.value.key = k;
              initSupabase();
            }
            if (!isStandalone) {
              if (isIOS) {
                showInstallBtn.value = true;
              } else {
                window.addEventListener("beforeinstallprompt", (e) => {
                  e.preventDefault();
                  deferredPrompt.value = e;
                  showInstallBtn.value = true;
                });
              }
            }
          });

          const triggerInstall = () => {
            if (isIOS) {
              document
                .getElementById("ios-install-guide")
                .classList.add("show");
            } else {
              if (deferredPrompt.value) {
                deferredPrompt.value.prompt();
                deferredPrompt.value.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === "accepted")
                    showInstallBtn.value = false;
                  deferredPrompt.value = null;
                });
              }
            }
          };

          const filterMap = {
            all: "å…¨éƒ¨",
            text: "æ–‡å­—",
            image: "å½±åƒ",
            albums: "ç›¸å†Œ",
            beautify: "ç¾åŒ–", // æ–°å¢
            html: "ç½‘é¡µ",
            link: "é“¾æ¥",
            chat: "èŠå¤©", // æ–°å¢
          };
          const uploadTypes = {
            text: "æ–‡å­—",
            image: "å›¾ç‰‡",
            beautify: "ç¾åŒ–", // æ–°å¢
            html: "æ–‡ä»¶",
            link: "é“¾æ¥",
            chat: "èŠå¤©", // æ–°å¢
          };
          const uploadForm = ref({
            type: "text",
            category: "",
            title: "",
            url: "",
            content: "",
            files: [],
            useAlbum: false,
            albumName: "",
            // ç¾åŒ–ä¸“ç”¨æ•°æ®ç»“æ„
            beautifyVariations: [
              {
                colorName: "é»˜è®¤",
                colorValue: "#000000",
                previewFile: null,
                realFile: null,
                previewUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
                realUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
              },
            ],
          });

          const styles = {
            classic: {
              name: "ç´ ç™½",
              btnColor: "#fff",
              bg: "#ffffff",
              text: "#111",
              sub: "#999",
              font: "serif",
            },
            dark: {
              name: "å¤œèˆª",
              btnColor: "#1a1a1a",
              bg: "#121212",
              text: "#e0e0e0",
              sub: "#666",
              font: "serif",
            },
            cream: {
              name: "ç¾Šçš®",
              btnColor: "#f5f2e9",
              bg: "#f5f2e9",
              text: "#2c2c2c",
              sub: "#8b8b80",
              font: "serif",
            },
            ink: {
              name: "æ°´å¢¨",
              btnColor: "#e6e6e6",
              bg: "#e8e8e8",
              text: "#000",
              sub: "#555",
              font: "serif",
              border: true,
            },
            film: {
              name: "èƒ¶ç‰‡",
              btnColor: "#000",
              bg: "#000",
              text: "#ffc107",
              sub: "#888",
              font: "sans",
              letter: true,
            },
            red: {
              name: "èµ¤çº¢",
              btnColor: "#8B0000",
              bg: "#fff",
              text: "#8B0000",
              sub: "#D98880",
              font: "serif",
              borderRed: true,
            },
          };

          let supabase = null;

          const formatDate = (str) => {
            if (!str) return "";
            const d = new Date(str);
            return `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
          };

          const getRealContent = (item) => {
            if (item.type === "beautify") return null; // ç¾åŒ–ç±»å‹å•ç‹¬å¤„ç†
            if (!item.content) return null;
            if (item.content.startsWith("hidden:")) return null;
            // å¦‚æœæ˜¯ç¾åŒ–ç±»å‹JSONï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰ï¼Œä¸ç›´æ¥æ˜¾ç¤º
            if (item.content.trim().startsWith("{") && item.type === "beautify")
              return null;
            return item.content;
          };

          const getTags = (item) => {
            if (!item.category) return ["æœªåˆ†ç±»"];
            return item.category
              .replace(/ï¼Œ/g, ",")
              .split(/[, \s]+/)
              .filter((t) => t && t.trim().length > 0);
          };

          const fileStatusText = computed(() =>
            uploadForm.value.files.length === 0
              ? "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶"
              : `å·²é€‰ ${uploadForm.value.files.length} ä¸ªæ–‡ä»¶`,
          );

          const albumList = computed(() => {
            const albums = {};
            items.value.forEach((item) => {
              if (item.type === "image" && item.album_name) {
                if (!albums[item.album_name])
                  albums[item.album_name] = {
                    realName: item.album_name,
                    displayName: item.album_name.startsWith(".")
                      ? item.album_name.substring(1)
                      : item.album_name,
                    isHidden: item.album_name.startsWith("."),
                    count: 0,
                    cover: item.file_url,
                  };
                albums[item.album_name].count++;
              }
            });
            return Object.values(albums);
          });

          const filteredItems = computed(() => {
            if (currentAlbum.value)
              return items.value.filter(
                (i) => i.album_name === currentAlbum.value,
              );
            if (currentTag.value)
              return items.value.filter((i) =>
                getTags(i).includes(currentTag.value),
              );
            if (filter.value === "all") return items.value;
            if (filter.value === "albums") return [];
            if (filter.value === "image") {
              return items.value.filter((i) => {
                if (i.type !== "image") return false;
                if (!i.album_name) return true;
                return !i.album_name.startsWith(".");
              });
            }
            return items.value.filter((i) => i.type === filter.value);
          });

          const initSupabase = async () => {
            try {
              if (!config.value.url) return;
              supabase = window.supabase.createClient(
                config.value.url.trim(),
                config.value.key.trim(),
              );
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                session.value = data.session;
                fetchData();
              }
            } catch (e) {}
          };

          const handleLogin = async () => {
            loading.value = true;
            errorMsg.value = "";
            try {
              const u = config.value.url.trim(),
                k = config.value.key.trim();
              localStorage.setItem("sb_url", u);
              localStorage.setItem("sb_key", k);
              if (!supabase) supabase = window.supabase.createClient(u, k);
              const { data, error } = await supabase.auth.signInWithPassword({
                email: auth.value.email.trim(),
                password: auth.value.password.trim(),
              });
              if (error) throw error;
              session.value = data.session;
              fetchData();
            } catch (e) {
              errorMsg.value = e.message;
            } finally {
              loading.value = false;
            }
          };

          const handleLogout = async () => {
            if (supabase) await supabase.auth.signOut();
            session.value = null;
            items.value = [];
          };

          const fetchData = async () => {
            if (!supabase) return;
            loading.value = true;
            const { data } = await supabase
              .from("fragments")
              .select("*")
              .order("created_at", { ascending: false });
            items.value = data || [];
            loading.value = false;
          };

          // ç¾åŒ–æ¨¡å—è¾…åŠ©å‡½æ•°
          const getBeautifyData = (item) => {
            if (!item.content) return { title: "æ•°æ®å¼‚å¸¸", variations: [] };
            try {
              const data = JSON.parse(item.content);
              return data || { title: "æ— æ ‡é¢˜", variations: [] };
            } catch (e) {
              return { title: "è§£æé”™è¯¯", variations: [] };
            }
          };

          const getBeautifyIndex = (id) => {
            return beautifyStates.value[id] || 0;
          };

          const setBeautifyIndex = (id, idx) => {
            beautifyStates.value[id] = idx;
          };

          const getBeautifyPreview = (item) => {
            const data = getBeautifyData(item);
            const idx = getBeautifyIndex(item.id);
            if (data.variations && data.variations[idx]) {
              return data.variations[idx].preview;
            }
            return item.file_url; // é™çº§
          };

          const addBeautifyItem = () => {
            uploadForm.value.beautifyVariations.push({
              colorName: "",
              colorValue: "#000000",
              previewFile: null,
              realFile: null,
              previewUrl: null,
              realUrl: null,
            });
          };

          const removeBeautifyItem = (index) => {
            uploadForm.value.beautifyVariations.splice(index, 1);
          };

          const changeExportStyle = (s) => {
            exportStyle.value = s;
            drawCard();
          };

          const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
            const paragraphs = text.split("\n");
            let currentY = y;
            paragraphs.forEach((paragraph) => {
              const words = paragraph.split("");
              let line = "";
              for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                  ctx.fillText(line, x, currentY);
                  line = words[n];
                  currentY += lineHeight;
                } else {
                  line = testLine;
                }
              }
              ctx.fillText(line, x, currentY);
              currentY += lineHeight * 1.5;
            });
            return currentY;
          };

          const drawCard = () => {
            const cvs = quoteCanvas.value;
            if (!cvs || !exportItem.value) return;
            const ctx = cvs.getContext("2d");
            const s = styles[exportStyle.value];
            const text = exportItem.value.content || "";
            const date = formatDate(exportItem.value.created_at);
            const W = 900;
            const padding = 100;
            const fontSize = 42;
            const lineHeight = 74;
            ctx.font =
              s.font === "sans"
                ? `300 ${fontSize}px "Inter"`
                : `300 ${fontSize}px "Noto Serif SC"`;
            const paragraphs = text.split("\n");
            let lineCount = 0;
            paragraphs.forEach((p) => {
              let width = 0;
              lineCount++;
              for (let char of p) {
                width += ctx.measureText(char).width;
                if (width > W - padding * 2) {
                  lineCount++;
                  width = 0;
                }
              }
            });
            const textHeight =
              lineCount * lineHeight + paragraphs.length * (lineHeight * 0.5);
            const H = Math.max(textHeight + padding * 3 + 120, 600);
            cvs.width = W;
            cvs.height = H;
            ctx.fillStyle = s.bg;
            ctx.fillRect(0, 0, W, H);
            if (s.border) {
              ctx.strokeStyle = "#555";
              ctx.lineWidth = 2;
              ctx.strokeRect(30, 30, W - 60, H - 60);
            }
            if (s.borderRed) {
              ctx.strokeStyle = "#8B0000";
              ctx.lineWidth = 4;
              ctx.strokeRect(20, 20, W - 40, H - 40);
            }
            ctx.fillStyle = s.text;
            ctx.textBaseline = "top";
            ctx.font =
              s.font === "sans"
                ? `300 ${fontSize}px "Inter"`
                : `300 ${fontSize}px "Noto Serif SC"`;
            if (s.letter) ctx.letterSpacing = "2px";
            wrapText(ctx, text, padding, padding, W - padding * 2, lineHeight);
            const footerY = H - padding + 40;
            ctx.font = `400 24px "Inter"`;
            ctx.fillStyle = s.sub;
            ctx.fillText(date, padding, footerY);
            ctx.textAlign = "right";
            ctx.font = `300 24px "Noto Serif SC"`;
            ctx.fillText("åšç‰©é¦† | MUSEUM", W - padding, footerY);
          };

          const handleDownload = (item) => {
            if (item.type === "text") {
              exportItem.value = item;
              exportStyle.value = "classic";
              showExport.value = true;
              nextTick(() => drawCard());
            } else if (item.type === "link") {
              downloadString(
                `[InternetShortcut]\nURL=${item.file_url}`,
                "link.url",
                "text/plain",
              );
            } else if (item.type === "beautify") {
              // ç¾åŒ–æ–‡ä»¶ä¸‹è½½é€»è¾‘ï¼šä¸‹è½½å½“å‰é€‰ä¸­é¢œè‰²çš„çœŸå®æ–‡ä»¶
              const data = getBeautifyData(item);
              const idx = getBeautifyIndex(item.id);
              if (data.variations && data.variations[idx]) {
                const variant = data.variations[idx];
                if (variant.file) {
                  downloadFile(variant.file, `${data.title}-${variant.name}`);
                } else {
                  alert("è¯¥é¢œè‰²æ–¹æ¡ˆæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶");
                }
              }
            } else {
              // é€šç”¨æ–‡ä»¶ä¸‹è½½ï¼ˆåŒ…å« chat ç±»å‹ï¼‰
              downloadFile(item.file_url, item.content || "file");
            }
          };

          const downloadString = (str, name, type) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([str], { type }));
            a.download = name;
            a.click();
          };

          const downloadFile = async (url, name) => {
            try {
              const res = await fetch(url);
              const blob = await res.blob();
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              let ext = url.split(".").pop().split("?")[0];
              if (ext.length > 4 || ext.includes("/")) {
                const type = blob.type;
                if (type.includes("image")) ext = "png";
                else if (type.includes("zip")) ext = "zip";
                else if (type.includes("text/plain")) ext = "txt";
                else if (type.includes("json")) ext = "json";
                else ext = "file";
              }
              a.download = `${name}.${ext}`;
              a.click();
            } catch {
              window.open(url, "_blank");
            }
          };

          const downloadAsImage = () => {
            const link = document.createElement("a");
            link.download = `excerpt-${Date.now()}.png`;
            link.href = quoteCanvas.value.toDataURL("image/png");
            link.click();
          };

          const downloadAsText = () => {
            navigator.clipboard
              .writeText(exportItem.value.content)
              .then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
          };

          const deleteItem = async (item) => {
            if (!confirm("ç¡®è®¤åˆ é™¤?")) return;
            try {
              if (
                item.file_url &&
                item.type !== "link" &&
                item.type !== "beautify"
              ) {
                const p = item.file_url.split("/uploads/").pop();
                if (p) await supabase.storage.from("uploads").remove([p]);
              }
              // å¦‚æœæ˜¯ç¾åŒ–ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å¤šä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæš‚ä¸å¤„ç†æ·±åº¦æ¸…ç†ï¼Œä»…åˆ é™¤è®°å½•
              await supabase.from("fragments").delete().eq("id", item.id);
              items.value = items.value.filter((i) => i.id !== item.id);
            } catch (e) {
              alert(e.message);
            }
          };

          const handleOpenHtml = async (item) => {
            try {
              const res = await fetch(item.file_url);
              const blob = await res.blob();
              window.open(
                URL.createObjectURL(new Blob([blob], { type: "text/html" })),
                "_blank",
              );
            } catch (e) {
              alert("åŠ è½½å¤±è´¥");
            }
          };

          const openLink = (u) =>
            window.open(u.startsWith("http") ? u : "https://" + u, "_blank");

          const handleFileSelect = (e) =>
            (uploadForm.value.files = Array.from(e.target.files));

          const selectTag = (tag) => {
            currentTag.value = tag;
            currentAlbum.value = null;
            filter.value = "all";
          };

          const handleEdit = (item) => {
            editingId.value = item.id;
            const isBeautify = item.type === "beautify";
            const beautifyData = isBeautify ? getBeautifyData(item) : null;

            uploadForm.value = {
              type: item.type,
              category: item.category,
              title: isBeautify ? beautifyData.title : item.content,
              url: item.type === "link" ? item.file_url : "",
              content: item.content,
              files: [],
              useAlbum: !!item.album_name,
              albumName: item.album_name
                ? item.album_name.startsWith(".")
                  ? item.album_name.substring(1)
                  : item.album_name
                : "",
              beautifyVariations: isBeautify
                ? beautifyData.variations.map((v) => ({
                    colorName: v.name,
                    colorValue: v.color,
                    previewUrl: v.preview, // ä¿å­˜æ—§é“¾æ¥
                    realUrl: v.file, // ä¿å­˜æ—§é“¾æ¥
                    previewFile: null,
                    realFile: null,
                  }))
                : [],
            };

            if (
              isBeautify &&
              uploadForm.value.beautifyVariations.length === 0
            ) {
              addBeautifyItem();
            }

            if (item.type === "text") uploadForm.value.title = "";
            showUpload.value = true;
          };

          const toggleAlbumVisibility = async () => {
            if (!currentAlbum.value || !supabase) return;
            const oldName = currentAlbum.value;
            const isHidden = oldName.startsWith(".");
            const newName = isHidden ? oldName.substring(1) : "." + oldName;

            if (
              !confirm(
                `ç¡®è®¤å°†æ­¤ç›¸å†Œè®¾ä¸º "${isHidden ? "å…¬å¼€æ˜¾ç¤º" : "ä»…ç›¸å†Œå†…å¯è§"}" å—ï¼Ÿ\n${isHidden ? "å…¬å¼€åï¼Œå›¾ç‰‡å°†å‡ºç°åœ¨â€œå½±åƒâ€æµä¸­ã€‚" : "éšè—åï¼Œå›¾ç‰‡å°†ä»â€œå½±åƒâ€æµä¸­æ¶ˆå¤±ï¼Œä»…åœ¨æ­¤ç›¸å†Œå†…æ˜¾ç¤ºã€‚"}`,
              )
            )
              return;

            loading.value = true;
            try {
              const { error } = await supabase
                .from("fragments")
                .update({ album_name: newName })
                .eq("album_name", oldName);
              if (error) throw error;
              items.value.forEach((i) => {
                if (i.album_name === oldName) i.album_name = newName;
              });
              currentAlbum.value = newName;
            } catch (e) {
              alert("æ“ä½œå¤±è´¥: " + e.message);
            } finally {
              loading.value = false;
            }
          };

          // TUS ä¸Šä¼ è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å¤§æ–‡ä»¶
          const uploadWithTus = (file, fileName) => {
            return new Promise((resolve, reject) => {
              // æ„é€  TUS ä¸Šä¼ ç«¯ç‚¹ï¼š[PROJECT_URL]/storage/v1/upload/resumable
              const endpoint = `${config.value.url.replace(/\/$/, "")}/storage/v1/upload/resumable`;

              const upload = new tus.Upload(file, {
                endpoint: endpoint,
                retryDelays: [0, 3000, 5000, 10000, 20000],
                headers: {
                  authorization: `Bearer ${session.value.access_token}`,
                  "x-client-info": "supabase-js-web",
                },
                metadata: {
                  bucketName: "uploads",
                  objectName: fileName,
                  contentType: file.type,
                  cacheControl: "3600",
                },
                chunkSize: 6 * 1024 * 1024, // 6MB chunks
                onError: (error) => {
                  console.error("TUS Upload Failed:", error);
                  reject(error);
                },
                onSuccess: () => {
                  resolve();
                },
              });
              upload.start();
            });
          };

          const submitUpload = async () => {
            if (!supabase) return;
            uploading.value = true;
            try {
              const {
                type,
                category,
                content,
                title,
                url,
                files,
                useAlbum,
                albumName,
                beautifyVariations,
              } = uploadForm.value;
              const cat = category || "æœªåˆ†ç±»";
              const uid = session.value.user.id;
              let payload = { category: cat };

              if (type === "text") payload.content = content;
              else if (type === "link") {
                payload.content = title || url;
                payload.file_url = url;
              } else if (type === "beautify") {
                if (beautifyVariations.length === 0)
                  throw new Error("è¯·è‡³å°‘æ·»åŠ ä¸€ç§é…è‰²æ–¹æ¡ˆ");

                const variations = [];
                for (const v of beautifyVariations) {
                  // 1. å¤„ç†é¢„è§ˆå›¾
                  let previewUrl = v.previewUrl;
                  if (v.previewFile) {
                    const pExt = v.previewFile.name.split(".").pop();
                    const pName = `beautify_prev_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${pExt}`;
                    const { error: pErr } = await supabase.storage
                      .from("uploads")
                      .upload(pName, v.previewFile);
                    if (pErr) throw pErr;
                    const { data: pData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(pName);
                    previewUrl = pData.publicUrl;
                  }

                  // 2. å¤„ç†çœŸå®æ–‡ä»¶ (ç¾åŒ–æ–‡ä»¶è‹¥å¾ˆå¤§ä¹Ÿå»ºè®®èµ°TUSï¼Œä½†æ­¤å¤„å…ˆä¿æŒåŸæ ·ï¼Œè‹¥éœ€è¦å¯æ”¹)
                  let realUrl = v.realUrl;
                  if (v.realFile) {
                    const fExt = v.realFile.name.split(".").pop();
                    const fName = `beautify_file_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${fExt}`;

                    if (v.realFile.size > 6 * 1024 * 1024) {
                      await uploadWithTus(v.realFile, fName);
                    } else {
                      const { error: fErr } = await supabase.storage
                        .from("uploads")
                        .upload(fName, v.realFile);
                      if (fErr) throw fErr;
                    }

                    const { data: fData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(fName);
                    realUrl = fData.publicUrl;
                  }

                  if (!previewUrl || !realUrl) {
                    throw new Error(
                      `é…è‰² "${v.colorName || "æœªå‘½å"}" ç¼ºå°‘é¢„è§ˆå›¾æˆ–æ–‡ä»¶ï¼Œè¯·è¡¥å……ä¸Šä¼ ã€‚`,
                    );
                  }

                  variations.push({
                    name: v.colorName || "é»˜è®¤",
                    color: v.colorValue,
                    preview: previewUrl,
                    file: realUrl,
                  });
                }

                const jsonContent = JSON.stringify({
                  title: title || "æœªå‘½åä¸»é¢˜",
                  variations: variations,
                });

                payload.content = jsonContent;
                payload.file_url = variations[0].preview;
              } else {
                payload.content = title;
                if (type === "image") {
                  if (useAlbum && albumName) {
                    const existingHidden = albumList.value.find(
                      (a) => a.isHidden && a.displayName === albumName,
                    );
                    payload.album_name = existingHidden
                      ? existingHidden.realName
                      : albumName;
                  } else {
                    payload.album_name = null;
                  }
                }
              }

              if (editingId.value) {
                await supabase
                  .from("fragments")
                  .update(payload)
                  .eq("id", editingId.value);
                const idx = items.value.findIndex(
                  (i) => i.id === editingId.value,
                );
                if (idx !== -1)
                  items.value[idx] = { ...items.value[idx], ...payload };
              } else {
                if (type === "text" || type === "link" || type === "beautify") {
                  const { error } = await supabase
                    .from("fragments")
                    .insert({ ...payload, type, user_id: uid });
                  if (error) throw error;
                } else if (files.length) {
                  await Promise.all(
                    files.map(async (f) => {
                      const ext = f.name.split(".").pop();
                      const fname = `${Date.now()}-${Math.random().toString(36).substr(2, 5)}.${ext}`;

                      // æ™ºèƒ½åˆ‡æ¢ï¼šæ–‡ä»¶å¤§äº 6MB ä½¿ç”¨ TUS ä¸Šä¼ ï¼Œå¦åˆ™ä½¿ç”¨æ™®é€šä¸Šä¼ 
                      if (f.size > 6 * 1024 * 1024) {
                        await uploadWithTus(f, fname);
                      } else {
                        const { error } = await supabase.storage
                          .from("uploads")
                          .upload(fname, f, {
                            contentType:
                              ext === "html" ? "text/html" : undefined,
                          });
                        if (error) throw error;
                      }

                      const { data } = supabase.storage
                        .from("uploads")
                        .getPublicUrl(fname);

                      return supabase.from("fragments").insert({
                        type,
                        category: cat,
                        content: title,
                        file_url: data.publicUrl,
                        user_id: uid,
                        album_name: payload.album_name,
                      });
                    }),
                  );
                }
                fetchData();
              }

              showUpload.value = false;
              editingId.value = null;
              uploadForm.value = {
                type: "text",
                category: "",
                title: "",
                url: "",
                content: "",
                files: [],
                useAlbum: false,
                albumName: "",
                beautifyVariations: [
                  {
                    colorName: "é»˜è®¤",
                    colorValue: "#000000",
                    previewFile: null,
                    realFile: null,
                    previewUrl: null,
                    realUrl: null,
                  },
                ],
              };
            } catch (e) {
              alert(
                "æäº¤å¤±è´¥: " +
                  e.message +
                  "\n(å¦‚æœæ˜¯ç±»å‹é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“çº¦æŸ)",
              );
            } finally {
              uploading.value = false;
            }
          };

          return {
            config,
            auth,
            session,
            items,
            filter,
            filterMap,
            currentAlbum,
            currentTag,
            filteredItems,
            albumList,
            styles,
            showUpload,
            uploadForm,
            loading,
            uploading,
            errorMsg,
            fileStatusText,
            uploadTypes,
            lightboxImage,
            showExport,
            exportItem,
            exportStyle,
            quoteCanvas,
            handleLogin,
            handleLogout,
            handleFileSelect,
            submitUpload,
            deleteItem,
            handleOpenHtml,
            openLink,
            setFilter: (f) => {
              filter.value = f;
              currentAlbum.value = null;
              currentTag.value = null;
            },
            openAlbum: (n) => {
              currentAlbum.value = n;
              currentTag.value = null;
            },
            resetFilter: () => {
              if (currentTag.value) currentTag.value = null;
              else if (currentAlbum.value) currentAlbum.value = null;
              else filter.value = "all";
            },
            openLightbox: (u) => (lightboxImage.value = u),
            closeLightbox: () => (lightboxImage.value = null),
            closeExport: () => {
              showExport.value = false;
              exportItem.value = null;
            },
            handleDownload,
            changeExportStyle,
            downloadAsImage,
            downloadAsText,
            formatDate,
            getRealContent,
            getTags,
            selectTag,
            showInstallBtn,
            triggerInstall,
            editingId,
            handleEdit,
            toggleAlbumVisibility,

            // æ–°å¢ç¾åŒ–ç›¸å…³
            getBeautifyData,
            getBeautifyPreview,
            addBeautifyItem,
            removeBeautifyItem,
            getBeautifyIndex,
            setBeautifyIndex,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
