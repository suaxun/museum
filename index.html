<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>åšç‰©é¦† | MUSEUM</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="åšç‰©é¦†" />
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg"
    />
    <link rel="icon" href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg" />
    <link rel="manifest" id="my-manifest" href="" />
    <script>
      const manifestData = {
        name: "åšç‰©é¦†",
        short_name: "åšç‰©é¦†",
        start_url: ".",
        display: "standalone",
        background_color: "#FCFCFC",
        theme_color: "#FCFCFC",
        icons: [
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "192x192",
            type: "image/jpeg",
          },
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "512x512",
            type: "image/jpeg",
          },
        ],
      };
      const stringManifest = JSON.stringify(manifestData);
      const blob = new Blob([stringManifest], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);
      document.querySelector("#my-manifest").setAttribute("href", manifestURL);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- å¼•å…¥ TUS å®¢æˆ·ç«¯ç”¨äºå¤§æ–‡ä»¶ä¸Šä¼  -->
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              serif: ['"Noto Serif SC"', "serif"],
              pixel: ['"Press Start 2P"', "cursive"], // æ–°å¢åƒç´ å­—ä½“å®šä¹‰
            },
            colors: {
              // ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ CSS å˜é‡
              black: "var(--text-main)",
              sub: "var(--text-sub)",
              bg: "var(--bg-main)",
              panel: "var(--bg-panel)",
              border: "var(--border-color)",
              accent: "var(--accent-color)",
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-out",
              "slide-up": "slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
            },
            keyframes: {
              fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      /* === ä¸»é¢˜å®šä¹‰ === */
      :root {
        /* é»˜è®¤: ç´ ç™½ (Original) */
        --bg-main: #fcfcfc;
        --bg-panel: #ffffff;
        --text-main: #0f0f0f;
        --text-sub: #888888;
        --border-color: #f1f1f1;
        --accent-color: #000000;
      }

      /* Lavender Haze (è¿·å¹»ç´«) */
      [data-theme="lavender"] {
        --bg-main: #e6e6fa; /* æ·¡ç´«èƒŒæ™¯ */
        --bg-panel: rgba(255, 255, 255, 0.6); /* åŠé€æ˜ç»ç’ƒ */
        --text-main: #483d8b; /* æ·±å²©è“å­— */
        --text-sub: #7b68ee;
        --border-color: rgba(255, 255, 255, 0.4);
        /* backdrop-filter: blur(10px); <--- åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ƒå¯¼è‡´äº†ç‚¹å‡»å¤±æ•ˆ */
        --accent-color: #9370db;
        /* ç›´æ¥åœ¨è¿™é‡Œå®šä¹‰èƒŒæ™¯æ¸å˜ï¼Œåˆ é™¤åŸæ¥çš„ background-image å’Œæ— æ•ˆçš„ body é€‰æ‹©å™¨ */
        background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
        background-attachment: fixed;
      }

      /* Morandi (è«å…°è¿ª) */
      [data-theme="morandi"] {
        --bg-main: #e0e5df; /* ç°ç»¿ */
        --bg-panel: #f0f2ef;
        --text-main: #5f6f65; /* æ·±ç°ç»¿ */
        --text-sub: #9ca8a3;
        --border-color: #d1d9d4;
        --accent-color: #8c9e96;
      }
      [data-theme="morandi"] body {
        background-color: #e0e5df;
      }
      /* === æ–°å¢ä¸»é¢˜å¼€å§‹ === */

      /* 1. Midnight (å¤œèˆª - é«˜çº§æš—é»‘) */
      [data-theme="midnight"] {
        --bg-main: #09090b; /* æè‡´æ·±ç°é»‘ */
        --bg-panel: #18181b; /* ç¨å¾®äº®ä¸€ç‚¹çš„é¢æ¿ */
        --text-main: #e4e4e7; /* æŸ”å’Œç™½å­— */
        --text-sub: #71717a;
        --border-color: #27272a;
        --accent-color: #ffffff;
      }
      [data-theme="midnight"] body {
        background-color: #000000;
      }

      /* 2. Sakura (è½æ¨± - è½¯èŒå¯çˆ±) */
      [data-theme="sakura"] {
        --bg-main: #fff0f3; /* æµ…ç²‰èƒŒæ™¯ */
        --bg-panel: rgba(255, 255, 255, 0.85);
        --text-main: #5e3a45; /* å·§å…‹åŠ›è‰²å­—ä½“ */
        --text-sub: #d4a5b0;
        --border-color: #ffdae2;
        --accent-color: #ff8fa3; /* äº®ç²‰è‰²ç‚¹ç¼€ */
        background-image:
          radial-gradient(#ffe4e9 20%, transparent 20%),
          radial-gradient(#ffe4e9 20%, transparent 20%);
        background-size: 20px 20px;
        background-position:
          0 0,
          10px 10px;
      }

      /* 3. Cyan (é’é»› - å›½é£é›…éŸµ) */
      [data-theme="cyan"] {
        --bg-main: #f2f5f4; /* ææ·¡é’ç° */
        --bg-panel: #ffffff;
        --text-main: #2b4541; /* æ·±é’é»›è‰² */
        --text-sub: #8faeb0;
        --border-color: #dae3e1;
        --accent-color: #4a7570;
      }
      [data-theme="cyan"] body {
        background: linear-gradient(to bottom, #f2f5f4, #e6ebe9);
        background-attachment: fixed;
      }

      /* === åœ¨ <style> æ ‡ç­¾å†…ï¼Œæ¥ç€åŸæ¥çš„ä¸»é¢˜å¾€ä¸‹å†™ === */

      /* 1. æ‚å¿—é£ (Magazine) - é«˜çº§ã€è¡¬çº¿ä½“ã€çº¢é»‘æ’è‰² */
      [data-theme="magazine"] {
        --bg-main: #f2f2f2; /* æµ…ç°çº¸å¼ åº•è‰² */
        --bg-panel: #ffffff;
        --text-main: #1a1a1a; /* çº¯é»‘æ–‡å­— */
        --text-sub: #555555;
        --border-color: #000000; /* å¼ºçƒˆçš„é»‘è‰²è¾¹æ¡† */
        --accent-color: #cc3300; /* æ‚å¿—çº¢ */
      }
      /* æ‚å¿—é£ç‰¹æœ‰ï¼šå¼ºåˆ¶ä½¿ç”¨è¡¬çº¿å­—ä½“ï¼Œè¥é€ é˜…è¯»æ„Ÿ */
      [data-theme="magazine"] body {
        font-family: "Noto Serif SC", serif !important;
      }
      [data-theme="magazine"] .rounded-full,
      [data-theme="magazine"] .rounded-lg,
      [data-theme="magazine"] .rounded {
        border-radius: 0 !important; /* æ‚å¿—é£è¦ç›´è§’ï¼Œä¸è¦åœ†è§’ */
      }
      [data-theme="magazine"] header,
      [data-theme="magazine"] .bg-white {
        border: 1px solid #000 !important; /* ç»™å¡ç‰‡åŠ é»‘è¾¹ */
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1); /* ç¡¬æœ—çš„é˜´å½± */
      }

      /* 2. å¥¶æ²¹é£ (Cream) - èŒç³»ã€è½¯ç³¯ã€æš–é»„ */
      [data-theme="cream"] {
        --bg-main: #fffbf0; /* æš–é»„å¥¶æ²¹è‰² */
        --bg-panel: #ffffff;
        --text-main: #5d4037; /* å·§å…‹åŠ›è‰²æ–‡å­— */
        --text-sub: #a1887f;
        --border-color: #fae3d9;
        --accent-color: #ffab91; /* èœœæ¡ƒè‰² */
      }
      [data-theme="cream"] body {
        background-image: radial-gradient(#ffe0b2 20%, transparent 20%);
        background-size: 20px 20px; /* æ³¢ç‚¹èƒŒæ™¯ */
      }
      [data-theme="cream"] .rounded-lg,
      [data-theme="cream"] img {
        border-radius: 20px !important; /* å¢åŠ åœ†æ¶¦åº¦ */
      }

      /* 3. æ·±æµ· (Midnight) - é«˜çº§æš—é»‘ã€ç£¨ç ‚è´¨æ„Ÿ */
      [data-theme="midnight"] {
        --bg-main: #0f172a; /* æ·±è“é»‘ */
        --bg-panel: rgba(30, 41, 59, 0.7); /* åŠé€æ˜æ·±è‰²ç»ç’ƒ */
        --text-main: #f8fafc; /* äº®ç™½ */
        --text-sub: #94a3b8; /* è“ç° */
        --border-color: #334155;
        --accent-color: #38bdf8; /* å¤©è“é«˜äº® */
      }
      [data-theme="midnight"] body {
        background: linear-gradient(to bottom, #0f172a, #1e293b);
        background-attachment: fixed;
      }

      /* 5. Paper (ç¾Šçš®å· - é˜…è¯»è´¨æ„Ÿ) */
      [data-theme="paper"] {
        --bg-main: #f7f3e8; /* æš–é»„çº¸å¼ è‰² */
        --bg-panel: #fdfbf7;
        --text-main: #3c3836; /* å¢¨é»‘ */
        --text-sub: #928374;
        --border-color: #e6dfc9;
        --accent-color: #b85c39; /* å°æ³¥çº¢ */
      }
      /* === æ–°å¢ä¸»é¢˜ç»“æŸ === */

      /* Pixel (åƒç´ é£) */
      [data-theme="pixel"] {
        --bg-main: #d0d0d0;
        --bg-panel: #ffffff;
        --text-main: #000000;
        --text-sub: #555555;
        --border-color: #000000;
        --accent-color: #0000ff;
      }
      [data-theme="pixel"] body {
        font-family:
          "Press Start 2P", cursive !important; /* å¼ºåˆ¶å…¨ç«™åƒç´ å­—ä½“ */
        background-image: radial-gradient(#000 1px, transparent 1px);
        background-size: 20px 20px;
        background-color: #e0e0e0;
      }
      /* åƒç´ é£ç‰¹æ®Šæ ·å¼ï¼šç§»é™¤åœ†è§’ï¼Œå¢åŠ é»‘è¾¹ */
      [data-theme="pixel"] .rounded-full,
      [data-theme="pixel"] .rounded-lg,
      [data-theme="pixel"] .rounded-xl,
      [data-theme="pixel"] .rounded,
      [data-theme="pixel"] input,
      [data-theme="pixel"] button,
      [data-theme="pixel"] img {
        border-radius: 0 !important;
      }
      /* è®©åƒç´ é£å¡ç‰‡æœ‰æ›´æ˜æ˜¾çš„é»‘è¾¹ */
      [data-theme="pixel"] .border {
        border-width: 2px !important;
      }
      [data-theme="pixel"] .fullscreen-layer,
      [data-theme="pixel"] header {
        border-bottom: 2px solid #000 !important;
      }
      [data-theme="pixel"] input {
        border: 2px solid #000 !important;
      }
      body {
        background-color: var(--bg-main);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
        transition:
          background-color 0.5s ease,
          color 0.5s ease;
        -moz-osx-font-smoothing: grayscale;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      header {
        padding-top: env(safe-area-inset-top);
      }
      .fullscreen-layer {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .safe-bottom {
        bottom: calc(2.5rem + env(safe-area-inset-bottom));
      }
      .no-scroll::-webkit-scrollbar {
        display: none;
      }
      .no-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* ä¿®å¤å›¾ç‰‡åŠ è½½é—ªçƒé—®é¢˜ */
      .img-loading {
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }
      .img-loaded {
        opacity: 1;
      }
      .style-btn {
        transition: all 0.3s;
        position: relative;
      }
      .style-btn:hover {
        transform: translateY(-2px);
      }
      .style-btn.active::after {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 1px solid #000;
        border-radius: 50%;
      }
      .tag-link:hover {
        color: #000;
        text-decoration: underline;
      }
      .color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .color-dot:hover {
        transform: scale(1.1);
      }
      .color-dot.active {
        transform: scale(1.2);
        box-shadow:
          0 0 0 2px #fff,
          0 0 0 3px #000;
      }
      .ios-install-guide {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .ios-install-guide.show {
        transform: translateY(0);
      }
      .ios-install-arrow {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #000;
        animation: bounce 1s infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateX(-50%) translateY(0);
        }
        50% {
          transform: translateX(-50%) translateY(5px);
        }
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen flex flex-col font-sans selection:bg-black selection:text-white"
    >
      <!-- 1. ç™»å½•å±‚ (é«˜çº§å†·æ·¡é£ / å›ºå®šURLç‰ˆ) -->
      <div
        v-if="!session"
        class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-8 transition-all duration-1000"
        style="
          background-image: url(&quot;https://i.postimg.cc/k4G0JmTV/com-xingin-xhs-20260213125939.jpg&quot;);
          background-size: cover;
          background-position: center;
        "
      >
        <!-- 1. åŠ å¼ºç‰ˆé®ç½©ï¼šç”±åŸæ¥çš„ white/10 æ”¹ä¸º white/30ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªèŠ±çœ‹ä¸æ¸…å­— -->
        <div class="absolute inset-0 bg-white/30 backdrop-blur-sm"></div>

        <!-- 2. ç»ç’ƒå¡ç‰‡ï¼šé«˜å¼ºåº¦ç£¨ç ‚ + é”åˆ©ç›´è§’ -->
        <div
          class="relative w-full max-w-[340px] bg-white/40 backdrop-blur-2xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] p-12 animate-fade-in flex flex-col items-center border border-white/60"
        >
          <!-- è£…é¥°ï¼šé¡¶éƒ¨æç»†é»‘çº¿ -->
          <div class="absolute top-0 left-0 w-full h-[2px] bg-black"></div>

          <!-- LOGO -->
          <h1
            class="text-4xl font-serif tracking-[0.4em] font-normal text-black mb-14 mt-2 select-none"
          >
            MUSEUM
          </h1>

          <div class="w-full space-y-10">
            <!-- URL è¾“å…¥æ¡†å·²åˆ é™¤ï¼Œå›ºå®šåœ¨ä»£ç é‡Œ -->

            <!-- KEY è¾“å…¥ -->
            <div class="relative group">
              <input
                v-model="config.key"
                type="password"
                placeholder="ACCESS KEY"
                style="
                  color: #000000 !important;
                  -webkit-text-fill-color: #000000 !important;
                "
                class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
              />
              <!-- åº•éƒ¨é»‘çº¿åŠ¨ç”» -->
              <span
                class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
              ></span>
            </div>

            <!-- é‚®ç®±/å¯†ç  ç»„åˆ -->
            <div class="space-y-6 pt-2">
              <div class="relative group">
                <input
                  v-model="auth.email"
                  type="email"
                  placeholder="EMAIL"
                  style="
                    color: #000000 !important;
                    -webkit-text-fill-color: #000000 !important;
                  "
                  class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
                />
                <span
                  class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
                ></span>
              </div>

              <div class="relative group">
                <input
                  v-model="auth.password"
                  type="password"
                  placeholder="PASSWORD"
                  style="
                    color: #000000 !important;
                    -webkit-text-fill-color: #000000 !important;
                  "
                  class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
                />
                <span
                  class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
                ></span>
              </div>
            </div>

            <!-- æŒ‰é’®ï¼šçº¯é»‘å—ï¼Œæ— åœ†è§’ -->
            <button
              @click="handleLogin"
              :disabled="loading"
              class="w-full bg-black text-white py-4 text-[10px] font-bold tracking-[0.5em] hover:bg-gray-900 active:scale-95 transition-all shadow-xl hover:shadow-2xl mt-4"
            >
              {{ loading ? 'ENTERING' : 'ENTER' }}
            </button>

            <p
              v-if="errorMsg"
              class="text-red-900 font-medium text-[10px] text-center bg-white/40 py-2 px-2 backdrop-blur-sm"
            >
              {{ errorMsg }}
            </p>
          </div>
        </div>

        <!-- åº•éƒ¨ç‰ˆæƒï¼šå¢åŠ é»‘è‰²é˜´å½±ç¡®ä¿åœ¨äº®èƒŒæ™¯ä¸Šå¯è§ -->
        <div
          class="absolute bottom-10 text-[9px] text-black tracking-[0.3em] font-serif opacity-70 mix-blend-multiply"
        >
          DESIGNED BY ANTIGRAVITY
        </div>
      </div>

      <!-- ä¸»ç•Œé¢ -->
      <div v-else class="flex-1 w-full max-w-[1920px] mx-auto relative">
        <header
          class="sticky top-0 z-40 bg-bg/90 backdrop-blur-md transition-all border-b border-gray-50"
          :class="currentTheme === 'pixel' ? 'border-b-2 border-black bg-white' : ''"
        >
          <div
            class="px-6 py-5 flex flex-col md:flex-row md:items-center justify-between gap-4"
          >
            <!-- æ ‡é¢˜åŒºåŸŸ (ä¿®æ”¹ç‰ˆ) -->
            <div class="flex items-center gap-3 select-none">
              <!-- 1. å¯ç‚¹å‡»çš„ LOGOï¼šç‚¹å‡»æ‰“å¼€ä¸»é¢˜èœå• -->
              <div
                @click="showThemeModal = true"
                class="cursor-pointer hover:opacity-60 transition-opacity flex items-center gap-2 group/logo"
                title="ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜é£æ ¼"
              >
                <h1
                  class="text-xl font-serif tracking-[0.2em] font-normal text-black group-hover/logo:text-accent transition-colors"
                >
                  åšç‰©é¦†
                </h1>
                <!-- ä¸€ä¸ªå°å›¾æ ‡æç¤ºå¯ä»¥ç‚¹ -->
                <span
                  class="text-[8px] bg-black text-white px-1 rounded opacity-0 group-hover/logo:opacity-100 transition-opacity"
                  >THEME</span
                >
              </div>

              <!-- 2. é¢åŒ…å±‘å¯¼èˆªï¼šç‚¹å‡»è¿”å›å…¨éƒ¨ -->
              <div
                v-if="currentAlbum || currentTag"
                @click="resetFilter"
                class="flex items-center gap-2 cursor-pointer hover:opacity-70 transition-opacity"
              >
                <span class="text-gray-300">/</span>

                <!-- ç›¸å†Œæ˜¾ç¤º -->
                <span
                  v-if="currentAlbum"
                  class="text-sub text-xs font-sans tracking-normal flex items-center gap-2"
                >
                  {{ currentAlbum.startsWith('.') ? currentAlbum.substring(1) :
                  currentAlbum }}
                  <button
                    @click.stop="toggleAlbumVisibility"
                    class="ml-1 px-2 py-0.5 text-[9px] rounded border border-gray-200 hover:bg-black hover:text-white hover:border-black transition-all"
                    :class="currentAlbum.startsWith('.') ? 'text-red-500 bg-red-50 border-red-100' : 'text-sub'"
                  >
                    {{ currentAlbum.startsWith('.') ? 'ğŸ”’' : 'ğŸ”“' }}
                  </button>
                </span>

                <!-- æ ‡ç­¾æ˜¾ç¤º -->
                <span
                  v-if="currentTag"
                  class="text-black bg-gray-100 px-2 py-0.5 rounded text-[10px] font-sans tracking-normal flex items-center gap-2"
                >
                  #{{ currentTag }}
                  <span class="text-gray-400 hover:text-red-500">&times;</span>
                </span>
              </div>
            </div>

            <!-- å³ä¾§å¯¼èˆª (ä¿æŒä¸å˜) -->
            <nav class="flex items-center gap-6 overflow-x-auto no-scroll pr-4">
              <template v-for="(label, key) in filterMap" :key="key">
                <button
                  @click="setFilter(key)"
                  class="text-[11px] tracking-[0.1em] font-serif transition-all duration-300 relative shrink-0"
                  :class="(filter === key && !currentTag && !currentAlbum) ? 'text-black font-bold' : 'text-sub hover:text-black'"
                >
                  {{ label }}
                  <span
                    v-if="filter === key && !currentTag && !currentAlbum"
                    class="absolute -bottom-1 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </template>
              <!-- ...å…¶ä»–æŒ‰é’®ä¿æŒä¸å˜... -->
              <button
                @click="handleLogout"
                class="text-[10px] text-gray-300 hover:text-black ml-4 shrink-0"
              >
                é€€å‡º
              </button>
            </nav>
          </div>
        </header>

        <main class="px-4 md:px-6 py-8 min-h-[80vh]">
          <div
            v-if="loading && items.length === 0"
            class="flex justify-center py-40"
          >
            <div
              class="w-5 h-5 border-2 border-gray-100 border-t-black rounded-full animate-spin"
            ></div>
          </div>

          <div v-if="currentAlbum || currentTag" class="mb-6 animate-fade-in">
            <button
              @click="resetFilter"
              class="text-[10px] tracking-widest text-gray-400 hover:text-black transition-colors flex items-center gap-2"
            >
              <span>â†</span> è¿”å›å…¨éƒ¨
            </button>
          </div>

          <div
            class="columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-6 space-y-6 pb-32 mx-auto"
          >
            <!-- ç›¸å†Œåˆ—è¡¨è§†å›¾ -->
            <template
              v-if="filter === 'albums' && !currentAlbum && !currentTag"
            >
              <div
                v-for="album in albumList"
                :key="album.realName"
                class="break-inside-avoid mb-6 cursor-pointer group animate-slide-up"
                @click="openAlbum(album.realName)"
              >
                <div class="aspect-square bg-gray-50 relative overflow-hidden">
                  <img
                    v-if="album.cover"
                    :src="album.cover"
                    @load="$event.target.classList.add('img-loaded')"
                    class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 img-loading"
                  />
                  <div
                    v-else
                    class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-300 tracking-widest"
                  >
                    æ— å°é¢
                  </div>
                </div>
                <div
                  class="mt-2 flex justify-between items-baseline border-t border-black/5 pt-2"
                >
                  <span
                    class="text-xs font-serif tracking-wider text-black flex items-center gap-1"
                  >
                    {{ album.displayName }}
                    <span
                      v-if="album.isHidden"
                      title="ä»…ç›¸å†Œå†…å¯è§"
                      class="text-[9px] text-red-300"
                      >ğŸ”’</span
                    >
                  </span>
                  <span class="text-[9px] text-gray-400 font-sans"
                    >{{ album.count }}</span
                  >
                </div>
              </div>
            </template>

            <!-- å†…å®¹åˆ—è¡¨è§†å›¾ -->
            <template v-else>
              <div
                v-for="item in filteredItems"
                :key="item.id"
                class="break-inside-avoid mb-8 group relative animate-slide-up"
              >
                <!-- æ‚¬æµ®æ“ä½œæŒ‰é’® (ä¿æŒä¸å˜ï¼Œä½†èƒŒæ™¯æ”¹ä¸ºè·Ÿéšé¢æ¿é¢œè‰²) -->
                <div
                  class="absolute top-2 right-2 z-20 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300"
                >
                  <button
                    @click.stop="handleEdit(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    <!-- SVG icons ä¿æŒä¸å˜ -->
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    @click.stop="handleDownload(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                      ></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                  <button
                    @click.stop="deleteItem(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-gray-400 hover:text-red-600 shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    &times;
                  </button>
                </div>

                <!-- 
                   é‡ç‚¹ä¿®æ”¹ï¼š
                   1. bg-white -> bg-panel (èƒŒæ™¯è‰²è·Ÿéšä¸»é¢˜)
                   2. border-gray-100 -> border-border (è¾¹æ¡†è·Ÿéšä¸»é¢˜)
                   3. text-[#222] -> text-black (å­—ä½“é¢œè‰²è·Ÿéšä¸»é¢˜)
                   4. æ·»åŠ  rounded-xl (ä¸ºäº†è®©åƒç´ é£/æ‚å¿—é£å¯ä»¥é€šè¿‡ CSS å»æ‰åœ†è§’)
                -->

                <!-- Text Card -->
                <div
                  v-if="item.type === 'text'"
                  class="p-6 border border-border bg-panel shadow-sm hover:shadow-md transition-all duration-300 rounded-xl"
                >
                  <p
                    class="font-serif text-[13px] leading-7 text-black whitespace-pre-wrap tracking-wide"
                  >
                    {{ item.content }}
                  </p>
                  <div
                    class="mt-4 flex justify-between items-center pt-3 border-t border-border/50"
                  >
                    <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                      <span
                        v-for="tag in getTags(item)"
                        :key="tag"
                        @click.stop="selectTag(tag)"
                        class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                        >#{{ tag }}</span
                      >
                    </div>
                    <span class="text-[9px] text-sub font-sans"
                      >{{ formatDate(item.created_at) }}</span
                    >
                  </div>
                </div>

                <!-- Image Card -->
                <div v-if="item.type === 'image'" class="relative">
                  <!-- å›¾ç‰‡å®¹å™¨èƒŒæ™¯ä¹Ÿæ”¹ä¸ºé€æ˜æˆ–é¢æ¿è‰² -->
                  <div
                    class="overflow-hidden bg-gray-50/50 rounded-xl cursor-zoom-in"
                    @click="openLightbox(item.file_url)"
                  >
                    <img
                      :src="item.file_url"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-auto block grayscale-[0.1] group-hover:grayscale-0 transition-all duration-700 ease-out img-loading rounded-xl"
                    />
                  </div>
                  <div class="mt-3 px-1">
                    <h3
                      v-if="getRealContent(item)"
                      class="text-xs font-serif text-black mb-1"
                    >
                      {{ getRealContent(item) }}
                    </h3>
                    <div
                      class="mt-2 flex justify-between items-end border-t border-border/50 pt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans ml-2 shrink-0"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Beautify Card -->
                <div
                  v-if="item.type === 'beautify'"
                  class="relative border border-border bg-panel hover:shadow-lg transition-all duration-300 rounded-xl overflow-hidden"
                >
                  <div
                    class="overflow-hidden bg-gray-50 cursor-zoom-in relative aspect-[9/16]"
                    @click="openLightbox(getBeautifyPreview(item))"
                  >
                    <img
                      :src="getBeautifyPreview(item)"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-full object-cover transition-all duration-500 img-loading"
                    />
                    <div
                      class="absolute top-2 left-2 bg-black/50 backdrop-blur px-2 py-1 rounded"
                    >
                      <span class="text-[9px] text-white tracking-widest"
                        >ç¾åŒ–</span
                      >
                    </div>
                  </div>
                  <div class="p-4">
                    <div class="flex justify-between items-start mb-3 gap-2">
                      <h3
                        class="text-xs font-serif text-black font-bold pt-1 break-all"
                      >
                        {{ getBeautifyData(item).title }}
                      </h3>
                      <button
                        @click.stop="exportBeautifyPackage(item)"
                        class="text-sub hover:text-black transition-colors p-1 shrink-0"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                          <polyline points="7 10 12 15 17 10" />
                          <line x1="12" y1="15" x2="12" y2="3" />
                          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                        </svg>
                      </button>
                    </div>

                    <div class="flex items-center gap-3 mb-3 flex-wrap">
                      <div
                        v-for="(variant, idx) in getBeautifyData(item).variations"
                        :key="idx"
                        @click.stop="setBeautifyIndex(item.id, idx)"
                        class="color-dot border-border"
                        :class="{ active: getBeautifyIndex(item.id) === idx }"
                        :style="{ backgroundColor: variant.color }"
                      ></div>
                    </div>

                    <div
                      class="flex justify-between items-center pt-2 border-t border-border/50 mt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Chat Card -->
                <div
                  v-if="item.type === 'chat'"
                  class="cursor-pointer group/chat border border-border bg-panel hover:shadow-lg transition-all duration-300 relative rounded-xl overflow-hidden"
                  @click="handleDownload(item)"
                >
                  <div
                    class="aspect-[4/3] bg-gray-50/50 flex flex-col items-center justify-center border-b border-border relative overflow-hidden"
                  >
                    <div
                      class="text-sub group-hover/chat:text-black transition-colors duration-500 transform group-hover/chat:scale-110"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                        ></path>
                      </svg>
                    </div>
                    <span
                      class="mt-2 text-[9px] tracking-[0.2em] text-sub uppercase font-serif"
                      >Chat Log</span
                    >
                  </div>
                  <div class="p-4">
                    <h3
                      class="text-xs font-serif text-black leading-relaxed line-clamp-2"
                    >
                      {{ item.content || 'æœªå‘½åè®°å½•' }}
                    </h3>
                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- HTML Card -->
                <div
                  v-if="item.type === 'html'"
                  @click="handleOpenHtml(item)"
                  class="cursor-pointer group/html border border-border p-1 bg-panel hover:shadow-lg transition-shadow rounded-xl overflow-hidden"
                >
                  <div
                    class="w-full aspect-[4/3] bg-gray-50/30 relative flex flex-col items-center justify-center rounded-lg"
                  >
                    <span class="font-serif text-sub/50 text-3xl">HTML</span>
                  </div>
                  <div class="p-3">
                    <h3 class="text-xs font-medium text-black truncate">
                      {{ getRealContent(item) || 'ç½‘é¡µå¿«ç…§' }}
                    </h3>
                    <div
                      class="mt-2 flex justify-between items-end border-t border-border/50 pt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Link Card -->
                <div
                  v-if="item.type === 'link'"
                  class="cursor-pointer group/link rounded-xl overflow-hidden"
                  @click="openLink(item.file_url)"
                >
                  <div
                    class="bg-panel p-5 border border-border hover:border-black transition-colors duration-300"
                  >
                    <div class="flex items-start justify-between mb-3">
                      <span class="text-lg font-serif italic text-sub"
                        >Link</span
                      >
                      <span
                        class="text-[10px] opacity-0 group-hover/link:opacity-100 transition-opacity text-black"
                        >â†—</span
                      >
                    </div>
                    <h3
                      class="text-xs font-medium text-black leading-relaxed line-clamp-2"
                    >
                      {{ getRealContent(item) || item.file_url }}
                    </h3>
                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>
                <!-- === æ–°å¢ï¼šFont Card === -->
                <div
                  v-if="item.type === 'font'"
                  class="cursor-pointer group/font border border-border bg-panel hover:shadow-lg transition-all duration-300 rounded-xl overflow-hidden"
                  @click="handleDownload(item)"
                >
                  <!-- é¢„è§ˆåŒºåŸŸï¼šä½¿ç”¨åŠ¨æ€åŠ è½½çš„å­—ä½“ -->
                  <div
                    class="aspect-[4/3] bg-gray-50/50 flex flex-col items-center justify-center relative overflow-hidden p-4"
                  >
                    <!-- è¿™é‡Œçš„ fontFamily å¯¹åº” JS ä¸­ç”Ÿæˆçš„åç§° -->
                    <span
                      class="text-4xl md:text-5xl text-black transition-transform duration-500 group-hover/font:scale-110 text-center break-all leading-tight"
                      :style="{ fontFamily: `'font_${item.id}', sans-serif` }"
                    >
                      {{ item.content || 'Aa' }}
                    </span>

                    <!-- è£…é¥°èƒŒæ™¯å­— -->
                    <span
                      class="absolute text-[8rem] text-black/5 font-serif select-none -z-10 pointer-events-none"
                      >Aa</span
                    >
                  </div>

                  <!-- ä¿¡æ¯åŒºåŸŸ -->
                  <div class="p-4 border-t border-border">
                    <div class="flex items-center justify-between mb-1">
                      <span
                        class="text-[9px] tracking-[0.2em] text-sub uppercase font-serif"
                        >FONT</span
                      >
                      <span
                        class="text-[9px] text-gray-300 group-hover/font:text-black transition-colors"
                        >â†“</span
                      >
                    </div>
                    <h3
                      class="text-xs font-medium text-black truncate font-sans"
                    >
                      {{ item.content || 'æœªå‘½åå­—ä½“' }}
                    </h3>

                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans">
                        {{ formatDate(item.created_at) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </main>

        <!-- æ‚¬æµ®ä¸Šä¼ æŒ‰é’® -->
        <button
          @click="showUpload = true"
          class="fixed right-10 w-12 h-12 bg-black text-white flex items-center justify-center hover:scale-105 transition-transform duration-300 z-30 shadow-xl rounded-full safe-bottom"
        >
          <span class="text-xl font-light pb-1">+</span>
        </button>

        <!-- ç¯ç®± (Lightbox) -->
        <div
          v-if="lightboxImage"
          class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center animate-fade-in fullscreen-layer"
          @click="closeLightbox"
        >
          <div
            class="absolute top-6 right-6 text-white/50 hover:text-white cursor-pointer p-4 text-sm tracking-widest"
            style="margin-top: env(safe-area-inset-top)"
          >
            CLOSE &times;
          </div>
          <img
            :src="lightboxImage"
            @load="$event.target.classList.add('img-loaded')"
            class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl select-none transition-transform img-loading"
            @click.stop
          />
        </div>

        <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
        <div
          v-if="showExport"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="closeExport"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-5xl shadow-2xl relative z-10 animate-slide-up flex flex-col md:flex-row max-h-[90vh] overflow-hidden border border-gray-100"
          >
            <div
              class="flex-1 bg-[#F5F5F5] p-4 md:p-10 flex items-center justify-center overflow-hidden"
            >
              <div
                class="relative shadow-xl"
                style="max-height: 100%; max-width: 100%"
              >
                <canvas
                  ref="quoteCanvas"
                  class="block w-auto h-auto max-w-full max-h-[60vh] md:max-h-[80vh] object-contain"
                ></canvas>
              </div>
            </div>
            <div
              class="w-full md:w-80 bg-white border-l border-gray-100 flex flex-col shrink-0"
            >
              <div
                class="p-6 border-b border-gray-50 flex justify-between items-center"
              >
                <span class="text-xs font-bold tracking-widest">ä¹¦æ‘˜åˆ¶ä½œ</span>
                <button
                  @click="closeExport"
                  class="text-lg hover:text-red-500 transition-colors"
                >
                  &times;
                </button>
              </div>
              <div class="p-6 flex-1 overflow-y-auto space-y-8">
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    é€‰æ‹©é£æ ¼
                  </p>
                  <div class="grid grid-cols-4 gap-4">
                    <button
                      v-for="(s, k) in styles"
                      :key="k"
                      @click="changeExportStyle(k)"
                      class="style-btn w-10 h-10 rounded-full border border-gray-200 shadow-sm"
                      :class="{active: exportStyle === k}"
                      :style="{background: s.btnColor}"
                      :title="s.name"
                    ></button>
                  </div>
                  <p class="text-center text-xs font-serif mt-3 text-gray-500">
                    {{ styles[exportStyle].name }}
                  </p>
                </div>
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-4 uppercase"
                  >
                    æ“ä½œ
                  </p>
                  <div class="space-y-3">
                    <button
                      @click="downloadAsImage"
                      class="w-full py-3 bg-black text-white text-[10px] tracking-[0.2em] hover:bg-gray-800 transition-colors"
                    >
                      ä¿å­˜å›¾ç‰‡
                    </button>
                    <button
                      @click="downloadAsText"
                      class="w-full py-3 border border-gray-200 text-black text-[10px] tracking-[0.2em] hover:bg-gray-50 transition-colors"
                    >
                      ä»…å¤åˆ¶æ–‡æœ¬
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ä¸Šä¼ /ç¼–è¾‘ æ¨¡æ€æ¡† -->
        <div
          v-if="showUpload"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="showUpload = false; editingId = null;"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-md shadow-2xl border border-gray-100 relative z-10 animate-slide-up flex flex-col max-h-[90vh]"
          >
            <div
              class="px-8 py-6 border-b border-gray-50 flex justify-between items-center"
            >
              <span class="text-[10px] tracking-[0.2em] font-bold uppercase"
                >{{ editingId ? 'ç¼–è¾‘å†…å®¹' : 'å…¥åº“' }}</span
              >
              <button
                @click="showUpload = false; editingId = null;"
                class="text-lg text-gray-300 hover:text-black"
              >
                &times;
              </button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto">
              <div
                class="flex gap-6 border-b border-gray-100 pb-px overflow-x-auto no-scroll"
              >
                <button
                  v-for="(label, key) in uploadTypes"
                  :key="key"
                  @click="!editingId && (uploadForm.type = key)"
                  class="text-[10px] tracking-widest pb-3 transition-all relative shrink-0"
                  :class="[
                    uploadForm.type === key ? 'text-black' : 'text-gray-400',
                    editingId ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-600'
                  ]"
                >
                  {{ label }}<span
                    v-if="uploadForm.type === key"
                    class="absolute bottom-0 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </div>

              <div class="space-y-4">
                <input
                  v-model="uploadForm.category"
                  type="text"
                  placeholder="æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />

                <!-- é€šç”¨æ ‡é¢˜/é“¾æ¥è¾“å…¥ -->
                <input
                  v-if="uploadForm.type !== 'text'"
                  v-model="uploadForm.title"
                  type="text"
                  :placeholder="uploadForm.type === 'beautify' ? 'ç¾åŒ–ä¸»é¢˜åç§° (å¦‚: iOSå›¾æ ‡åŒ…)' : 'æ ‡é¢˜ (å¯é€‰)'"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <input
                  v-if="uploadForm.type === 'link'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="é“¾æ¥åœ°å€ (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>
              <!-- === æ–°å¢ï¼šç±»å‹ï¼šå­—ä½“ === -->
              <div v-if="uploadForm.type === 'font'" class="space-y-4 pt-2">
                <!-- å­—ä½“åç§°è¾“å…¥ -->
                <input
                  v-model="uploadForm.content"
                  type="text"
                  placeholder="å­—ä½“åç§° (ç”¨äºé¢„è§ˆæ˜¾ç¤º)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />

                <!-- æ¥æºé€‰æ‹©å¼€å…³ -->
                <div class="flex gap-4 border-b border-gray-100 pb-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="radio"
                      v-model="uploadForm.fontSourceType"
                      value="file"
                      class="accent-black"
                    />
                    <span class="text-[10px] text-sub">ä¸Šä¼ æ–‡ä»¶</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="radio"
                      v-model="uploadForm.fontSourceType"
                      value="url"
                      class="accent-black"
                    />
                    <span class="text-[10px] text-sub">å¤–éƒ¨é“¾æ¥</span>
                  </label>
                </div>

                <!-- é€‰é¡¹A: ä¸Šä¼ æ–‡ä»¶ -->
                <div
                  v-if="uploadForm.fontSourceType === 'file' && !editingId"
                  class="border border-dashed border-gray-200 h-24 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
                >
                  <input
                    type="file"
                    @change="handleFileSelect"
                    accept=".ttf,.otf,.woff,.woff2"
                    class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  />
                  <span
                    class="text-xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                    >+</span
                  >
                  <span
                    class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >
                    {{ uploadForm.files.length > 0 ? uploadForm.files[0].name :
                    'é€‰æ‹©å­—ä½“æ–‡ä»¶ (.ttf/.otf/woff)' }}
                  </span>
                </div>

                <!-- é€‰é¡¹B: URL è¾“å…¥ -->
                <input
                  v-if="uploadForm.fontSourceType === 'url'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="å­—ä½“æ–‡ä»¶ç›´é“¾ (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>

              <!-- ç±»å‹ï¼šå›¾ç‰‡ -->
              <div v-if="uploadForm.type === 'image'" class="pt-2">
                <label
                  class="flex items-center gap-2 cursor-pointer select-none"
                >
                  <input
                    type="checkbox"
                    v-model="uploadForm.useAlbum"
                    class="accent-black w-3 h-3"
                  />
                  <span class="text-[10px] tracking-widest text-gray-500"
                    >å½’æ¡£è‡³ç›¸å†Œ</span
                  >
                </label>
                <input
                  v-if="uploadForm.useAlbum"
                  v-model="uploadForm.albumName"
                  list="albums"
                  placeholder="è¾“å…¥ç›¸å†Œåç§°..."
                  class="mt-3 w-full border-b border-gray-200 py-2 text-xs focus:border-black outline-none bg-transparent"
                />
                <datalist id="albums">
                  <option
                    v-for="a in albumList"
                    :value="a.displayName"
                    :key="a.realName"
                  ></option>
                </datalist>
              </div>

              <!-- ç±»å‹ï¼šæ–‡å­— -->
              <textarea
                v-if="uploadForm.type === 'text'"
                v-model="uploadForm.content"
                rows="5"
                placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—å†…å®¹..."
                class="w-full bg-gray-50 p-4 text-sm font-serif leading-relaxed focus:outline-none focus:bg-white focus:ring-1 focus:ring-black resize-none"
              ></textarea>

              <!-- ç±»å‹ï¼šå›¾ç‰‡/HTML/Chat çš„æ–‡ä»¶ä¸Šä¼  -->
              <div
                v-if="!editingId && (uploadForm.type === 'image' || uploadForm.type === 'html' || uploadForm.type === 'chat')"
                class="border border-dashed border-gray-200 h-28 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
              >
                <input
                  type="file"
                  @change="handleFileSelect"
                  multiple
                  class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  :accept="uploadForm.type === 'image' ? 'image/*' : (uploadForm.type === 'html' ? '.html,.htm' : '*/*')"
                />
                <span
                  class="text-2xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                  >+</span
                >
                <span
                  class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >{{ fileStatusText }}</span
                >
              </div>

              <!-- ç±»å‹ï¼šç¾åŒ– (Beautify) çš„ç‰¹æ®Šä¸Šä¼ ç•Œé¢ -->
              <div v-if="uploadForm.type === 'beautify'" class="space-y-6">
                <!-- æ–°å¢ï¼šç¾åŒ–åŒ…ä¸“ç”¨å¯¼å…¥åŒºåŸŸ -->
                <div
                  class="border-2 border-dashed border-blue-100 bg-blue-50/50 hover:bg-blue-50 hover:border-blue-300 transition-all rounded-lg p-6 flex flex-col items-center justify-center relative cursor-pointer group"
                >
                  <input
                    type="file"
                    accept=".zip"
                    @change="handleBeautifyZipImport"
                    class="absolute inset-0 opacity-0 cursor-pointer z-10"
                  />
                  <div
                    class="text-blue-500 mb-2 group-hover:scale-110 transition-transform"
                  >
                    <!-- å›¾æ ‡ -->
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="7 10 12 15 17 10" />
                      <line x1="12" y1="15" x2="12" y2="3" />
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                    </svg>
                  </div>
                  <span
                    class="text-[10px] font-bold tracking-widest text-blue-600 uppercase"
                    >å¯¼å…¥ç¾åŒ–èµ„æºåŒ… (.ZIP)</span
                  >
                  <span class="text-[9px] text-blue-400 mt-1"
                    >è‡ªåŠ¨è¯†åˆ«é…è‰²ã€é¢„è§ˆå›¾å’Œæºæ–‡ä»¶</span
                  >
                </div>
                <div
                  v-for="(item, index) in uploadForm.beautifyVariations"
                  :key="index"
                  class="bg-gray-50 p-4 relative border border-gray-200"
                >
                  <button
                    v-if="uploadForm.beautifyVariations.length > 1"
                    @click="removeBeautifyItem(index)"
                    class="absolute top-2 right-2 text-gray-400 hover:text-red-500"
                    title="åˆ é™¤æ­¤æ–¹æ¡ˆ"
                  >
                    &times;
                  </button>
                  <div class="space-y-3">
                    <div class="flex gap-2 items-center">
                      <!-- é¢œè‰²é€‰æ‹©å™¨ -->
                      <input
                        type="color"
                        v-model="item.colorValue"
                        class="h-8 w-8 p-0 border-0 bg-transparent cursor-pointer shrink-0 rounded overflow-hidden"
                        title="ç‚¹å‡»é€‰æ‹©é¢œè‰²"
                      />
                      <!-- é¢œè‰²ä»£ç è¾“å…¥æ¡† -->
                      <input
                        type="text"
                        v-model="item.colorValue"
                        placeholder="#000000"
                        class="flex-1 bg-white px-2 text-xs border border-gray-200 focus:border-black outline-none h-8 font-mono uppercase tracking-widest"
                      />
                    </div>

                    <!-- é¢„è§ˆå›¾ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >é¢„è§ˆå›¾</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰é¢„è§ˆå›¾ -->
                      <div
                        v-if="item.previewUrl && !item.previewFile"
                        class="mb-2 flex items-center gap-2"
                      >
                        <img
                          :src="item.previewUrl"
                          class="w-10 h-10 object-cover rounded border border-gray-200"
                        />
                        <span class="text-[9px] text-gray-400">å½“å‰é¢„è§ˆå›¾</span>
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.previewFile = e.target.files[0]"
                        accept="image/*"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.previewFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°å›¾: {{ item.previewFile.name }}</span
                      >
                    </div>

                    <!-- çœŸå®æ–‡ä»¶ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >çœŸå®æ–‡ä»¶ (ä¸‹è½½ç”¨)</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰æ–‡ä»¶çŠ¶æ€ -->
                      <div
                        v-if="item.realUrl && !item.realFile"
                        class="mb-1 text-[9px] text-blue-500"
                      >
                        âœ“ å·²åŒ…å«æ–‡ä»¶ (æ— éœ€é‡æ–°ä¸Šä¼ ï¼Œé™¤éè¦æ›¿æ¢)
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.realFile = e.target.files[0]"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.realFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°æ–‡ä»¶: {{ item.realFile.name }}</span
                      >
                    </div>
                  </div>
                </div>
                <button
                  @click="addBeautifyItem"
                  class="w-full py-2 border border-dashed border-gray-300 text-gray-400 text-[10px] hover:border-black hover:text-black transition-colors"
                >
                  + æ·»åŠ å¦ä¸€ç§é¢œè‰²æ–¹æ¡ˆ
                </button>
              </div>
            </div>
            <button
              @click="submitUpload"
              :disabled="uploading"
              class="w-full py-5 bg-black text-white text-[10px] tracking-[0.3em] hover:bg-gray-800 disabled:bg-gray-300 transition-colors"
            >
              {{ uploading ? 'å¤„ç†ä¸­...' : (editingId ? 'ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤å…¥åº“')
              }}
            </button>
          </div>
        </div>
        <!-- ä¸»é¢˜åˆ‡æ¢ æ¨¡æ€æ¡† -->
        <div
          v-if="showThemeModal"
          class="fixed inset-0 z-[100] flex items-center justify-center p-8 fullscreen-layer"
        >
          <div
            @click="showThemeModal = false"
            class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-all"
          ></div>
          <div
            class="bg-panel w-full max-w-sm shadow-2xl border border-border relative z-10 animate-slide-up p-8 flex flex-col gap-6"
            :class="{'border-2 border-black': currentTheme === 'pixel'}"
          >
            <div
              class="flex justify-between items-center border-b border-border pb-4"
            >
              <span
                class="text-xs tracking-[0.2em] font-bold uppercase text-black"
                >THEME GALLERY</span
              >
              <button
                @click="showThemeModal = false"
                class="text-lg hover:text-accent"
              >
                &times;
              </button>
            </div>

            <div class="grid grid-cols-1 gap-4">
              <button
                v-for="t in themeOptions"
                :key="t.key"
                @click="setTheme(t.key)"
                class="flex items-center gap-4 p-3 border border-transparent hover:border-border transition-all group"
                :class="{'bg-gray-50 border-border': currentTheme === t.key}"
              >
                <!-- é¢„è§ˆåœ†ç‚¹ -->
                <div
                  class="w-8 h-8 rounded-full shadow-inner border border-black/5"
                  :style="t.previewStyle"
                ></div>
                <div class="text-left">
                  <div
                    class="text-xs font-bold text-black uppercase tracking-wider"
                  >
                    {{ t.name }}
                  </div>
                  <div class="text-[9px] text-sub">{{ t.desc }}</div>
                </div>
                <div
                  v-if="currentTheme === t.key"
                  class="ml-auto text-black text-xs"
                >
                  â—
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- iOS å®‰è£…å¼•å¯¼å¼¹çª— -->
        <div id="ios-install-guide" class="ios-install-guide">
          <div class="flex items-start gap-4">
            <div class="bg-gray-100 p-2 rounded-lg shrink-0">
              <img
                src="https://images.unsplash.com/photo-1599305445671-ac291c95aaa9?w=192&h=192&fit=crop"
                class="w-10 h-10 rounded-md"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-black mb-1">æ·»åŠ åˆ°ä¸»å±å¹•</h3>
              <p class="text-xs text-gray-500 leading-relaxed">
                ä¸ºäº†è·å¾—æ›´å¥½çš„å…¨å±ä½“éªŒï¼Œè¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„
                <span class="font-bold text-blue-600">åˆ†äº«æŒ‰é’®</span>ï¼Œç„¶åé€‰æ‹©
                <span class="font-bold text-black">â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span>ã€‚
              </p>
            </div>
            <button
              onclick="
                document
                  .getElementById('ios-install-guide')
                  .classList.remove('show')
              "
              class="text-gray-400 hover:text-black"
            >
              &times;
            </button>
          </div>
          <div class="ios-install-arrow"></div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const config = ref({
            url: "https://plcasoipxkrudvfzncod.supabase.co",
            key: "",
          });
          const auth = ref({ email: "", password: "" });
          const session = ref(null);
          const items = ref([]);
          const showThemeModal = ref(false);
          const currentTheme = ref("default");

          const themeOptions = [
            {
              key: "default",
              name: "Original",
              desc: "æç®€ç´ ç™½ / ç»å…¸é£æ ¼",
              previewStyle: "background: #FCFCFC; border: 1px solid #eee",
            },
            {
              key: "midnight",
              name: "Midnight",
              desc: "å¤œèˆª / æ²‰æµ¸æš—è‰² / é«˜çº§æ„Ÿ",
              previewStyle: "background: #09090b",
            },
            {
              key: "sakura",
              name: "Sakura",
              desc: "è½æ¨± / è½¯èŒç²‰è‰² / å°‘å¥³å¿ƒ",
              previewStyle: "background: #fff0f3; border: 1px solid #ffdae2",
            },
            {
              key: "cyan",
              name: "Cyan",
              desc: "é’é»› / å›½é£é›…éŸµ / é™¶ç“·è´¨æ„Ÿ",
              previewStyle: "background: #f2f5f4; border: 1px solid #dae3e1",
            },
            {
              key: "paper",
              name: "Paper",
              desc: "ç¾Šçš®å· / æ¸©æš–é˜…è¯» / å¤å¤",
              previewStyle: "background: #f7f3e8",
            },
            {
              key: "lavender",
              name: "Lavender",
              desc: "è¿·å¹»ç´« / æ¢¦å¢ƒæ°›å›´",
              previewStyle:
                "background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            },
            {
              key: "morandi",
              name: "Morandi",
              desc: "è«å…°è¿ª / ç°ç»¿å†·æ·¡é£",
              previewStyle: "background: #E0E5DF",
            },
            {
              key: "magazine",
              name: "Magazine",
              desc: "Vogue / æ‚å¿—æ’ç‰ˆ / è¡¬çº¿ä½“",
              previewStyle: "background: #f2f2f2; border: 1px solid #000;",
            },
            {
              key: "cream",
              name: "Cream Puff",
              desc: "å¥¶æ²¹æ³¡èŠ™ / è½¯èŒ / æ²»æ„ˆç³»",
              previewStyle: "background: #fffbf0; border: 2px solid #fff;",
            },
            {
              key: "midnight",
              name: "Midnight",
              desc: "æ·±æµ· / é«˜çº§æš—è‰² / æ²‰æµ¸",
              previewStyle: "background: #0f172a",
            },
            {
              key: "pixel",
              name: "8-Bit",
              desc: "åƒç´ é£ / è¡—æœºæ¸¸æˆ",
              previewStyle:
                "background: #d0d0d0; background-image: radial-gradient(#000 1px, transparent 1px); background-size: 4px 4px;",
            },
          ];

          const filter = ref("all");
          const currentAlbum = ref(null);
          const currentTag = ref(null);
          const showUpload = ref(false);
          const lightboxImage = ref(null);
          const showExport = ref(false);
          const exportItem = ref(null);
          const exportStyle = ref("classic");
          const quoteCanvas = ref(null);
          const loading = ref(false);
          const uploading = ref(false);
          const errorMsg = ref("");
          const editingId = ref(null);

          // ç¾åŒ–ç›¸å…³çš„çŠ¶æ€ç®¡ç†ï¼šå­˜å‚¨æ¯ä¸ªå¡ç‰‡å½“å‰é€‰ä¸­çš„é¢œè‰²ç´¢å¼• { itemId: index }
          const beautifyStates = ref({});

          const showInstallBtn = ref(false);
          const deferredPrompt = ref(null);
          const isIOS =
            /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          const isStandalone =
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true;

          onMounted(() => {
            // const u = localStorage.getItem("sb_url"); // æ³¨é‡Šæ‰è¿™è¡Œï¼šä¸è¯»å–ç¼“å­˜çš„ URL
            const k = localStorage.getItem("sb_key");
            const savedEmail = localStorage.getItem("sb_email");
            const savedPass = localStorage.getItem("sb_pass");
            if (savedEmail) auth.value.email = savedEmail;
            if (savedPass) auth.value.password = savedPass;
            // -------------------------------
            const savedTheme = localStorage.getItem("museum_theme");
            if (savedTheme) {
              setTheme(savedTheme);
            }
            // ä¿®æ”¹åˆ¤æ–­é€»è¾‘ï¼šåªè¦æœ‰ Key å°±ç›´æ¥ç™»å½•ï¼ˆå› ä¸º URL å·²ç»æ˜¯å›ºå®šçš„äº†ï¼‰
            if (config.value.url && k) {
              // config.value.url = u; // æ³¨é‡Šæ‰è¿™è¡Œï¼šä¸è¦è¦†ç›– URL
              config.value.key = k;
              initSupabase();
            }
            if (!isStandalone) {
              if (isIOS) {
                showInstallBtn.value = true;
              } else {
                window.addEventListener("beforeinstallprompt", (e) => {
                  e.preventDefault();
                  deferredPrompt.value = e;
                  showInstallBtn.value = true;
                });
              }
            }
          });

          const triggerInstall = () => {
            if (isIOS) {
              document
                .getElementById("ios-install-guide")
                .classList.add("show");
            } else {
              if (deferredPrompt.value) {
                deferredPrompt.value.prompt();
                deferredPrompt.value.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === "accepted")
                    showInstallBtn.value = false;
                  deferredPrompt.value = null;
                });
              }
            }
          };

          // ... åŸæœ‰ä»£ç  ...
          const filterMap = {
            all: "å…¨éƒ¨",
            text: "æ–‡å­—",
            image: "å½±åƒ",
            albums: "ç›¸å†Œ",
            font: "å­—ä½“", // <--- æ–°å¢è¿™é‡Œ
            beautify: "ç¾åŒ–",
            html: "ç½‘é¡µ",
            link: "é“¾æ¥",
            chat: "èŠå¤©",
          };
          const uploadTypes = {
            text: "æ–‡å­—",
            image: "å›¾ç‰‡",
            font: "å­—ä½“", // <--- æ–°å¢è¿™é‡Œ
            beautify: "ç¾åŒ–",
            html: "æ–‡ä»¶",
            link: "é“¾æ¥",
            chat: "èŠå¤©",
          };
          const uploadForm = ref({
            type: "text",
            category: "",
            title: "",
            url: "",
            content: "",
            files: [],
            useAlbum: false,
            albumName: "",
            fontSourceType: "file",
            // ç¾åŒ–ä¸“ç”¨æ•°æ®ç»“æ„
            beautifyVariations: [
              {
                colorName: "é»˜è®¤",
                colorValue: "#000000",
                previewFile: null,
                realFile: null,
                previewUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
                realUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
              },
            ],
          });
          const styles = {
            classic: {
              name: "ç´ ç™½",
              btnColor: "#fff",
              bg: "#ffffff",
              text: "#111",
              sub: "#999",
              font: "serif",
            },
            dark: {
              name: "å¤œèˆª",
              btnColor: "#1a1a1a",
              bg: "#121212",
              text: "#e0e0e0",
              sub: "#666",
              font: "serif",
            },
            cream: {
              name: "ç¾Šçš®",
              btnColor: "#f5f2e9",
              bg: "#f5f2e9",
              text: "#2c2c2c",
              sub: "#8b8b80",
              font: "serif",
            },
            ink: {
              name: "æ°´å¢¨",
              btnColor: "#e6e6e6",
              bg: "#e8e8e8",
              text: "#000",
              sub: "#555",
              font: "serif",
              border: true,
            },
            film: {
              name: "èƒ¶ç‰‡",
              btnColor: "#000",
              bg: "#000",
              text: "#ffc107",
              sub: "#888",
              font: "sans",
              letter: true,
            },
            red: {
              name: "èµ¤çº¢",
              btnColor: "#8B0000",
              bg: "#fff",
              text: "#8B0000",
              sub: "#D98880",
              font: "serif",
              borderRed: true,
            },
            // ... (ä¿ç•™ classic, dark, cream, ink, film, red) ...

            // --- æ›¿æ¢ä¸ºæ–°çš„è«å…°è¿ª/å¯çˆ±é£æ ¼ ---
            pixel: {
              name: "æµ®å…‰", // æ¢¦å¹» OS é£æ ¼
              btnColor: "#F4D0D2", // è«å…°è¿ªç²‰
              bg: "#F9F3F3", // èƒŒæ™¯ææ·¡ç²‰
              text: "#5E5050", // æš–ç°å­—
              sub: "#9E8E8E",
              font: "sans", // æ— è¡¬çº¿å­—ä½“æ›´ç°ä»£
              type: "dream_os",
            },
            game: {
              name: "ç©ä¼´", // åŠ¨æ£®ç»¿æŒæœºé£æ ¼
              btnColor: "#B5C9C3", // è«å…°è¿ªè±†æ²™ç»¿
              bg: "#B5C9C3",
              text: "#465D58", // æ·±ç»¿ç°å­—
              sub: "#7A918D",
              font: "sans",
              type: "cute_console",
            },
            terminal: {
              name: "ç¦…æ„", // é«˜çº§ç¼–è¾‘å™¨é£æ ¼
              btnColor: "#2E3440", // Nord æ·±è“ç°
              bg: "#2E3440",
              text: "#D8DEE9", // æŸ”å’Œç™½
              sub: "#5C677D", // æ³¨é‡Šç°
              font: "mono",
              type: "zen_editor",
            },
            // ... (ä¿ç•™ä¹‹å‰çš„æ ·å¼) ...

            // --- æ–°å¢ï¼šæƒ…ç»ªç³»è®¾è®¡ ---
            receipt: {
              name: "å­˜æ ¹", // è¶…å¸‚å°ç¥¨é£æ ¼
              btnColor: "#fff",
              bg: "#eee", // èƒŒæ™¯æ·±ä¸€ç‚¹ï¼Œä¸ºäº†å‡¸æ˜¾ç™½è‰²å°ç¥¨
              text: "#222",
              sub: "#666",
              font: "mono", // ç­‰å®½å­—ä½“æ›´æœ‰å°ç¥¨æ„Ÿ
              type: "receipt",
            },
            letter: {
              name: "ä¿¡ç¬º", // ä¸­å¼ä¿¡çº¸
              btnColor: "#fdfbf7", // æš–ç±³è‰²
              bg: "#fdfbf7",
              text: "#333",
              sub: "#8c4e4e", // ä¹Ÿæ˜¯çº¢æ£•è‰²
              font: "serif",
              type: "letter",
            },
            diffusion: {
              name: "å¼¥æ•£", // æµä½“æ¸å˜
              btnColor: "#cba6f7", // ç´«è‰²ç¤ºæ„
              bg: "#1e1e2e", // è¿™é‡ŒèƒŒæ™¯è‰²ä¸é‡è¦ï¼Œä¼šè¢«æ¸å˜è¦†ç›–
              text: "#fff",
              sub: "rgba(255,255,255,0.7)",
              font: "sans",
              type: "diffusion",
            },
          };

          let supabase = null;

          // æ‰¾åˆ°åŸæœ‰çš„ formatDate å‡½æ•°ï¼Œæ›¿æ¢ä¸ºï¼š
          const formatDate = (str) => {
            if (!str) return "";
            const d = new Date(str);
            const pad = (n) => String(n).padStart(2, "0");
            // è¿”å›æ ¼å¼ï¼šYYYY.MM.DD HH:mm
            return `${d.getFullYear()}.${pad(d.getMonth() + 1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
          };

          const getRealContent = (item) => {
            if (item.type === "beautify") return null; // ç¾åŒ–ç±»å‹å•ç‹¬å¤„ç†
            if (!item.content) return null;
            if (item.content.startsWith("hidden:")) return null;
            // å¦‚æœæ˜¯ç¾åŒ–ç±»å‹JSONï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰ï¼Œä¸ç›´æ¥æ˜¾ç¤º
            if (item.content.trim().startsWith("{") && item.type === "beautify")
              return null;
            return item.content;
          };

          const getTags = (item) => {
            if (!item.category) return ["æœªåˆ†ç±»"];
            return item.category
              .replace(/ï¼Œ/g, ",")
              .split(/[, \s]+/)
              .filter((t) => t && t.trim().length > 0);
          };

          const fileStatusText = computed(() =>
            uploadForm.value.files.length === 0
              ? "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶"
              : `å·²é€‰ ${uploadForm.value.files.length} ä¸ªæ–‡ä»¶`,
          );

          const albumList = computed(() => {
            const albums = {};
            items.value.forEach((item) => {
              if (item.type === "image" && item.album_name) {
                if (!albums[item.album_name])
                  albums[item.album_name] = {
                    realName: item.album_name,
                    displayName: item.album_name.startsWith(".")
                      ? item.album_name.substring(1)
                      : item.album_name,
                    isHidden: item.album_name.startsWith("."),
                    count: 0,
                    cover: item.file_url,
                  };
                albums[item.album_name].count++;
              }
            });
            return Object.values(albums);
          });

          const filteredItems = computed(() => {
            if (currentAlbum.value)
              return items.value.filter(
                (i) => i.album_name === currentAlbum.value,
              );
            if (currentTag.value)
              return items.value.filter((i) =>
                getTags(i).includes(currentTag.value),
              );
            if (filter.value === "all") return items.value;
            if (filter.value === "albums") return [];
            if (filter.value === "image") {
              return items.value.filter((i) => {
                if (i.type !== "image") return false;
                if (!i.album_name) return true;
                return !i.album_name.startsWith(".");
              });
            }
            return items.value.filter((i) => i.type === filter.value);
          });

          const initSupabase = async () => {
            try {
              if (!config.value.url) return;

              // ä»ç¼“å­˜å– Key
              let k = config.value.key;

              // åŒæ ·è¿›è¡Œæ¸…æ´—
              if (k) {
                k = k.replace(/[^\x20-\x7E]/g, "").trim();
              }

              // å¦‚æœ Key åŒ…å«éæ³•å­—ç¬¦æˆ–è€…æ˜¯ç©ºçš„ï¼Œå°±ä¸è¦åˆå§‹åŒ–äº†ï¼Œç­‰ç”¨æˆ·æ‰‹åŠ¨ç‚¹ç™»å½•
              if (!k || k.length < 20) return;

              supabase = window.supabase.createClient(
                config.value.url.trim(),
                k,
              );
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                session.value = data.session;
                fetchData();
              }
            } catch (e) {
              // åˆå§‹åŒ–å¤±è´¥ä¸å¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•ï¼Œé¿å…å“åˆ°ç”¨æˆ·
              console.log("è‡ªåŠ¨ç™»å½•æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç™»å½•", e);
            }
          };

          const handleLogin = async () => {
            loading.value = true;
            errorMsg.value = "";
            try {
              const u = config.value.url.trim();

              // === ä¿®å¤æ ¸å¿ƒï¼šæš´åŠ›æ¸…æ´— Key ===
              // 1. è·å–è¾“å…¥æ¡†çš„å€¼
              let rawKey = config.value.key;

              // 2. æ­£åˆ™æ›¿æ¢ï¼šåªä¿ç•™ ASCII å¯æ‰“å°å­—ç¬¦ (å»æ‰ä¸­æ–‡ã€æ¢è¡Œã€çœ‹ä¸è§çš„ç‰¹æ®Šç©ºæ ¼)
              const k = rawKey.replace(/[^\x20-\x7E]/g, "").trim();

              if (!k) throw new Error("Key ä¸èƒ½ä¸ºç©º");

              // 3. æ›´æ–°å›è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¸…æ´—åçš„ç»“æœ
              config.value.key = k;

              // 4. å­˜å…¥ç¼“å­˜
              localStorage.setItem("sb_url", u);
              localStorage.setItem("sb_key", k);
              localStorage.setItem("sb_email", auth.value.email.trim());
              localStorage.setItem("sb_pass", auth.value.password.trim());
              // === ä¿®å¤æ ¸å¿ƒï¼šå¼ºåˆ¶é‡å»ºå®¢æˆ·ç«¯ ===
              // ä¸è¦åˆ¤æ–­ if (!supabase)ï¼Œç›´æ¥è¦†ç›–ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ Key
              supabase = window.supabase.createClient(u, k);

              const { data, error } = await supabase.auth.signInWithPassword({
                email: auth.value.email.trim(),
                password: auth.value.password.trim(),
              });
              if (error) throw error;
              session.value = data.session;
              fetchData();
            } catch (e) {
              console.error(e);
              errorMsg.value = "ç™»å½•å¤±è´¥: " + e.message;
              supabase = null; // å‡ºé”™åç½®ç©ºï¼Œä¸‹æ¬¡å¼ºåˆ¶é‡å»º
            } finally {
              loading.value = false;
            }
          };

          const handleLogout = async () => {
            if (supabase) await supabase.auth.signOut();
            session.value = null;
            items.value = [];
          };

          // ... ä¿®æ”¹ fetchData å‡½æ•°ï¼Œåœ¨è·å–æ•°æ®åè°ƒç”¨ä¸Šé¢è¿™ä¸ªå‡½æ•° ...
          const fetchData = async () => {
            if (!supabase) return;
            loading.value = true;
            const { data } = await supabase
              .from("fragments")
              .select("*")
              .order("created_at", { ascending: false });
            items.value = data || [];

            nextTick(() => {
              loadFontsFromItems();
            });

            loading.value = false;
          };

          // === æ–°å¢ï¼šåŠ¨æ€åŠ è½½å­—ä½“å‡½æ•° ===
          const loadFontsFromItems = () => {
            items.value.forEach((item) => {
              if (item.type === "font" && item.file_url) {
                const fontName = `font_${item.id}`; // ä½¿ç”¨ ID ç”Ÿæˆå”¯ä¸€çš„å­—ä½“æ—åç§°
                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œé¿å…é‡å¤åŠ è½½
                const isLoaded = Array.from(document.fonts).some(
                  (f) => f.family === fontName,
                );
                if (!isLoaded) {
                  const font = new FontFace(fontName, `url(${item.file_url})`);
                  font
                    .load()
                    .then((loadedFace) => {
                      document.fonts.add(loadedFace);
                    })
                    .catch((err) => {
                      console.error(`å­—ä½“åŠ è½½å¤±è´¥: ${item.content}`, err);
                    });
                }
              }
            });
          };

          // ç¾åŒ–æ¨¡å—è¾…åŠ©å‡½æ•°
          const getBeautifyData = (item) => {
            if (!item.content) return { title: "æ•°æ®å¼‚å¸¸", variations: [] };
            try {
              const data = JSON.parse(item.content);
              return data || { title: "æ— æ ‡é¢˜", variations: [] };
            } catch (e) {
              return { title: "è§£æé”™è¯¯", variations: [] };
            }
          };

          const getBeautifyIndex = (id) => {
            return beautifyStates.value[id] || 0;
          };
          const setTheme = (themeKey) => {
            currentTheme.value = themeKey;
            document.body.setAttribute("data-theme", themeKey);
            localStorage.setItem("museum_theme", themeKey);
            // åƒç´ é£éœ€è¦è§¦å‘ä¸€æ¬¡é‡ç»˜æˆ–ç‰¹å®šå¤„ç†ï¼ˆå¯é€‰ï¼‰
          };

          const setBeautifyIndex = (id, idx) => {
            beautifyStates.value[id] = idx;
          };

          const getBeautifyPreview = (item) => {
            const data = getBeautifyData(item);
            const idx = getBeautifyIndex(item.id);
            if (data.variations && data.variations[idx]) {
              return data.variations[idx].preview;
            }
            return item.file_url; // é™çº§
          };

          const addBeautifyItem = () => {
            uploadForm.value.beautifyVariations.push({
              colorName: "",
              colorValue: "#000000",
              previewFile: null,
              realFile: null,
              previewUrl: null,
              realUrl: null,
            });
          };

          const removeBeautifyItem = (index) => {
            uploadForm.value.beautifyVariations.splice(index, 1);
          };

          const changeExportStyle = (s) => {
            exportStyle.value = s;
            drawCard();
          };
          // --- æ–°å¢ï¼šå¤„ç†ç¾åŒ–åŒ…å¯¼å…¥ ---
          const handleBeautifyZipImport = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // ç®€å•çš„åŠ è½½åŠ¨ç”»æˆ–æç¤º
            const originalText = e.target.nextElementSibling?.innerText; // è·å–ä¸åˆ°DOMä¹Ÿæ²¡å…³ç³»ï¼Œè¿™è¡Œåªæ˜¯ä¸ºäº†ä¸¥è°¨

            try {
              const zip = await JSZip.loadAsync(file);

              // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ¸…å•æ–‡ä»¶
              if (!zip.file("manifest.json")) {
                alert("æ— æ³•è¯†åˆ«ï¼šå‹ç¼©åŒ…å†…ç¼ºå°‘ manifest.json è¯´æ˜æ–‡ä»¶ã€‚");
                return;
              }

              const manifestStr = await zip
                .file("manifest.json")
                .async("string");
              const manifest = JSON.parse(manifestStr);

              // 2. è‡ªåŠ¨å¡«å…¥æ ‡é¢˜
              if (manifest.title) {
                uploadForm.value.title = manifest.title;
              }

              // 3. å‡†å¤‡å˜ä½“æ•°ç»„
              const newVariations = [];

              // 4. éå†è§£å‹æ–‡ä»¶
              if (manifest.variations && Array.isArray(manifest.variations)) {
                for (const v of manifest.variations) {
                  const variationItem = {
                    colorName: v.name || "é»˜è®¤", // å…¼å®¹æ—§ç‰ˆ
                    colorValue: v.color || "#000000",
                    previewFile: null,
                    realFile: null,
                    previewUrl: null,
                    realUrl: null,
                  };

                  // è¿˜åŸé¢„è§ˆå›¾ (Blob -> File)
                  if (v.previewFile && zip.file(v.previewFile)) {
                    const blob = await zip.file(v.previewFile).async("blob");
                    // å¿…é¡»åˆ›å»º File å¯¹è±¡ï¼Œè¿™æ ·æäº¤é€»è¾‘æ‰èƒ½è¯†åˆ«è¿™æ˜¯æ–°æ–‡ä»¶
                    variationItem.previewFile = new File(
                      [blob],
                      v.previewFile,
                      { type: blob.type },
                    );
                  }

                  // è¿˜åŸçœŸå®æ–‡ä»¶ (Blob -> File)
                  if (v.realFile && zip.file(v.realFile)) {
                    const blob = await zip.file(v.realFile).async("blob");
                    variationItem.realFile = new File([blob], v.realFile, {
                      type: blob.type,
                    });
                  }

                  newVariations.push(variationItem);
                }
              }

              // 5. æ›´æ–°è¡¨å•
              if (newVariations.length > 0) {
                uploadForm.value.beautifyVariations = newVariations;
                alert(
                  `æˆåŠŸå¯¼å…¥ "${manifest.title}"ï¼ŒåŒ…å« ${newVariations.length} ç§é…è‰²æ–¹æ¡ˆï¼`,
                );
              }
            } catch (err) {
              console.error(err);
              alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®");
            } finally {
              // æ¸…ç©º inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶
              e.target.value = "";
            }
          };

          const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
            const paragraphs = text.split("\n");
            let currentY = y;
            paragraphs.forEach((paragraph) => {
              const words = paragraph.split("");
              let line = "";
              for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                  ctx.fillText(line, x, currentY);
                  line = words[n];
                  currentY += lineHeight;
                } else {
                  line = testLine;
                }
              }
              ctx.fillText(line, x, currentY);
              currentY += lineHeight * 1.5;
            });
            return currentY;
          };
          // --- æ–°å¢ï¼šç”»åœ†è§’çŸ©å½¢çš„å·¥å…·å‡½æ•° ---
          const roundRect = (ctx, x, y, w, h, r) => {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
          };
          const drawCard = () => {
            const cvs = quoteCanvas.value;
            if (!cvs || !exportItem.value) return;
            const ctx = cvs.getContext("2d");
            const s = styles[exportStyle.value];
            const text = exportItem.value.content || "";
            const date = formatDate(exportItem.value.created_at);

            // === 1. åŸºç¡€é…ç½®ä¸å‚æ•°è®¡ç®— ===
            const W = 900;
            let paddingX = 80;
            let paddingTop = 80;
            let paddingBottom = 80;

            // é’ˆå¯¹ç‰¹å®šæ ·å¼çš„å‚æ•°è°ƒæ•´
            if (s.type === "dream_os") {
              paddingTop = 140;
              paddingX = 100;
            }
            if (s.type === "cute_console") {
              paddingTop = 140;
              paddingBottom = 160;
              paddingX = 120;
            }
            if (s.type === "zen_editor") {
              paddingTop = 120;
              paddingX = 100;
            }
            if (s.type === "receipt") {
              paddingX = 70;
              paddingTop = 120;
              paddingBottom = 160;
            }
            if (s.type === "letter") {
              paddingX = 100;
              paddingTop = 120;
            }
            // å¼¥æ•£é£æ ¼ä¸Šä¸‹ç•™ç™½ç¨å¾®å¤šä¸€ç‚¹ï¼Œæ›´æœ‰å‘¼å¸æ„Ÿ
            if (s.type === "diffusion") {
              paddingX = 90;
              paddingTop = 150;
              paddingBottom = 150;
            }

            const fontSize = 36;
            const lineHeight = 68;

            // è®¾ç½®å­—ä½“
            let fontName = '"Noto Serif SC"';
            if (s.font === "sans")
              fontName = '"Inter", "PingFang SC", sans-serif';
            if (s.font === "mono") fontName = '"Menlo", "Consolas", monospace';

            // è®¾ç½®å­—ä½“æ ·å¼
            ctx.font = `300 ${fontSize}px ${fontName}`;
            if (s.type === "zen_editor")
              ctx.font = `400 ${fontSize}px ${fontName}`;
            // å¼¥æ•£èƒŒæ™¯æ·±ï¼Œå­—ç¨å¾®ç²—ä¸€ç‚¹ç‚¹ä¿è¯æ¸…æ™°ï¼Œä½†ä¸è¦å¤ªç²—
            if (s.type === "diffusion")
              ctx.font = `400 ${fontSize}px ${fontName}`;
            if (s.type === "receipt") ctx.font = `400 32px ${fontName}`;

            // è®¡ç®—æ–‡æœ¬æ¢è¡Œå’Œé«˜åº¦
            const paragraphs = text.split("\n");
            let lineCount = 0;
            let textWidthLimit = W - paddingX * 2;
            if (s.type === "receipt") textWidthLimit = 560;

            paragraphs.forEach((p) => {
              let width = 0;
              lineCount++;
              for (let char of p) {
                width += ctx.measureText(char).width;
                if (width > textWidthLimit) {
                  lineCount++;
                  width = 0;
                }
              }
            });

            const textHeight =
              lineCount * lineHeight + paragraphs.length * (lineHeight * 0.4);
            let H = Math.max(textHeight + paddingTop + paddingBottom + 40, 600);
            if (s.type === "receipt")
              H = textHeight + paddingTop + paddingBottom + 100;

            // === 2. ç»˜åˆ¶èƒŒæ™¯ä¸å®¹å™¨ ===
            cvs.width = W;
            cvs.height = H;
            ctx.fillStyle = s.bg;
            ctx.fillRect(0, 0, W, H);

            // ------ A. ğŸŒ¸ æµ®å…‰ Dream OS ------
            if (s.type === "dream_os") {
              const winMargin = 40;
              const winW = W - winMargin * 2;
              const winH = H - winMargin * 2;

              ctx.shadowColor = "rgba(0,0,0,0.05)";
              ctx.shadowBlur = 30;
              ctx.shadowOffsetY = 15;
              ctx.fillStyle = "#ffffff";
              roundRect(ctx, winMargin, winMargin, winW, winH, 24);
              ctx.fill();
              ctx.shadowColor = "transparent";

              const grad = ctx.createLinearGradient(
                winMargin,
                winMargin,
                winMargin,
                winMargin + 60,
              );
              grad.addColorStop(0, "#FCF6F6");
              grad.addColorStop(1, "#FFFBFB");
              ctx.save();
              roundRect(ctx, winMargin, winMargin, winW, 60, 24);
              ctx.clip();
              ctx.fillStyle = grad;
              ctx.fillRect(winMargin, winMargin, winW, 60);
              ctx.restore();

              ctx.fillStyle = "#EDA6A6";
              ctx.beginPath();
              ctx.arc(winMargin + 40, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#E8D595";
              ctx.beginPath();
              ctx.arc(winMargin + 70, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#A8C8A6";
              ctx.beginPath();
              ctx.arc(winMargin + 100, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.strokeStyle = "#F2EBEB";
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(winMargin, winMargin + 60);
              ctx.lineTo(winMargin + winW, winMargin + 60);
              ctx.stroke();
            }

            // ------ B. ğŸ® ç©ä¼´ Cute Console ------
            if (s.type === "cute_console") {
              const screenMargin = 50;
              ctx.fillStyle = "#F7F9F8";
              ctx.shadowColor = "rgba(0,0,0,0.1)";
              ctx.shadowBlur = 0;
              ctx.shadowOffsetX = 4;
              ctx.shadowOffsetY = 4;
              roundRect(
                ctx,
                screenMargin,
                screenMargin,
                W - screenMargin * 2,
                H - 220,
                30,
              );
              ctx.fill();
              ctx.shadowColor = "transparent";

              ctx.strokeStyle = "#DDE4E2";
              ctx.lineWidth = 2;
              roundRect(
                ctx,
                screenMargin + 10,
                screenMargin + 10,
                W - screenMargin * 2 - 20,
                H - 220 - 20,
                20,
              );
              ctx.stroke();

              const controlsY = H - 120;
              ctx.fillStyle = "#A3B8B2";
              const dpadSize = 25;
              const dpadX = 120;
              roundRect(
                ctx,
                dpadX - dpadSize,
                controlsY - 8,
                dpadSize * 3,
                16,
                4,
              );
              ctx.fill();
              roundRect(
                ctx,
                dpadX,
                controlsY - 8 - dpadSize,
                16,
                dpadSize * 3,
                4,
              );
              ctx.fill();
              const btnY = controlsY;
              ctx.fillStyle = "#E6B8B8";
              ctx.beginPath();
              ctx.arc(W - 120, btnY - 20, 24, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#E8C8A0";
              ctx.beginPath();
              ctx.arc(W - 180, btnY + 10, 24, 0, Math.PI * 2);
              ctx.fill();
            }

            // ------ C. ğŸŒ™ ç¦…æ„ Zen Editor ------
            if (s.type === "zen_editor") {
              ctx.fillStyle = "#242933";
              ctx.fillRect(0, 0, W, 60);
              ctx.fillStyle = "#2E3440";
              ctx.beginPath();
              ctx.moveTo(20, 60);
              ctx.lineTo(20, 10);
              ctx.arcTo(20, 0, 30, 0, 10);
              ctx.lineTo(200, 0);
              ctx.arcTo(210, 0, 210, 10, 10);
              ctx.lineTo(210, 60);
              ctx.fill();
              ctx.fillStyle = "#88C0D0";
              ctx.font = `italic 20px ${fontName}`;
              ctx.fillText("thought.txt", 40, 35);
              ctx.fillText("Ã—", 180, 35);
              ctx.fillStyle = "#3B4252";
              ctx.fillRect(0, 60, 60, H - 60);
              ctx.fillStyle = "#4C566A";
              ctx.font = `18px ${fontName}`;
              ctx.textAlign = "right";
              for (let i = 1; i < 15; i++) {
                ctx.fillText(i, 45, 100 + (i - 1) * lineHeight);
              }
            }

            // ------ D. ğŸ§¾ å­˜æ ¹ Receipt ------
            if (s.type === "receipt") {
              const ticketW = 700;
              const ticketX = (W - ticketW) / 2;
              const ticketH = H - 60;
              ctx.shadowColor = "rgba(0,0,0,0.15)";
              ctx.shadowBlur = 20;
              ctx.shadowOffsetY = 10;
              ctx.fillStyle = "#fff";
              ctx.beginPath();
              ctx.moveTo(ticketX, 0);
              ctx.lineTo(ticketX + ticketW, 0);
              let yPos = ticketH;
              let xPos = ticketX + ticketW;
              const toothSize = 10;
              while (xPos > ticketX) {
                ctx.lineTo(xPos - toothSize, yPos - toothSize);
                ctx.lineTo(xPos - 2 * toothSize, yPos);
                xPos -= 2 * toothSize;
              }
              ctx.lineTo(ticketX, 0);
              ctx.fill();
              ctx.shadowColor = "transparent";
              ctx.strokeStyle = "#ddd";
              ctx.lineWidth = 2;
              ctx.setLineDash([10, 10]);
              ctx.beginPath();
              ctx.moveTo(ticketX + 30, 90);
              ctx.lineTo(ticketX + ticketW - 30, 90);
              ctx.stroke();
              const bottomLineY = H - 160;
              ctx.beginPath();
              ctx.moveTo(ticketX + 30, bottomLineY);
              ctx.lineTo(ticketX + ticketW - 30, bottomLineY);
              ctx.stroke();
              ctx.setLineDash([]);
              ctx.fillStyle = "#000";
              ctx.font = `bold 30px "Courier New"`;
              ctx.textAlign = "center";
              ctx.fillText("MUSEUM OF THOUGHTS", W / 2, 60);
            }

            // ------ E. ğŸ§§ ä¿¡ç¬º Letter ------
            if (s.type === "letter") {
              ctx.strokeStyle = "rgba(200, 100, 100, 0.15)";
              ctx.lineWidth = 2;
              const gridW = 60;
              const startX = paddingX - 20;
              const endX = W - paddingX + 20;
              for (let x = startX; x <= endX; x += gridW) {
                ctx.beginPath();
                ctx.moveTo(x, 40);
                ctx.lineTo(x, H - 40);
                ctx.stroke();
              }
              ctx.strokeStyle = "rgba(200, 100, 100, 0.4)";
              ctx.lineWidth = 4;
              ctx.beginPath();
              ctx.moveTo(startX, 80);
              ctx.lineTo(endX, 80);
              ctx.stroke();
            }

            // ------ F. ğŸ«§ å¼¥æ•£ Diffusion (å®Œå…¨é‡åˆ¶ç‰ˆ) ------
            if (s.type === "diffusion") {
              // 1. èƒŒæ™¯ï¼šä½¿ç”¨æ·±ç©ºç°/åˆå¤œè“ï¼Œæ›¿ä»£æ­»é»‘
              ctx.fillStyle = "#1C1C1E";
              ctx.fillRect(0, 0, W, H);

              // 2. æ¸å˜ï¼šä½é¥±å’Œåº¦ã€å¤§åŠå¾„ã€æŸ”å’Œè¿‡æ¸¡
              // å·¦ä¸Šï¼šé›¾éœ¾è“/ç°è“
              let g1 = ctx.createRadialGradient(0, 0, 0, W / 1.2, H / 1.2, W);
              g1.addColorStop(0, "rgba(94, 114, 128, 0.4)");
              g1.addColorStop(1, "transparent");
              ctx.fillStyle = g1;
              ctx.fillRect(0, 0, W, H);

              // å³ä¸‹ï¼šå¹²æ¯ç«ç‘°/æš–ç°
              let g2 = ctx.createRadialGradient(W, H, 0, W / 1.2, H / 1.2, W);
              g2.addColorStop(0, "rgba(156, 136, 136, 0.35)");
              g2.addColorStop(1, "transparent");
              ctx.fillStyle = g2;
              ctx.fillRect(0, 0, W, H);

              // 3. å™ªç‚¹çº¹ç†ï¼šæ¨¡æ‹Ÿèƒ¶ç‰‡é¢—ç²’æ„Ÿ (æå‡é«˜çº§æ„Ÿå…³é”®)
              ctx.save();
              ctx.fillStyle = "rgba(255,255,255,0.03)";
              // éšæœºç”»ä¸€äº›å¾®å°çš„ç‚¹ï¼Œä¸ç”¨å¤ªå¤š
              for (let i = 0; i < 600; i++) {
                const nx = Math.random() * W;
                const ny = Math.random() * H;
                ctx.fillRect(nx, ny, 2, 2);
              }
              ctx.restore();

              // 4. å®¹å™¨ï¼šå»æ‰æè¾¹ï¼Œæ”¹ç”¨ææ·¡çš„ç»ç’ƒåå…‰
              ctx.fillStyle = "rgba(255, 255, 255, 0.02)";
              const cardM = 40;
              roundRect(ctx, cardM, cardM, W - cardM * 2, H - cardM * 2, 24);
              ctx.fill();

              // 5. è£…é¥°ï¼šæç®€æ’­æ”¾å™¨è¿›åº¦æ¡æ¨¡æ‹Ÿ
              const barY = H - cardM - 70;
              ctx.fillStyle = "rgba(255,255,255,0.15)";
              // è¿›åº¦æ¡æ§½
              roundRect(ctx, cardM + 50, barY, 100, 4, 2);
              ctx.fill();
              // è¿›åº¦ç‚¹
              ctx.fillStyle = "rgba(255,255,255,0.5)";
              roundRect(ctx, cardM + 50, barY, 40, 4, 2);
              ctx.fill();
            }

            // === 3. ç»˜åˆ¶æ–‡å­—å†…å®¹ ===
            ctx.fillStyle = s.text;
            ctx.textBaseline = "top";
            ctx.textAlign = "left";

            // æ¢å¤æ­£æ–‡å­—ä½“
            ctx.font = `300 ${fontSize}px ${fontName}`;
            if (s.type === "zen_editor")
              ctx.font = `400 ${fontSize}px ${fontName}`;
            if (s.type === "diffusion")
              ctx.font = `400 ${fontSize}px ${fontName}`; // å¼¥æ•£ä¸éœ€è¦å¤ªç²—äº†
            if (s.type === "receipt") ctx.font = `400 32px ${fontName}`;

            ctx.letterSpacing = s.letter ? "2px" : "0px";

            let drawX = paddingX;
            let drawY = paddingTop;
            if (s.type === "receipt") drawX = (W - 560) / 2;

            wrapText(ctx, text, drawX, drawY, textWidthLimit, lineHeight);

            // === 4. ç»˜åˆ¶åº•éƒ¨ä¿¡æ¯ ===
            const footerY = H - paddingBottom + 50;

            // æ—¥æœŸ
            ctx.font = `400 22px ${fontName}`;
            ctx.fillStyle = s.sub;
            ctx.textAlign = "left";
            if (s.type === "diffusion") ctx.fillStyle = "rgba(255,255,255,0.5)"; // æ—¥æœŸä¹ŸæŸ”å’Œä¸€ç‚¹

            let footerX = paddingX;
            let realFooterY = footerY;
            let dateStr = date;

            if (s.type === "cute_console") {
              realFooterY = H - 280;
            }
            if (s.type === "receipt") {
              realFooterY = H - 120;
              footerX = drawX;
              dateStr = date + " " + new Date().toLocaleTimeString();
              ctx.font = `400 20px "Courier New"`;
            }
            // å¼¥æ•£é£æ ¼æ—¥æœŸä½ç½®å¾®è°ƒ
            if (s.type === "diffusion") realFooterY = H - paddingBottom + 30;

            ctx.fillText(dateStr, footerX, realFooterY);

            // Logo / ç­¾å / è£…é¥°
            ctx.textAlign = "right";

            if (s.type === "dream_os") {
              ctx.font = `300 22px sans-serif`;
              ctx.fillStyle = "#D0C0C0";
              ctx.fillText("MUSEUM", W - paddingX, realFooterY);
            } else if (s.type === "cute_console") {
              ctx.font = `bold 20px sans-serif`;
              ctx.fillStyle = "#B5C9C3";
              ctx.fillText("MUSEUM", W - paddingX, realFooterY);
            } else if (s.type === "zen_editor") {
              ctx.fillStyle = "#81A1C1";
              ctx.fillText(
                "Ln " + lineCount + ", Col 1  UTF-8",
                W - 40,
                H - 20,
              );
            } else if (s.type === "receipt") {
              const barX = W - footerX - 150;
              const barY = H - 135;
              ctx.fillStyle = "#000";
              for (let i = 0; i < 30; i++) {
                const w = Math.random() > 0.5 ? 2 : 5;
                const gap = Math.random() * 5 + 2;
                ctx.fillRect(barX + i * 5, barY, w, 40);
              }
              ctx.font = "16px Courier New";
              ctx.fillText("THANKS", W - footerX, barY + 60);
            } else if (s.type === "letter") {
              const sealSize = 60;
              const sealX = W - paddingX - sealSize;
              const sealY = realFooterY - 20;
              ctx.strokeStyle = "#d66";
              ctx.lineWidth = 3;
              ctx.strokeRect(sealX, sealY, sealSize, sealSize);
              ctx.fillStyle = "#d66";
              ctx.font = `400 28px "Noto Serif SC"`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(
                "åš",
                sealX + sealSize / 2 + 2,
                sealY + sealSize / 2 - 12,
              );
              ctx.fillText(
                "ç‰©",
                sealX + sealSize / 2 - 2,
                sealY + sealSize / 2 + 12,
              );
            } else if (s.type === "diffusion") {
              ctx.font = `italic 24px serif`;
              ctx.fillStyle = "rgba(255,255,255,0.4)";
              ctx.fillText("Museum of Thoughts", W - paddingX, realFooterY);
            } else {
              ctx.font = `300 24px "Noto Serif SC"`;
              ctx.fillText("åšç‰©é¦† | MUSEUM", W - paddingX, realFooterY);
            }
          };

          const handleDownload = (item) => {
            if (item.type === "text") {
              exportItem.value = item;
              exportStyle.value = "classic";
              showExport.value = true;
              nextTick(() => drawCard());
            } else if (item.type === "link") {
              downloadString(
                `[InternetShortcut]\nURL=${item.file_url}`,
                "link.url",
                "text/plain",
              );
            } else if (item.type === "beautify") {
              // ç¾åŒ–æ–‡ä»¶ä¸‹è½½é€»è¾‘ï¼šä¸‹è½½å½“å‰é€‰ä¸­é¢œè‰²çš„çœŸå®æ–‡ä»¶
              const data = getBeautifyData(item);
              const idx = getBeautifyIndex(item.id);
              if (data.variations && data.variations[idx]) {
                const variant = data.variations[idx];
                if (variant.file) {
                  downloadFile(variant.file, `${data.title}-${variant.name}`);
                } else {
                  alert("è¯¥é¢œè‰²æ–¹æ¡ˆæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶");
                }
              }
            } else {
              // é€šç”¨æ–‡ä»¶ä¸‹è½½ï¼ˆåŒ…å« chat ç±»å‹ï¼‰
              downloadFile(item.file_url, item.content || "file");
            }
          };

          const downloadString = (str, name, type) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([str], { type }));
            a.download = name;
            a.click();
          };

          const downloadFile = async (url, name) => {
            try {
              const res = await fetch(url);
              const blob = await res.blob();
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              let ext = url.split(".").pop().split("?")[0];
              if (ext.length > 4 || ext.includes("/")) {
                const type = blob.type;
                if (type.includes("image")) ext = "png";
                else if (type.includes("zip")) ext = "zip";
                else if (type.includes("text/plain")) ext = "txt";
                else if (type.includes("json")) ext = "json";
                else ext = "file";
              }
              a.download = `${name}.${ext}`;
              a.click();
            } catch {
              window.open(url, "_blank");
            }
          };
          // --- æ–°å¢ï¼šå¯¼å‡ºç¾åŒ–åŒ… ---
          const exportBeautifyPackage = async (item) => {
            const data = getBeautifyData(item);
            if (!data.variations || data.variations.length === 0) return;

            const zip = new JSZip();
            // åˆ›å»ºä¸€ä¸ªæè¿°æ–‡ä»¶ï¼Œç”¨äºå¯¼å…¥æ—¶è¯†åˆ«
            const manifest = {
              type: "museum-beautify-package", // è¯†åˆ«æš—å·
              version: "1.0",
              title: data.title,
              variations: [],
            };

            // æç¤ºç”¨æˆ·æ­£åœ¨æ‰“åŒ…
            const btn = event.currentTarget;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block">â†»</span>`;

            try {
              // éå†æ‰€æœ‰å˜ä½“ï¼ˆé¢œè‰²ï¼‰
              for (let i = 0; i < data.variations.length; i++) {
                const v = data.variations[i];
                const variantInfo = {
                  color: v.color,
                  name: v.name,
                  previewFile: null,
                  realFile: null,
                };

                // ä¸‹è½½é¢„è§ˆå›¾å¹¶å­˜å…¥ ZIP
                if (v.preview) {
                  const blob = await fetch(v.preview).then((r) => r.blob());
                  // è·å–åç¼€
                  let ext = v.preview.split(".").pop().split("?")[0] || "png";
                  if (ext.length > 4) ext = "png";
                  const filename = `p_${i}.${ext}`;
                  zip.file(filename, blob);
                  variantInfo.previewFile = filename;
                }

                // ä¸‹è½½æºæ–‡ä»¶å¹¶å­˜å…¥ ZIP
                if (v.file) {
                  const blob = await fetch(v.file).then((r) => r.blob());
                  let ext = v.file.split(".").pop().split("?")[0] || "zip";
                  if (ext.length > 5) ext = "zip";
                  const filename = `f_${i}.${ext}`;
                  zip.file(filename, blob);
                  variantInfo.realFile = filename;
                }

                manifest.variations.push(variantInfo);
              }

              // å†™å…¥æè¿°æ–‡ä»¶
              zip.file("manifest.json", JSON.stringify(manifest, null, 2));

              // ç”Ÿæˆå¹¶ä¸‹è½½
              const content = await zip.generateAsync({ type: "blob" });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(content);
              a.download = `${data.title || "ç¾åŒ–åŒ…"}.zip`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            } catch (e) {
              console.error(e);
              alert("æ‰“åŒ…å¤±è´¥ï¼šå¯èƒ½å­˜åœ¨ç½‘ç»œè·¨åŸŸé—®é¢˜æˆ–æ–‡ä»¶å·²å¤±æ•ˆã€‚");
            } finally {
              btn.innerHTML = originalIcon;
            }
          };

          const downloadAsImage = () => {
            const link = document.createElement("a");
            link.download = `excerpt-${Date.now()}.png`;
            link.href = quoteCanvas.value.toDataURL("image/png");
            link.click();
          };

          const downloadAsText = () => {
            navigator.clipboard
              .writeText(exportItem.value.content)
              .then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
          };

          const deleteItem = async (item) => {
            if (!confirm("ç¡®è®¤åˆ é™¤?")) return;
            try {
              if (
                item.file_url &&
                item.type !== "link" &&
                item.type !== "beautify"
              ) {
                const p = item.file_url.split("/uploads/").pop();
                if (p) await supabase.storage.from("uploads").remove([p]);
              }
              // å¦‚æœæ˜¯ç¾åŒ–ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å¤šä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæš‚ä¸å¤„ç†æ·±åº¦æ¸…ç†ï¼Œä»…åˆ é™¤è®°å½•
              await supabase.from("fragments").delete().eq("id", item.id);
              items.value = items.value.filter((i) => i.id !== item.id);
            } catch (e) {
              alert(e.message);
            }
          };

          const handleOpenHtml = async (item) => {
            try {
              const res = await fetch(item.file_url);
              const blob = await res.blob();
              window.open(
                URL.createObjectURL(new Blob([blob], { type: "text/html" })),
                "_blank",
              );
            } catch (e) {
              alert("åŠ è½½å¤±è´¥");
            }
          };

          const openLink = (u) =>
            window.open(u.startsWith("http") ? u : "https://" + u, "_blank");
          // --- ä¿®æ”¹ï¼šæ–‡ä»¶é€‰æ‹©å¤„ç†ï¼ˆå¢åŠ æ™ºèƒ½è¯†åˆ«ï¼‰ ---
          const handleFileSelect = async (e) => {
            const selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length === 0) return;

            // æ£€æŸ¥æ˜¯å¦åªæœ‰ä¸€ä¸ª ZIP æ–‡ä»¶ï¼Œä¸”å½“å‰ä¸åœ¨ç¼–è¾‘æ¨¡å¼
            const file = selectedFiles[0];
            if (
              selectedFiles.length === 1 &&
              file.name.endsWith(".zip") &&
              !editingId.value
            ) {
              try {
                // å°è¯•è§£å‹è¯»å–
                const zip = await JSZip.loadAsync(file);
                if (zip.file("manifest.json")) {
                  const manifestStr = await zip
                    .file("manifest.json")
                    .async("string");
                  const manifest = JSON.parse(manifestStr);

                  // ç¡®è®¤æš—å·ï¼šæ˜¯æˆ‘ä»¬çš„ç¾åŒ–åŒ…å—ï¼Ÿ
                  if (manifest.type === "museum-beautify-package") {
                    if (
                      !confirm(
                        `æ£€æµ‹åˆ°ç¾åŒ–èµ„æºåŒ…ï¼š"${manifest.title}"\nåŒ…å« ${manifest.variations.length} ç§æ ·å¼ã€‚\næ˜¯å¦è‡ªåŠ¨å¡«å…¥ç¾åŒ–è¡¨å•ï¼Ÿ`,
                      )
                    ) {
                      // ç”¨æˆ·é€‰æ‹©äº†â€œå¦â€ï¼Œå½“ä½œæ™®é€šæ–‡ä»¶ä¸Šä¼ 
                      uploadForm.value.files = selectedFiles;
                      return;
                    }

                    // === æ™ºèƒ½å¡«å•æ¨¡å¼ ===
                    uploadForm.value.type = "beautify";
                    uploadForm.value.title = manifest.title;
                    uploadForm.value.beautifyVariations = []; // æ¸…ç©ºé»˜è®¤

                    // éå†åŒ…å†…æ•°æ®ï¼Œè¿˜åŸä¸º File å¯¹è±¡
                    for (const v of manifest.variations) {
                      const newItem = {
                        colorName: v.name,
                        colorValue: v.color,
                        previewFile: null,
                        realFile: null,
                        previewUrl: null,
                        realUrl: null,
                      };

                      // ä» Zip æå–æ–‡ä»¶è½¬å› File å¯¹è±¡
                      if (v.previewFile && zip.file(v.previewFile)) {
                        const blob = await zip
                          .file(v.previewFile)
                          .async("blob");
                        newItem.previewFile = new File([blob], v.previewFile, {
                          type: blob.type,
                        });
                      }
                      if (v.realFile && zip.file(v.realFile)) {
                        const blob = await zip.file(v.realFile).async("blob");
                        newItem.realFile = new File([blob], v.realFile, {
                          type: blob.type,
                        });
                      }

                      uploadForm.value.beautifyVariations.push(newItem);
                    }
                    return; // ç»“æŸï¼Œä¸å†æ‰§è¡Œæ™®é€šæ–‡ä»¶èµ‹å€¼
                  }
                }
              } catch (err) {
                console.log("éä¸“ç”¨ç¾åŒ–åŒ…ï¼ŒæŒ‰æ™®é€šæ–‡ä»¶å¤„ç†", err);
              }
            }

            // æ™®é€šæ–‡ä»¶å¤„ç†é€»è¾‘ï¼ˆä¿æŒåŸæ ·ï¼‰
            uploadForm.value.files = selectedFiles;
          };

          const selectTag = (tag) => {
            currentTag.value = tag;
            currentAlbum.value = null;
            filter.value = "all";
          };
          const handleEdit = (item) => {
            editingId.value = item.id;
            const isBeautify = item.type === "beautify";
            // è·å–ç¾åŒ–æ•°æ®ï¼Œé˜²æ­¢ JSON è§£æå¤±è´¥å¯¼è‡´æŠ¥é”™
            const beautifyData = isBeautify ? getBeautifyData(item) : null;

            uploadForm.value = {
              type: item.type,
              category: item.category,
              // ä¿®æ”¹ title çš„å–å€¼é€»è¾‘ï¼šå¦‚æœæ˜¯ fontï¼Œcontent å°±æ˜¯åå­—
              title:
                isBeautify || item.type === "font"
                  ? item.content || ""
                  : item.type === "text"
                    ? ""
                    : item.content,
              content: item.type === "font" ? item.content : item.content, // ç¡®ä¿ content å›å¡«
              url:
                item.type === "link" || item.type === "font"
                  ? item.file_url
                  : "",
              files: [],
              useAlbum: !!item.album_name,
              albumName: item.album_name
                ? item.album_name.startsWith(".")
                  ? item.album_name.substring(1)
                  : item.album_name
                : "",
              // ã€é‡ç‚¹ã€‘æ„å»ºç¾åŒ–å˜ä½“æ•°æ®ï¼Œç¡®ä¿æ—§é“¾æ¥ (previewUrl/realUrl) è¢«ä¿ç•™
              beautifyVariations:
                isBeautify && beautifyData.variations
                  ? beautifyData.variations.map((v) => ({
                      colorName: v.name,
                      colorValue: v.color,
                      previewUrl: v.preview, // å…³é”®ï¼šä¿ç•™æ—§é¢„è§ˆå›¾é“¾æ¥
                      realUrl: v.file, // å…³é”®ï¼šä¿ç•™æ—§æ–‡ä»¶é“¾æ¥
                      previewFile: null,
                      realFile: null,
                    }))
                  : [],
              fontSourceType: item.file_url ? "url" : "file",
            };

            // å¦‚æœæ˜¯ç¾åŒ–ç±»å‹ä½†æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤é¡¹
            if (
              isBeautify &&
              uploadForm.value.beautifyVariations.length === 0
            ) {
              addBeautifyItem();
            }

            showUpload.value = true;
          };

          const toggleAlbumVisibility = async () => {
            if (!currentAlbum.value || !supabase) return;
            const oldName = currentAlbum.value;
            const isHidden = oldName.startsWith(".");
            const newName = isHidden ? oldName.substring(1) : "." + oldName;

            if (
              !confirm(
                `ç¡®è®¤å°†æ­¤ç›¸å†Œè®¾ä¸º "${isHidden ? "å…¬å¼€æ˜¾ç¤º" : "ä»…ç›¸å†Œå†…å¯è§"}" å—ï¼Ÿ\n${isHidden ? "å…¬å¼€åï¼Œå›¾ç‰‡å°†å‡ºç°åœ¨â€œå½±åƒâ€æµä¸­ã€‚" : "éšè—åï¼Œå›¾ç‰‡å°†ä»â€œå½±åƒâ€æµä¸­æ¶ˆå¤±ï¼Œä»…åœ¨æ­¤ç›¸å†Œå†…æ˜¾ç¤ºã€‚"}`,
              )
            )
              return;

            loading.value = true;
            try {
              // 1. å‘é€æ›´æ–°è¯·æ±‚
              const { error } = await supabase
                .from("fragments")
                .update({ album_name: newName })
                .eq("album_name", oldName);

              if (error) throw error;

              // 2. ã€å…³é”®ä¿®æ”¹ã€‘ä¸æ‰‹åŠ¨ä¿®æ”¹æœ¬åœ°æ•°ç»„ï¼Œè€Œæ˜¯é‡æ–°æ‹‰å–æœåŠ¡å™¨æ•°æ®
              // è¿™æ ·èƒ½ä¿è¯å¦‚æœæœåŠ¡å™¨æ²¡å­˜è¿›å»ï¼Œé¡µé¢ä¸Šç«‹é©¬èƒ½çœ‹å‡ºæ¥
              await fetchData();

              // 3. ä¿æŒå½“å‰æµè§ˆçš„ç›¸å†Œè§†å›¾ä¸è¢«å…³é—­
              currentAlbum.value = newName;
            } catch (e) {
              alert("æ“ä½œå¤±è´¥: " + e.message);
            } finally {
              loading.value = false;
            }
          };

          // TUS ä¸Šä¼ è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å¤§æ–‡ä»¶
          const uploadWithTus = (file, fileName) => {
            return new Promise((resolve, reject) => {
              // æ„é€  TUS ä¸Šä¼ ç«¯ç‚¹ï¼š[PROJECT_URL]/storage/v1/upload/resumable
              const endpoint = `${config.value.url.replace(/\/$/, "")}/storage/v1/upload/resumable`;

              const upload = new tus.Upload(file, {
                endpoint: endpoint,
                retryDelays: [0, 3000, 5000, 10000, 20000],
                headers: {
                  authorization: `Bearer ${session.value.access_token}`,
                  "x-client-info": "supabase-js-web",
                },
                metadata: {
                  bucketName: "uploads",
                  objectName: fileName,
                  contentType: file.type,
                  cacheControl: "3600",
                },
                chunkSize: 6 * 1024 * 1024, // 6MB chunks
                onError: (error) => {
                  console.error("TUS Upload Failed:", error);
                  reject(error);
                },
                onSuccess: () => {
                  resolve();
                },
              });
              upload.start();
            });
          };
          const submitUpload = async () => {
            if (!supabase) return;
            uploading.value = true;
            try {
              const {
                type,
                category,
                content,
                title,
                url,
                files,
                useAlbum,
                albumName,
                beautifyVariations,
              } = uploadForm.value;

              const cat = category || "æœªåˆ†ç±»";
              const uid = session.value.user.id;
              let payload = { category: cat };

              // --- 1. æ„å»º Payload æ•°æ®åŒ… ---

              if (type === "text") {
                payload.content = content;
              } else if (type === "font") {
                // === æ–°å¢ï¼šå­—ä½“æäº¤é€»è¾‘ ===
                payload.content = uploadForm.value.content || "æœªå‘½åå­—ä½“"; // content å­˜å­—ä½“åå­—

                if (uploadForm.value.fontSourceType === "url") {
                  payload.file_url = url; // å¦‚æœæ˜¯ URL æ¨¡å¼ï¼Œç›´æ¥å­˜ URL
                }
                // å¦‚æœæ˜¯ file æ¨¡å¼ï¼Œåç»­çš„é€šç”¨æ–‡ä»¶ä¸Šä¼ é€»è¾‘ä¼šå¤„ç†å®ƒ
              } else if (type === "link") {
                payload.content = title || url;
                payload.file_url = url;
              } else if (type === "beautify") {
                // === ç¾åŒ–ç±»å‹ç‰¹æ®Šå¤„ç† ===
                if (!beautifyVariations || beautifyVariations.length === 0)
                  throw new Error("è¯·è‡³å°‘æ·»åŠ ä¸€ç§é…è‰²æ–¹æ¡ˆ");

                const variations = [];
                for (const v of beautifyVariations) {
                  // å¤„ç†é¢„è§ˆå›¾ï¼šæœ‰æ–°æ–‡ä»¶ä¼ æ–°æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™ç”¨æ—§é“¾æ¥
                  let previewUrl = v.previewUrl;
                  if (v.previewFile) {
                    const pExt = v.previewFile.name.split(".").pop();
                    const pName = `beautify_prev_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${pExt}`;
                    const { error: pErr } = await supabase.storage
                      .from("uploads")
                      .upload(pName, v.previewFile);
                    if (pErr) throw pErr;
                    const { data: pData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(pName);
                    previewUrl = pData.publicUrl;
                  }

                  // å¤„ç†çœŸå®æ–‡ä»¶ï¼šåŒä¸Š
                  let realUrl = v.realUrl;
                  if (v.realFile) {
                    const fExt = v.realFile.name.split(".").pop();
                    const fName = `beautify_file_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${fExt}`;

                    // å¤§æ–‡ä»¶ä½¿ç”¨ TUS
                    if (v.realFile.size > 6 * 1024 * 1024) {
                      await uploadWithTus(v.realFile, fName);
                    } else {
                      const { error: fErr } = await supabase.storage
                        .from("uploads")
                        .upload(fName, v.realFile);
                      if (fErr) throw fErr;
                    }
                    const { data: fData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(fName);
                    realUrl = fData.publicUrl;
                  }

                  // éªŒè¯å®Œæ•´æ€§
                  if (!previewUrl || !realUrl) {
                    throw new Error(
                      `é…è‰² "${v.colorName || "æœªå‘½å"}" ç¼ºå°‘å›¾ç‰‡æˆ–æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ã€‚`,
                    );
                  }
                  variations.push({
                    name: v.colorValue, // ä¿®æ”¹å¤„ï¼šç›´æ¥ç”¨é¢œè‰²ä»£ç ä½œä¸ºåå­—
                    color: v.colorValue,
                    preview: previewUrl,
                    file: realUrl,
                  });
                }

                // å°†ç»“æ„åŒ–æ•°æ®è½¬ä¸º JSON å­˜å…¥ content
                const jsonContent = JSON.stringify({
                  title: title || "æœªå‘½åä¸»é¢˜",
                  variations: variations,
                });
                payload.content = jsonContent;
                // ç”¨ç¬¬ä¸€å¼ å›¾ä½œä¸ºå°é¢
                payload.file_url = variations[0].preview;
              } else {
                // === å…¶ä»–ç±»å‹ (Image, Chat, Html) ===
                payload.content = title; // è¿™é‡Œçš„ title æ˜¯ç”¨æˆ·è¾“å…¥çš„æ ‡é¢˜

                // å›¾ç‰‡ç›¸å†Œé€»è¾‘
                if (type === "image") {
                  if (useAlbum && albumName) {
                    const existingHidden = albumList.value.find(
                      (a) => a.isHidden && a.displayName === albumName,
                    );
                    payload.album_name = existingHidden
                      ? existingHidden.realName
                      : albumName;
                  } else {
                    payload.album_name = null;
                  }
                }
              }

              // --- 2. æäº¤åˆ°æ•°æ®åº“ ---

              if (editingId.value) {
                // ====== ç¼–è¾‘æ¨¡å¼ (UPDATE) ======
                // å…³é”®ç‚¹ï¼šæ·»åŠ  .select() æ¥è·å–æ›´æ–°åçš„æ•°æ®ï¼Œç¡®è®¤æ˜¯å¦æ›´æ–°æˆåŠŸ
                const { data, error } = await supabase
                  .from("fragments")
                  .update(payload)
                  .eq("id", editingId.value)
                  .select();

                if (error) throw error;

                // å…³é”®ç‚¹ï¼šå¦‚æœæ•°æ®åº“è¿”å›ç©ºæ•°ç»„ï¼Œè¯´æ˜æ ¹æœ¬æ²¡æ›´æ–°ï¼ˆå¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–IDä¸å¯¹ï¼‰
                if (!data || data.length === 0) {
                  throw new Error(
                    "æ›´æ–°å¤±è´¥ï¼šæ— æ³•ä¿®æ”¹æ­¤æ¡ç›®ï¼ˆå¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–è®°å½•ä¸å­˜åœ¨ï¼‰",
                  );
                }
              } else {
                // ====== æ–°å¢æ¨¡å¼ (INSERT) ======
                if (type === "text" || type === "link" || type === "beautify") {
                  const { error } = await supabase
                    .from("fragments")
                    .insert({ ...payload, type, user_id: uid });
                  if (error) throw error;
                } else if (files.length) {
                  // æ–‡ä»¶ç±»æ–°å¢
                  await Promise.all(
                    files.map(async (f) => {
                      const ext = f.name.split(".").pop();
                      const fname = `${Date.now()}-${Math.random().toString(36).substr(2, 5)}.${ext}`;
                      if (f.size > 6 * 1024 * 1024) {
                        await uploadWithTus(f, fname);
                      } else {
                        const { error } = await supabase.storage
                          .from("uploads")
                          .upload(fname, f, {
                            contentType:
                              ext === "html"
                                ? "text/html"
                                : ext === "ttf" ||
                                    ext === "otf" ||
                                    ext === "woff"
                                  ? "font/" + ext // ä¼˜åŒ– Content-Type
                                  : undefined,
                          });
                        if (error) throw error;
                      }
                      const { data } = supabase.storage
                        .from("uploads")
                        .getPublicUrl(fname);
                      return supabase.from("fragments").insert({
                        type,
                        category: cat,
                        content: title,
                        file_url: data.publicUrl,
                        user_id: uid,
                        album_name: payload.album_name,
                      });
                    }),
                  );
                }
              }

              // --- 3. å¼ºåˆ¶åˆ·æ–°ç•Œé¢ ---
              // è¿™ä¸€æ­¥ä¿è¯äº†ç•Œé¢æ˜¾ç¤ºçš„å†…å®¹ä¸€å®šæ¥è‡ªæ•°æ®åº“
              await fetchData();

              // é‡ç½®è¡¨å•å¹¶å…³é—­
              showUpload.value = false;
              editingId.value = null;
              uploadForm.value = {
                type: "text",
                category: "",
                title: "",
                url: "",
                content: "",
                files: [],
                useAlbum: false,
                albumName: "",
                beautifyVariations: [
                  {
                    colorName: "é»˜è®¤",
                    colorValue: "#000000",
                    previewFile: null,
                    realFile: null,
                    previewUrl: null,
                    realUrl: null,
                  },
                ],
              };
            } catch (e) {
              console.error(e);
              alert("æ“ä½œå¤±è´¥: " + e.message);
            } finally {
              uploading.value = false;
            }
          };

          return {
            config,
            auth,
            session,
            items,
            filter,
            filterMap,
            currentAlbum,
            currentTag,
            filteredItems,
            albumList,
            styles,
            showUpload,
            uploadForm,
            loading,
            uploading,
            errorMsg,
            fileStatusText,
            uploadTypes,
            lightboxImage,
            showExport,
            exportItem,
            exportStyle,
            quoteCanvas,
            handleLogin,
            handleLogout,
            handleFileSelect,
            submitUpload,
            deleteItem,
            handleOpenHtml,
            openLink,
            setFilter: (f) => {
              filter.value = f;
              currentAlbum.value = null;
              currentTag.value = null;
            },
            openAlbum: (n) => {
              currentAlbum.value = n;
              currentTag.value = null;
            },
            resetFilter: () => {
              if (currentTag.value) currentTag.value = null;
              else if (currentAlbum.value) currentAlbum.value = null;
              else filter.value = "all";
            },
            openLightbox: (u) => (lightboxImage.value = u),
            closeLightbox: () => (lightboxImage.value = null),
            closeExport: () => {
              showExport.value = false;
              exportItem.value = null;
            },
            handleDownload,
            changeExportStyle,
            downloadAsImage,
            downloadAsText,
            formatDate,
            getRealContent,
            getTags,
            selectTag,
            showInstallBtn,
            triggerInstall,
            editingId,
            handleEdit,
            toggleAlbumVisibility,
            handleFileSelect,
            exportBeautifyPackage,
            showThemeModal,
            currentTheme,
            themeOptions,
            setTheme,
            // æ–°å¢ç¾åŒ–ç›¸å…³
            getBeautifyData,
            getBeautifyPreview,
            addBeautifyItem,
            removeBeautifyItem,
            getBeautifyIndex,
            setBeautifyIndex,
            handleBeautifyZipImport,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
