<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>åšç‰©é¦† | MUSEUM</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="åšç‰©é¦†" />
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg"
    />
    <link rel="icon" href="https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg" />
    <link rel="manifest" id="my-manifest" href="" />
    <script>
      const manifestData = {
        name: "åšç‰©é¦†",
        short_name: "åšç‰©é¦†",
        start_url: ".",
        display: "standalone",
        background_color: "#FCFCFC",
        theme_color: "#FCFCFC",
        icons: [
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "192x192",
            type: "image/jpeg",
          },
          {
            src: "https://i.postimg.cc/hP15bcdK/ç¾åŒ–.jpg",
            sizes: "512x512",
            type: "image/jpeg",
          },
        ],
      };
      const stringManifest = JSON.stringify(manifestData);
      const blob = new Blob([stringManifest], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);
      document.querySelector("#my-manifest").setAttribute("href", manifestURL);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- å¼•å…¥ TUS å®¢æˆ·ç«¯ç”¨äºå¤§æ–‡ä»¶ä¸Šä¼  -->
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              serif: ['"Noto Serif SC"', "serif"],
              pixel: ['"Press Start 2P"', "cursive"], // æ–°å¢åƒç´ å­—ä½“å®šä¹‰
            },
            colors: {
              // ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ CSS å˜é‡
              black: "var(--text-main)",
              sub: "var(--text-sub)",
              bg: "var(--bg-main)",
              panel: "var(--bg-panel)",
              border: "var(--border-color)",
              accent: "var(--accent-color)",
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-out",
              "slide-up": "slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
            },
            keyframes: {
              fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      /* === ä¸»é¢˜å®šä¹‰ === */
      :root {
        /* é»˜è®¤: ç´ ç™½ (Original) */
        --bg-main: #fcfcfc;
        --bg-panel: #ffffff;
        --text-main: #0f0f0f;
        --text-sub: #888888;
        --border-color: #f1f1f1;
        --accent-color: #000000;
      }

      /* Lavender (æ·¡ç´« - ä¿®æ”¹ç‰ˆ) */
      [data-theme="lavender"] {
        /* èƒŒæ™¯ï¼šææ·¡çš„ç´«ç™½ï¼Œä¸å†æ˜¯æ·±ç´« */
        --bg-main: #fdfbfd;

        /* é¢æ¿ï¼šå¢åŠ ç™½è‰²é€æ˜åº¦ï¼Œè®©å®ƒçœ‹èµ·æ¥åƒç£¨ç ‚ç»ç’ƒ */
        --bg-panel: rgba(255, 255, 255, 0.75);

        /* æ–‡å­—ï¼šä½¿ç”¨æŸ”å’Œçš„ç°ç´«è‰²ï¼Œè€Œä¸æ˜¯åˆºçœ¼çš„æ·±è“ */
        --text-main: #5e548e;

        /* è¾…åŠ©å­—ï¼šæµ…ç°ç´« */
        --text-sub: #9f9aa4;

        /* è¾¹æ¡†ï¼šå‡ ä¹é€æ˜çš„ç™½ç´«è‰² */
        --border-color: rgba(255, 255, 255, 0.6);

        /* å¼ºè°ƒè‰²ï¼šæ·¡é¦™èŠ‹ç´« */
        --accent-color: #c4a6e8;

        /* èƒŒæ™¯æ¸å˜ï¼šä»â€œå‡ ä¹æ˜¯ç™½è‰²â€è¿‡æ¸¡åˆ°â€œæ·¡æ·¡çš„é¦™èŠ‹ç´«â€ï¼Œéå¸¸é€šé€ */
        background-image: linear-gradient(135deg, #fdfbfd 0%, #e8dff5 100%);
        background-attachment: fixed;
      }

      /* Morandi (è«å…°è¿ª) */
      [data-theme="morandi"] {
        --bg-main: #e0e5df; /* ç°ç»¿ */
        --bg-panel: #f0f2ef;
        --text-main: #5f6f65; /* æ·±ç°ç»¿ */
        --text-sub: #9ca8a3;
        --border-color: #d1d9d4;
        --accent-color: #8c9e96;
      }
      [data-theme="morandi"] body {
        background-color: #e0e5df;
      }
      /* === æ‰¾åˆ°è¿™é‡Œ (çº¦ 133 è¡Œ) === */

      /* æ”¹ä¸ºï¼š1. Pure Black (çº¯é»‘ - OLED æè‡´é»‘) */
      [data-theme="pure-black"] {
        --bg-main: #000000; /* çº¯é»‘èƒŒæ™¯ */
        --bg-panel: #000000; /* é¢æ¿ä¹Ÿçº¯é»‘ */
        --text-main: #ffffff; /* çº¯ç™½æ–‡å­— */
        --text-sub: #666666; /* æ·±ç°è¾…åŠ©å­— */
        --border-color: #333333; /*ä»¥æ­¤æ·±ç°è¾¹æ¡†æ¥åŒºåˆ†å¡ç‰‡ */
        --accent-color: #ffffff;
      }
      /* çº¯é»‘æ¨¡å¼ä¸éœ€è¦ body é¢å¤–èƒŒæ™¯è‰²ï¼Œé»˜è®¤å¼•ç”¨ bg-main å³å¯ */

      /* 2. Sakura (è½æ¨± - è½¯èŒå¯çˆ±) */
      [data-theme="sakura"] {
        --bg-main: #fff0f3; /* æµ…ç²‰èƒŒæ™¯ */
        --bg-panel: rgba(255, 255, 255, 0.85);
        --text-main: #5e3a45; /* å·§å…‹åŠ›è‰²å­—ä½“ */
        --text-sub: #d4a5b0;
        --border-color: #ffdae2;
        --accent-color: #ff8fa3; /* äº®ç²‰è‰²ç‚¹ç¼€ */
        background-image:
          radial-gradient(#ffe4e9 20%, transparent 20%),
          radial-gradient(#ffe4e9 20%, transparent 20%);
        background-size: 20px 20px;
        background-position:
          0 0,
          10px 10px;
      }

      /* 3. Cyan (é’é»› - å›½é£é›…éŸµ) */
      [data-theme="cyan"] {
        --bg-main: #f2f5f4; /* ææ·¡é’ç° */
        --bg-panel: #ffffff;
        --text-main: #2b4541; /* æ·±é’é»›è‰² */
        --text-sub: #8faeb0;
        --border-color: #dae3e1;
        --accent-color: #4a7570;
      }
      [data-theme="cyan"] body {
        background: linear-gradient(to bottom, #f2f5f4, #e6ebe9);
        background-attachment: fixed;
      }

      /* === åœ¨ <style> æ ‡ç­¾å†…ï¼Œæ¥ç€åŸæ¥çš„ä¸»é¢˜å¾€ä¸‹å†™ === */

      /* 1. æ‚å¿—é£ (Magazine) - é«˜çº§ã€è¡¬çº¿ä½“ã€çº¢é»‘æ’è‰² */
      [data-theme="magazine"] {
        --bg-main: #f2f2f2; /* æµ…ç°çº¸å¼ åº•è‰² */
        --bg-panel: #ffffff;
        --text-main: #1a1a1a; /* çº¯é»‘æ–‡å­— */
        --text-sub: #555555;
        --border-color: #000000; /* å¼ºçƒˆçš„é»‘è‰²è¾¹æ¡† */
        --accent-color: #cc3300; /* æ‚å¿—çº¢ */
      }
      /* æ‚å¿—é£ç‰¹æœ‰ï¼šå¼ºåˆ¶ä½¿ç”¨è¡¬çº¿å­—ä½“ï¼Œè¥é€ é˜…è¯»æ„Ÿ */
      [data-theme="magazine"] body {
        font-family: "Noto Serif SC", serif !important;
      }
      [data-theme="magazine"] .rounded-full,
      [data-theme="magazine"] .rounded-lg,
      [data-theme="magazine"] .rounded {
        border-radius: 0 !important; /* æ‚å¿—é£è¦ç›´è§’ï¼Œä¸è¦åœ†è§’ */
      }
      [data-theme="magazine"] header,
      [data-theme="magazine"] .bg-white {
        border: 1px solid #000 !important; /* ç»™å¡ç‰‡åŠ é»‘è¾¹ */
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1); /* ç¡¬æœ—çš„é˜´å½± */
      }

      /* 2. å¥¶æ²¹é£ (Cream) - èŒç³»ã€è½¯ç³¯ã€æš–é»„ */
      [data-theme="cream"] {
        --bg-main: #fffbf0; /* æš–é»„å¥¶æ²¹è‰² */
        --bg-panel: #ffffff;
        --text-main: #5d4037; /* å·§å…‹åŠ›è‰²æ–‡å­— */
        --text-sub: #a1887f;
        --border-color: #fae3d9;
        --accent-color: #ffab91; /* èœœæ¡ƒè‰² */
      }
      [data-theme="cream"] body {
        background-image: radial-gradient(#ffe0b2 20%, transparent 20%);
        background-size: 20px 20px; /* æ³¢ç‚¹èƒŒæ™¯ */
      }
      [data-theme="cream"] .rounded-lg,
      [data-theme="cream"] img {
        border-radius: 20px !important; /* å¢åŠ åœ†æ¶¦åº¦ */
      }

      /* === æ‰¾åˆ°è¿™é‡Œ (çº¦ 214 è¡Œ) === */

      /* æ”¹ä¸ºï¼š3. Deep Sea (æ·±æµ· - ä¿ç•™åŸæ¥çš„æ·±è“è‰²) */
      [data-theme="deep-sea"] {
        --bg-main: #0f172a; /* æ·±è“é»‘ */
        --bg-panel: rgba(30, 41, 59, 0.7); /* åŠé€æ˜æ·±è‰²ç»ç’ƒ */
        --text-main: #f8fafc; /* äº®ç™½ */
        --text-sub: #94a3b8; /* è“ç° */
        --border-color: #334155;
        --accent-color: #38bdf8; /* å¤©è“é«˜äº® */
      }
      [data-theme="deep-sea"] body {
        background: linear-gradient(to bottom, #0f172a, #1e293b);
        background-attachment: fixed;
      }

      /* 5. Paper (ç¾Šçš®å· - é˜…è¯»è´¨æ„Ÿ) */
      [data-theme="paper"] {
        --bg-main: #f7f3e8; /* æš–é»„çº¸å¼ è‰² */
        --bg-panel: #fdfbf7;
        --text-main: #3c3836; /* å¢¨é»‘ */
        --text-sub: #928374;
        --border-color: #e6dfc9;
        --accent-color: #b85c39; /* å°æ³¥çº¢ */
      }
      /* === æ–°å¢ä¸»é¢˜ç»“æŸ === */

      /* Pixel (åƒç´ é£) */
      [data-theme="pixel"] {
        --bg-main: #d0d0d0;
        --bg-panel: #ffffff;
        --text-main: #000000;
        --text-sub: #555555;
        --border-color: #000000;
        --accent-color: #0000ff;
      }
      [data-theme="pixel"] body {
        font-family:
          "Press Start 2P", cursive !important; /* å¼ºåˆ¶å…¨ç«™åƒç´ å­—ä½“ */
        background-image: radial-gradient(#000 1px, transparent 1px);
        background-size: 20px 20px;
        background-color: #e0e0e0;
      }
      /* åƒç´ é£ç‰¹æ®Šæ ·å¼ï¼šç§»é™¤åœ†è§’ï¼Œå¢åŠ é»‘è¾¹ */
      [data-theme="pixel"] .rounded-full,
      [data-theme="pixel"] .rounded-lg,
      [data-theme="pixel"] .rounded-xl,
      [data-theme="pixel"] .rounded,
      [data-theme="pixel"] input,
      [data-theme="pixel"] button,
      [data-theme="pixel"] img {
        border-radius: 0 !important;
      }
      /* è®©åƒç´ é£å¡ç‰‡æœ‰æ›´æ˜æ˜¾çš„é»‘è¾¹ */
      [data-theme="pixel"] .border {
        border-width: 2px !important;
      }
      [data-theme="pixel"] .fullscreen-layer,
      [data-theme="pixel"] header {
        border-bottom: 2px solid #000 !important;
      }
      [data-theme="pixel"] input {
        border: 2px solid #000 !important;
      }
      body {
        background-color: var(--bg-main);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
        transition:
          background-color 0.5s ease,
          color 0.5s ease;
        -moz-osx-font-smoothing: grayscale;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      header {
        padding-top: env(safe-area-inset-top);
      }
      .fullscreen-layer {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .safe-bottom {
        bottom: calc(2.5rem + env(safe-area-inset-bottom));
      }
      .no-scroll::-webkit-scrollbar {
        display: none;
      }
      .no-scroll {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* ä¿®å¤å›¾ç‰‡åŠ è½½é—ªçƒé—®é¢˜ */
      .img-loading {
        opacity: 0;
        transition: opacity 0.5s ease-out;
      }
      .img-loaded {
        opacity: 1;
      }
      .style-btn {
        transition: all 0.3s;
        position: relative;
      }
      .style-btn:hover {
        transform: translateY(-2px);
      }
      .style-btn.active::after {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 1px solid #000;
        border-radius: 50%;
      }
      .tag-link:hover {
        color: #000;
        text-decoration: underline;
      }
      .color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .color-dot:hover {
        transform: scale(1.1);
      }
      .color-dot.active {
        transform: scale(1.2);
        box-shadow:
          0 0 0 2px #fff,
          0 0 0 3px #000;
      }
      .ios-install-guide {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .ios-install-guide.show {
        transform: translateY(0);
      }
      .ios-install-arrow {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #000;
        animation: bounce 1s infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateX(-50%) translateY(0);
        }
        50% {
          transform: translateX(-50%) translateY(5px);
        }
      }
      /* === æ–°å¢ï¼šè‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ (ç”¨äºæ—¶é—´è½´) === */
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px; /* æç»†æ»šåŠ¨æ¡ */
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.3);
      }
      /* === æ–°å¢ï¼š3D å¡ç‰‡ç¿»è½¬å·¥å…·ç±» === */
      .perspective-1000 {
        perspective: 1000px;
      }
      .preserve-3d {
        transform-style: preserve-3d;
      }
      .backface-hidden {
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      .rotate-y-180 {
        transform: rotateY(180deg);
      }
      /* èƒŒé¢ä»‹ç»æ–‡å­—çš„å®¹å™¨æ ·å¼ */
      .card-back-content {
        transform: rotateY(180deg); /* åˆå§‹å°±è½¬è¿‡å»ï¼ŒèƒŒé¢æœäºº */
        background-color: var(--bg-panel);
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen flex flex-col font-sans selection:bg-black selection:text-white"
    >
      <!-- 1. ç™»å½•å±‚ (é«˜çº§å†·æ·¡é£ / å›ºå®šURLç‰ˆ) -->
      <div
        v-if="!session"
        class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-8 transition-all duration-1000"
        style="
          background-image: url(&quot;https://i.postimg.cc/k4G0JmTV/com-xingin-xhs-20260213125939.jpg&quot;);
          background-size: cover;
          background-position: center;
        "
      >
        <!-- 1. åŠ å¼ºç‰ˆé®ç½©ï¼šç”±åŸæ¥çš„ white/10 æ”¹ä¸º white/30ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªèŠ±çœ‹ä¸æ¸…å­— -->
        <div class="absolute inset-0 bg-white/30 backdrop-blur-sm"></div>

        <!-- 2. ç»ç’ƒå¡ç‰‡ï¼šé«˜å¼ºåº¦ç£¨ç ‚ + é”åˆ©ç›´è§’ -->
        <div
          class="relative w-full max-w-[340px] bg-white/40 backdrop-blur-2xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] p-12 animate-fade-in flex flex-col items-center border border-white/60"
        >
          <!-- è£…é¥°ï¼šé¡¶éƒ¨æç»†é»‘çº¿ -->
          <div class="absolute top-0 left-0 w-full h-[2px] bg-black"></div>

          <!-- LOGO -->
          <h1
            class="text-4xl font-serif tracking-[0.4em] font-normal text-black mb-14 mt-2 select-none"
          >
            MUSEUM
          </h1>

          <div class="w-full space-y-10">
            <!-- URL è¾“å…¥æ¡† (æ–°å¢) -->
            <div class="relative group">
              <input
                v-model="config.url"
                type="text"
                placeholder="SUPABASE URL"
                style="
                  color: #000000 !important;
                  -webkit-text-fill-color: #000000 !important;
                "
                class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
              />
              <span
                class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
              ></span>
            </div>

            <!-- KEY è¾“å…¥ -->
            <div class="relative group">
              <input
                v-model="config.key"
                type="password"
                placeholder="ACCESS KEY"
                style="
                  color: #000000 !important;
                  -webkit-text-fill-color: #000000 !important;
                "
                class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
              />
              <!-- åº•éƒ¨é»‘çº¿åŠ¨ç”» -->
              <span
                class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
              ></span>
            </div>

            <!-- é‚®ç®±/å¯†ç  ç»„åˆ -->
            <div class="space-y-6 pt-2">
              <div class="relative group">
                <input
                  v-model="auth.email"
                  type="email"
                  placeholder="EMAIL"
                  style="
                    color: #000000 !important;
                    -webkit-text-fill-color: #000000 !important;
                  "
                  class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
                />
                <span
                  class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
                ></span>
              </div>

              <div class="relative group">
                <input
                  v-model="auth.password"
                  type="password"
                  placeholder="PASSWORD"
                  style="
                    color: #000000 !important;
                    -webkit-text-fill-color: #000000 !important;
                  "
                  class="peer w-full bg-transparent border-b border-black/30 py-3 text-[11px] font-bold tracking-[0.2em] text-center text-black placeholder-black/50 focus:border-black focus:outline-none transition-all focus:placeholder-black/20"
                />
                <span
                  class="absolute bottom-0 left-0 w-0 h-[2px] bg-black transition-all duration-500 peer-focus:w-full"
                ></span>
              </div>
            </div>

            <!-- æŒ‰é’®ï¼šçº¯é»‘å—ï¼Œæ— åœ†è§’ -->
            <button
              @click="handleLogin"
              :disabled="loading"
              class="w-full bg-black text-white py-4 text-[10px] font-bold tracking-[0.5em] hover:bg-gray-900 active:scale-95 transition-all shadow-xl hover:shadow-2xl mt-4"
            >
              {{ loading ? 'ENTERING' : 'ENTER' }}
            </button>

            <p
              v-if="errorMsg"
              class="text-red-900 font-medium text-[10px] text-center bg-white/40 py-2 px-2 backdrop-blur-sm"
            >
              {{ errorMsg }}
            </p>
          </div>
        </div>

        <!-- åº•éƒ¨ç‰ˆæƒï¼šå¢åŠ é»‘è‰²é˜´å½±ç¡®ä¿åœ¨äº®èƒŒæ™¯ä¸Šå¯è§ -->
        <div
          class="absolute bottom-10 text-[9px] text-black tracking-[0.3em] font-serif opacity-70 mix-blend-multiply"
        >
          DESIGNED BY ANTIGRAVITY
        </div>
      </div>

      <!-- ä¸»ç•Œé¢ -->
      <div v-else class="flex-1 w-full max-w-[1920px] mx-auto relative">
        <header
          class="sticky top-0 z-40 bg-bg/90 backdrop-blur-md transition-all border-b border-gray-50"
          :class="currentTheme === 'pixel' ? 'border-b-2 border-black bg-white' : ''"
        >
          <div
            class="px-6 py-5 flex flex-col md:flex-row md:items-center justify-between gap-4"
          >
            <!-- æ ‡é¢˜åŒºåŸŸ (ä¿®æ”¹ç‰ˆ) -->
            <div class="flex items-center gap-3 select-none">
              <!-- 1. å¯ç‚¹å‡»çš„ LOGOï¼šç‚¹å‡»æ‰“å¼€ä¸»é¢˜èœå• -->
              <div
                @click="showThemeModal = true"
                class="cursor-pointer hover:opacity-60 transition-opacity flex items-center gap-2 group/logo"
                title="ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜é£æ ¼"
              >
                <h1
                  class="text-xl font-serif tracking-[0.2em] font-normal text-black group-hover/logo:text-accent transition-colors"
                >
                  åšç‰©é¦†
                </h1>
                <!-- ä¸€ä¸ªå°å›¾æ ‡æç¤ºå¯ä»¥ç‚¹ -->
                <span
                  class="text-[8px] bg-black text-white px-1 rounded opacity-0 group-hover/logo:opacity-100 transition-opacity"
                  >THEME</span
                >
              </div>

              <!-- 2. é¢åŒ…å±‘å¯¼èˆªï¼šç‚¹å‡»è¿”å›å…¨éƒ¨ -->
              <div
                v-if="currentAlbum || currentTag"
                @click="resetFilter"
                class="flex items-center gap-2 cursor-pointer hover:opacity-70 transition-opacity"
              >
                <span class="text-gray-300">/</span>

                <!-- ç›¸å†Œæ˜¾ç¤º -->
                <span
                  v-if="currentAlbum"
                  class="text-sub text-xs font-sans tracking-normal flex items-center gap-2"
                >
                  {{ currentAlbum.startsWith('.') ? currentAlbum.substring(1) :
                  currentAlbum }}
                  <button
                    @click.stop="toggleAlbumVisibility"
                    class="ml-1 px-2 py-0.5 text-[9px] rounded border border-gray-200 hover:bg-black hover:text-white hover:border-black transition-all"
                    :class="currentAlbum.startsWith('.') ? 'text-red-500 bg-red-50 border-red-100' : 'text-sub'"
                  >
                    {{ currentAlbum.startsWith('.') ? 'ğŸ”’' : 'ğŸ”“' }}
                  </button>
                </span>

                <!-- æ ‡ç­¾æ˜¾ç¤º -->
                <span
                  v-if="currentTag"
                  class="text-black bg-gray-100 px-2 py-0.5 rounded text-[10px] font-sans tracking-normal flex items-center gap-2"
                >
                  #{{ currentTag }}
                  <span class="text-gray-400 hover:text-red-500">&times;</span>
                </span>
              </div>
            </div>

            <!-- å³ä¾§å¯¼èˆª (ä¿æŒä¸å˜) -->
            <nav class="flex items-center gap-6 overflow-x-auto no-scroll pr-4">
              <template v-for="(label, key) in filterMap" :key="key">
                <button
                  @click="setFilter(key)"
                  class="text-[11px] tracking-[0.1em] font-serif transition-all duration-300 relative shrink-0"
                  :class="(filter === key && !currentTag && !currentAlbum) ? 'text-black font-bold' : 'text-sub hover:text-black'"
                >
                  {{ label }}
                  <span
                    v-if="filter === key && !currentTag && !currentAlbum"
                    class="absolute -bottom-1 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </template>
              <!-- ...å…¶ä»–æŒ‰é’®ä¿æŒä¸å˜... -->
              <button
                @click="handleLogout"
                class="text-[10px] text-gray-300 hover:text-black ml-4 shrink-0"
              >
                é€€å‡º
              </button>
            </nav>
          </div>
        </header>

        <main class="px-4 md:px-6 py-8 min-h-[80vh]">
          <div
            v-if="loading && items.length === 0"
            class="flex justify-center py-40"
          >
            <div
              class="w-5 h-5 border-2 border-gray-100 border-t-black rounded-full animate-spin"
            ></div>
          </div>

          <div v-if="currentAlbum || currentTag" class="mb-6 animate-fade-in">
            <button
              @click="resetFilter"
              class="text-[10px] tracking-widest text-gray-400 hover:text-black transition-colors flex items-center gap-2"
            >
              <span>â†</span> è¿”å›å…¨éƒ¨
            </button>
          </div>

          <div
            class="columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-6 space-y-6 pb-32 mx-auto"
          >
            <!-- ç›¸å†Œåˆ—è¡¨è§†å›¾ -->
            <template
              v-if="filter === 'albums' && !currentAlbum && !currentTag"
            >
              <div
                v-for="album in albumList"
                :key="album.realName"
                class="break-inside-avoid mb-6 cursor-pointer group animate-slide-up"
                @click="openAlbum(album.realName)"
              >
                <div class="aspect-square bg-gray-50 relative overflow-hidden">
                  <img
                    v-if="album.cover"
                    :src="album.cover"
                    @load="$event.target.classList.add('img-loaded')"
                    class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 img-loading"
                  />
                  <div
                    v-else
                    class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-300 tracking-widest"
                  >
                    æ— å°é¢
                  </div>
                </div>
                <div
                  class="mt-2 flex justify-between items-baseline border-t border-black/5 pt-2"
                >
                  <span
                    class="text-xs font-serif tracking-wider text-black flex items-center gap-1"
                  >
                    {{ album.displayName }}
                    <span
                      v-if="album.isHidden"
                      title="ä»…ç›¸å†Œå†…å¯è§"
                      class="text-[9px] text-red-300"
                      >ğŸ”’</span
                    >
                  </span>
                  <span class="text-[9px] text-gray-400 font-sans"
                    >{{ album.count }}</span
                  >
                </div>
              </div>
            </template>

            <!-- å†…å®¹åˆ—è¡¨è§†å›¾ -->
            <template v-else>
              <div
                v-for="item in filteredItems"
                :key="item.id"
                class="break-inside-avoid mb-8 group relative animate-slide-up"
              >
                <!-- æ‚¬æµ®æ“ä½œæŒ‰é’® (ä¿æŒä¸å˜ï¼Œä½†èƒŒæ™¯æ”¹ä¸ºè·Ÿéšé¢æ¿é¢œè‰²) -->
                <div
                  class="absolute top-2 right-2 z-20 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300"
                >
                  <button
                    @click.stop="handleEdit(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    <!-- SVG icons ä¿æŒä¸å˜ -->
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    @click.stop="handleDownload(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-black shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                      ></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                  <button
                    @click.stop="deleteItem(item)"
                    class="w-6 h-6 bg-panel/90 backdrop-blur rounded-full flex items-center justify-center text-gray-400 hover:text-red-600 shadow-sm border border-border hover:scale-110 transition-transform"
                  >
                    &times;
                  </button>
                </div>
                <!-- Role Card HTML -->
                <div
                  v-if="item.type === 'role_card'"
                  class="group/role relative border border-border bg-panel hover:shadow-lg transition-all duration-300 rounded-xl overflow-hidden"
                >
                  <!-- å°é¢åŒºåŸŸ (ä¿®æ”¹ä¸º 3D ç¿»è½¬ç»“æ„) -->
                  <div
                    class="aspect-[2/3] relative perspective-1000 bg-gray-50"
                  >
                    <!-- ç¿»è½¬å®¹å™¨ï¼šæ ¹æ®çŠ¶æ€æ·»åŠ  rotate-y-180 ç±» -->
                    <div
                      class="w-full h-full transition-all duration-700 preserve-3d relative"
                      :class="{ 'rotate-y-180': flippedCards[item.id] }"
                    >
                      <!-- Aé¢ï¼šå›¾ç‰‡ (æ­£é¢) -->
                      <div
                        class="absolute inset-0 backface-hidden cursor-zoom-in z-10"
                        @click="openLightbox(item.file_url)"
                      >
                        <img
                          v-if="item.file_url"
                          :src="item.file_url"
                          loading="lazy"
                          class="w-full h-full object-cover transition-transform duration-700 group-hover/role:scale-105"
                        />
                        <div
                          v-else
                          class="w-full h-full flex items-center justify-center text-gray-300 text-[10px] bg-gray-100"
                        >
                          NO IMAGE
                        </div>
                      </div>

                      <!-- Bé¢ï¼šä»‹ç» (èƒŒé¢) -->
                      <div
                        class="absolute inset-0 backface-hidden card-back-content p-5 overflow-y-auto custom-scrollbar flex flex-col z-20"
                      >
                        <h4
                          class="text-xs font-bold mb-3 border-b border-black/10 pb-2 text-black font-serif"
                        >
                          è§’è‰²ä»‹ç»
                        </h4>
                        <p
                          class="text-[11px] leading-relaxed text-sub whitespace-pre-wrap font-serif text-justify"
                        >
                          {{ getRoleCardData(item).description || 'æš‚æ— ä»‹ç»...'
                          }}
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- ä¿¡æ¯åŒºåŸŸ -->
                  <div class="p-4 relative z-30 bg-panel">
                    <!-- ä¿®æ”¹ï¼šæ ‡é¢˜å¢åŠ ç‚¹å‡»äº‹ä»¶å’Œæ‰‹å‹å…‰æ ‡ -->
                    <h3
                      class="text-sm font-bold text-black font-serif mb-1 truncate cursor-pointer hover:text-accent hover:underline underline-offset-4 transition-colors select-none"
                      @click.stop="toggleFlip(item.id)"
                      title="ç‚¹å‡»æŸ¥çœ‹ä»‹ç»"
                    >
                      {{ getRoleCardData(item).name }}
                      <span class="text-[9px] font-normal text-gray-400 ml-1"
                        >â†º</span
                      >
                    </h3>

                    <!-- === ä¿®æ”¹å¼€å§‹ï¼šæ–°å¢æ ‡ç­¾å’Œæ—¥æœŸçš„ç»„åˆè¡Œ === -->
                    <div class="flex justify-between items-start mb-3 mt-1">
                      <!-- å·¦ä¾§ï¼šæ ‡ç­¾åˆ—è¡¨ -->
                      <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <!-- å³ä¾§ï¼šæ—¥æœŸ -->
                      <p class="text-[9px] text-sub shrink-0 ml-2">
                        {{ getRoleCardData(item).history.length > 0 ?
                        formatDate(getRoleCardData(item).history[0].date) :
                        formatDate(item.created_at) }}
                      </p>
                    </div>
                    <!-- === ä¿®æ”¹ç»“æŸ === -->

                    <div
                      class="flex items-center gap-2 mt-2 pt-3 border-t border-border/50"
                    >
                      <button
                        @click.stop="downloadRoleCardPackage(item)"
                        class="flex-1 py-1.5 rounded bg-gray-100 hover:bg-black hover:text-white transition-colors text-[10px] tracking-widest"
                      >
                        PACKAGE
                      </button>
                      <button
                        @click.stop="openHistoryModal(item)"
                        class="w-8 h-8 flex items-center justify-center rounded bg-gray-100 hover:bg-black hover:text-white transition-colors text-black"
                      >
                        ğŸ•’
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Text Card -->
                <div
                  v-if="item.type === 'text'"
                  @click="toggleTextExpand(item.id)"
                  class="relative border border-border bg-panel shadow-sm hover:shadow-md transition-all duration-500 rounded-xl overflow-hidden cursor-pointer group/text"
                  :class="expandedTextItems[item.id] ? 'h-auto' : 'max-h-[200px]'"
                >
                  <div class="p-6">
                    <!-- å†…å®¹åŒºåŸŸ -->
                    <p
                      class="font-serif text-[13px] leading-7 text-black whitespace-pre-wrap tracking-wide transition-all duration-500"
                    >
                      {{ item.content }}
                    </p>

                    <!-- åº•éƒ¨ä¿¡æ¯æ  (æ ‡ç­¾å’Œæ—¥æœŸ) -->
                    <div
                      class="mt-4 flex justify-between items-center pt-3 border-t border-border/50"
                      :class="{ 'opacity-100': expandedTextItems[item.id], 'opacity-50': !expandedTextItems[item.id] }"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[70%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>

                  <!-- æ¸å˜é®ç½© (ä»…åœ¨æœªå±•å¼€æ—¶æ˜¾ç¤º) -->
                  <div
                    v-if="!expandedTextItems[item.id]"
                    class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-panel via-panel/80 to-transparent pointer-events-none flex items-end justify-center pb-2"
                  >
                    <!-- ä¸€ä¸ªå°ç®­å¤´æç¤º -->
                    <span class="text-black/30 text-xs animate-bounce">â†“</span>
                  </div>
                </div>

                <!-- Image Card -->
                <div v-if="item.type === 'image'" class="relative">
                  <!-- å›¾ç‰‡å®¹å™¨èƒŒæ™¯ä¹Ÿæ”¹ä¸ºé€æ˜æˆ–é¢æ¿è‰² -->
                  <div
                    class="overflow-hidden bg-gray-50/50 rounded-xl cursor-zoom-in"
                    @click="openLightbox(item.file_url)"
                  >
                    <img
                      :src="item.file_url"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-auto block grayscale-[0.1] group-hover:grayscale-0 transition-all duration-700 ease-out img-loading rounded-xl"
                    />
                  </div>
                  <div class="mt-3 px-1">
                    <h3
                      v-if="getRealContent(item)"
                      class="text-xs font-serif text-black mb-1"
                    >
                      {{ getRealContent(item) }}
                    </h3>
                    <div
                      class="mt-2 flex justify-between items-end border-t border-border/50 pt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans ml-2 shrink-0"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Beautify Card -->
                <div
                  v-if="item.type === 'beautify'"
                  class="relative border border-border bg-panel hover:shadow-lg transition-all duration-300 rounded-xl overflow-hidden"
                >
                  <div
                    class="overflow-hidden bg-gray-50 cursor-zoom-in relative aspect-[9/16]"
                    @click="openLightbox(getBeautifyPreview(item))"
                  >
                    <img
                      :src="getBeautifyPreview(item)"
                      loading="lazy"
                      @load="$event.target.classList.add('img-loaded')"
                      class="w-full h-full object-cover transition-all duration-500 img-loading"
                    />
                    <div
                      class="absolute top-2 left-2 bg-black/50 backdrop-blur px-2 py-1 rounded"
                    >
                      <span class="text-[9px] text-white tracking-widest"
                        >ç¾åŒ–</span
                      >
                    </div>
                  </div>
                  <div class="p-4">
                    <div class="flex justify-between items-start mb-3 gap-2">
                      <h3
                        class="text-xs font-serif text-black font-bold pt-1 break-all"
                      >
                        {{ getBeautifyData(item).title }}
                      </h3>
                      <button
                        @click.stop="exportBeautifyPackage(item)"
                        class="text-sub hover:text-black transition-colors p-1 shrink-0"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                          <polyline points="7 10 12 15 17 10" />
                          <line x1="12" y1="15" x2="12" y2="3" />
                          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                        </svg>
                      </button>
                    </div>

                    <div class="flex items-center gap-3 mb-3 flex-wrap">
                      <div
                        v-for="(variant, idx) in getBeautifyData(item).variations"
                        :key="idx"
                        @click.stop="setBeautifyIndex(item.id, idx)"
                        class="color-dot border-border"
                        :class="{ active: getBeautifyIndex(item.id) === idx }"
                        :style="{ backgroundColor: variant.color }"
                      ></div>
                    </div>

                    <div
                      class="flex justify-between items-center pt-2 border-t border-border/50 mt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          @click.stop="selectTag(tag)"
                          class="text-[9px] tracking-widest text-sub uppercase cursor-pointer tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Chat Card -->
                <div
                  v-if="item.type === 'chat'"
                  class="cursor-pointer group/chat border border-border bg-panel hover:shadow-lg transition-all duration-300 relative rounded-xl overflow-hidden"
                  @click="handleDownload(item)"
                >
                  <div
                    class="aspect-[4/3] bg-gray-50/50 flex flex-col items-center justify-center border-b border-border relative overflow-hidden"
                  >
                    <div
                      class="text-sub group-hover/chat:text-black transition-colors duration-500 transform group-hover/chat:scale-110"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                        ></path>
                      </svg>
                    </div>
                    <span
                      class="mt-2 text-[9px] tracking-[0.2em] text-sub uppercase font-serif"
                      >Chat Log</span
                    >
                  </div>
                  <div class="p-4">
                    <h3
                      class="text-xs font-serif text-black leading-relaxed line-clamp-2"
                    >
                      {{ item.content || 'æœªå‘½åè®°å½•' }}
                    </h3>
                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- HTML Card -->
                <div
                  v-if="item.type === 'html'"
                  @click="handleOpenHtml(item)"
                  class="cursor-pointer group/html border border-border p-1 bg-panel hover:shadow-lg transition-shadow rounded-xl overflow-hidden"
                >
                  <div
                    class="w-full aspect-[4/3] bg-gray-50/30 relative flex flex-col items-center justify-center rounded-lg"
                  >
                    <span class="font-serif text-sub/50 text-3xl">HTML</span>
                  </div>
                  <div class="p-3">
                    <h3 class="text-xs font-medium text-black truncate">
                      {{ getRealContent(item) || 'ç½‘é¡µå¿«ç…§' }}
                    </h3>
                    <div
                      class="mt-2 flex justify-between items-end border-t border-border/50 pt-2"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Link Card -->
                <div
                  v-if="item.type === 'link'"
                  class="cursor-pointer group/link rounded-xl overflow-hidden"
                  @click="openLink(item.file_url)"
                >
                  <div
                    class="bg-panel p-5 border border-border hover:border-black transition-colors duration-300"
                  >
                    <div class="flex items-start justify-between mb-3">
                      <span class="text-lg font-serif italic text-sub"
                        >Link</span
                      >
                      <span
                        class="text-[10px] opacity-0 group-hover/link:opacity-100 transition-opacity text-black"
                        >â†—</span
                      >
                    </div>
                    <h3
                      class="text-xs font-medium text-black leading-relaxed line-clamp-2"
                    >
                      {{ getRealContent(item) || item.file_url }}
                    </h3>
                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans"
                        >{{ formatDate(item.created_at) }}</span
                      >
                    </div>
                  </div>
                </div>
                <!-- === æ–°å¢ï¼šFont Card === -->
                <div
                  v-if="item.type === 'font'"
                  class="cursor-pointer group/font border border-border bg-panel hover:shadow-lg transition-all duration-300 rounded-xl overflow-hidden"
                  @click="handleDownload(item)"
                >
                  <!-- é¢„è§ˆåŒºåŸŸï¼šä½¿ç”¨åŠ¨æ€åŠ è½½çš„å­—ä½“ -->
                  <div
                    class="aspect-[4/3] bg-gray-50/50 flex flex-col items-center justify-center relative overflow-hidden p-4"
                  >
                    <!-- è¿™é‡Œçš„ fontFamily å¯¹åº” JS ä¸­ç”Ÿæˆçš„åç§° -->
                    <span
                      class="text-4xl md:text-5xl text-black transition-transform duration-500 group-hover/font:scale-110 text-center break-all leading-tight"
                      :style="{ fontFamily: `'font_${item.id}', sans-serif` }"
                    >
                      {{ item.content || 'Aa' }}
                    </span>

                    <!-- è£…é¥°èƒŒæ™¯å­— -->
                    <span
                      class="absolute text-[8rem] text-black/5 font-serif select-none -z-10 pointer-events-none"
                      >Aa</span
                    >
                  </div>

                  <!-- ä¿¡æ¯åŒºåŸŸ -->
                  <div class="p-4 border-t border-border">
                    <!-- ä¿®æ”¹åä»£ç  -->
                    <div class="flex items-center justify-between mb-1">
                      <span
                        class="text-[9px] tracking-[0.2em] text-sub uppercase font-serif"
                        >FONT</span
                      >
                      <!-- ä¿®æ”¹å¼€å§‹ï¼šæ”¹ä¸ºåº”ç”¨æŒ‰é’® -->
                      <button
                        @click.stop="applyFont(item)"
                        class="text-[9px] px-2 py-0.5 border rounded transition-all z-20 relative"
                        :class="currentGlobalFontId === item.id ? 'bg-black text-white border-black' : 'border-gray-200 text-sub hover:border-black hover:text-black'"
                      >
                        {{ currentGlobalFontId === item.id ? 'å·²åº”ç”¨' : 'åº”ç”¨'
                        }}
                      </button>
                      <!-- ä¿®æ”¹ç»“æŸ -->
                    </div>
                    <h3
                      class="text-xs font-medium text-black truncate font-sans"
                    >
                      {{ item.content || 'æœªå‘½åå­—ä½“' }}
                    </h3>

                    <div
                      class="flex justify-between items-center mt-3 pt-2 border-t border-border/50"
                    >
                      <div class="flex flex-wrap gap-1.5 max-w-[65%]">
                        <span
                          v-for="tag in getTags(item)"
                          :key="tag"
                          class="text-[9px] tracking-widest text-sub uppercase tag-link"
                          >#{{ tag }}</span
                        >
                      </div>
                      <span class="text-[9px] text-sub font-sans">
                        {{ formatDate(item.created_at) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </main>

        <!-- æ‚¬æµ®ä¸Šä¼ æŒ‰é’® -->
        <button
          @click="showUpload = true"
          class="fixed right-10 w-12 h-12 bg-black text-white flex items-center justify-center hover:scale-105 transition-transform duration-300 z-30 shadow-xl rounded-full safe-bottom"
        >
          <span class="text-xl font-light pb-1">+</span>
        </button>

        <!-- ç¯ç®± (Lightbox) -->
        <div
          v-if="lightboxImage"
          class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center animate-fade-in fullscreen-layer"
          @click="closeLightbox"
        >
          <div
            class="absolute top-6 right-6 text-white/50 hover:text-white cursor-pointer p-4 text-sm tracking-widest"
            style="margin-top: env(safe-area-inset-top)"
          >
            CLOSE &times;
          </div>
          <img
            :src="lightboxImage"
            @load="$event.target.classList.add('img-loaded')"
            class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl select-none transition-transform img-loading"
            @click.stop
          />
        </div>

        <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
        <div
          v-if="showExport"
          class="fixed inset-0 z-[100] flex items-center justify-center p-0 md:p-6 fullscreen-layer"
        >
          <!-- èƒŒæ™¯é®ç½© -->
          <div
            @click="closeExport"
            class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-all"
          ></div>

          <!-- ä¸»å¼¹çª—å®¹å™¨ï¼šç§»åŠ¨ç«¯å…¨å± Flexï¼Œç¦æ­¢æ•´ä½“æ»šåŠ¨ -->
          <div
            class="bg-white w-full h-full md:h-[90vh] md:max-w-5xl md:rounded-2xl shadow-2xl relative z-10 animate-slide-up flex flex-col md:flex-row overflow-hidden"
          >
            <!-- =========================
                 1. é¢„è§ˆåŒº (Preview) - ä¿®æ”¹ç‰ˆï¼šæ”¯æŒç¼©æ”¾
            ========================== -->
            <div
              class="relative bg-[#E5E7EB] md:bg-[#F0F2F5] flex-col items-center justify-start h-[45vh] md:h-auto md:flex-1 shrink-0 order-1 md:order-1 border-b md:border-b-0 md:border-r border-gray-200 group/preview"
            >
              <!-- æ ¸å¿ƒä¿®å¤ï¼šç»å¯¹å®šä½æ’‘æ»¡åŒºåŸŸ -->
              <div
                class="absolute inset-0 overflow-auto p-4 md:p-10 custom-scrollbar flex flex-col items-center"
              >
                <!-- 
                  ä¿®æ”¹ç‚¹ï¼š
                  1. ç§»é™¤ max-w-full h-autoï¼Œé˜²æ­¢è¢«å¼ºåˆ¶å‹ç¼©
                  2. å¢åŠ  style ç»‘å®šï¼Œé€šè¿‡ previewScale æ§åˆ¶æ˜¾ç¤ºå®½åº¦
                -->
                <canvas
                  ref="quoteCanvas"
                  class="block shadow-2xl bg-white transition-all duration-200 origin-top"
                  :style="{
                    width: previewScale + '%',
                    height: 'auto'
                  }"
                  @click.stop
                ></canvas>

                <!-- åº•éƒ¨å«ç‰‡ï¼Œé˜²æ­¢é•¿å›¾åº•éƒ¨è¢«é®æŒ¡ -->
                <div class="h-20 shrink-0 w-full"></div>
              </div>

              <!-- æ–°å¢ï¼šç¼©æ”¾æ§åˆ¶æ»‘å— (æ‚¬æµ®åœ¨åº•éƒ¨ä¸­é—´) -->
              <div
                class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur text-white px-4 py-2 rounded-full flex items-center gap-3 shadow-xl opacity-0 group-hover/preview:opacity-100 transition-opacity z-30"
              >
                <span
                  class="text-[9px] font-bold tracking-widest cursor-pointer hover:text-gray-300"
                  @click="previewScale = Math.max(10, previewScale - 10)"
                  >-</span
                >
                <input
                  type="range"
                  v-model="previewScale"
                  min="10"
                  max="150"
                  step="5"
                  class="w-24 h-1 bg-gray-500 rounded-lg appearance-none cursor-pointer accent-white"
                />
                <span
                  class="text-[9px] font-bold tracking-widest cursor-pointer hover:text-gray-300"
                  @click="previewScale = Math.min(150, previewScale + 10)"
                  >+</span
                >
                <span class="text-[9px] w-8 text-right font-mono"
                  >{{ previewScale }}%</span
                >

                <!-- é‡ç½®æŒ‰é’® -->
                <button
                  @click="previewScale = 60"
                  class="ml-2 text-[9px] border border-white/30 px-1.5 rounded hover:bg-white hover:text-black transition-colors"
                  title="é‡ç½®ç¼©æ”¾"
                >
                  R
                </button>
              </div>

              <!-- ç§»åŠ¨ç«¯å…³é—­æŒ‰é’® (æµ®åŠ¨åœ¨å³ä¸Šè§’) -->
              <button
                @click="closeExport"
                class="absolute top-4 right-4 md:hidden w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-md z-20 hover:bg-black/60 active:scale-95"
              >
                &times;
              </button>
            </div>

            <!-- =========================
                 2. æ“ä½œåŒº (Controls)
                 å æ®å‰©ä½™é«˜åº¦ï¼Œå†…éƒ¨ç‹¬ç«‹æ»šåŠ¨
            ========================== -->
            <div
              class="bg-white w-full md:w-96 flex flex-col order-2 md:order-2 flex-1 md:flex-none h-[55vh] md:h-auto"
            >
              <!-- æ ‡é¢˜æ  (PCæ˜¾ç¤º) -->
              <div
                class="hidden md:flex p-5 border-b border-gray-100 justify-between items-center bg-white sticky top-0 z-10"
              >
                <span class="text-xs font-bold tracking-widest uppercase"
                  >Export Settings</span
                >
                <button
                  @click="closeExport"
                  class="text-lg w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors"
                >
                  &times;
                </button>
              </div>

              <!-- æ»šåŠ¨æ“ä½œåŒº -->
              <div
                class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-8"
              >
                <!-- A. é£æ ¼é€‰æ‹© -->
                <div>
                  <div class="flex justify-between items-center mb-3">
                    <p
                      class="text-[10px] text-gray-400 tracking-widest uppercase font-bold"
                    >
                      STYLE
                    </p>
                    <span
                      class="text-[10px] font-serif italic text-black bg-gray-100 px-2 py-0.5 rounded"
                      >{{ styles[exportStyle].name }}</span
                    >
                  </div>
                  <div class="grid grid-cols-6 gap-3">
                    <button
                      v-for="(s, k) in styles"
                      :key="k"
                      @click="changeExportStyle(k)"
                      class="style-btn w-9 h-9 rounded-full border border-gray-200 shadow-sm transition-transform active:scale-95"
                      :class="{active: exportStyle === k}"
                      :style="{background: s.btnColor}"
                      :title="s.name"
                    ></button>
                  </div>
                </div>

                <!-- B. æ’ç‰ˆæ§åˆ¶ -->
                <div>
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-3 uppercase font-bold"
                  >
                    TYPOGRAPHY
                  </p>
                  <div
                    class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100"
                  >
                    <!-- å­—ä½“é€‰æ‹© -->
                    <div class="space-y-1.5">
                      <label class="text-[9px] text-gray-500 font-bold"
                        >FONT</label
                      >
                      <div class="relative">
                        <select
                          v-model="exportSettings.fontFamily"
                          @change="drawCard"
                          class="w-full appearance-none bg-white border border-gray-200 text-[11px] py-2 px-3 rounded focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                        >
                          <option value="default">é»˜è®¤ (Default)</option>
                          <option
                            v-for="font in fontList"
                            :key="font.id"
                            :value="font.id"
                          >
                            {{ font.content || 'æœªå‘½åå­—ä½“' }}
                          </option>
                        </select>
                        <div
                          class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500"
                        >
                          <svg
                            class="w-3 h-3"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 9l-7 7-7-7"
                            ></path>
                          </svg>
                        </div>
                      </div>
                    </div>

                    <!-- å¯¹é½æ–¹å¼ -->
                    <div class="space-y-1.5">
                      <label class="text-[9px] text-gray-500 font-bold"
                        >ALIGN</label
                      >
                      <div
                        class="flex bg-white rounded border border-gray-200 p-0.5"
                      >
                        <button
                          v-for="align in ['left', 'center', 'right']"
                          :key="align"
                          @click="exportSettings.textAlign = align; drawCard()"
                          class="flex-1 py-1.5 text-[10px] rounded transition-colors capitalize"
                          :class="exportSettings.textAlign === align ? 'bg-black text-white shadow-sm' : 'text-gray-400 hover:text-black'"
                        >
                          {{ align }}
                        </button>
                      </div>
                    </div>

                    <!-- å­—ä½“å¤§å°æ»‘å— -->
                    <div class="space-y-2 pt-1">
                      <div class="flex justify-between items-center">
                        <label class="text-[9px] text-gray-500 font-bold"
                          >SIZE</label
                        >
                        <span
                          class="text-[9px] font-mono bg-white px-1.5 rounded border border-gray-100"
                          >{{ exportSettings.fontSize }}px</span
                        >
                      </div>
                      <input
                        type="range"
                        v-model="exportSettings.fontSize"
                        @input="drawCard"
                        min="20"
                        max="80"
                        step="2"
                        class="w-full accent-black h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                    </div>

                    <!-- è¡Œé«˜æ»‘å— -->
                    <div class="space-y-2 pt-1">
                      <div class="flex justify-between items-center">
                        <label class="text-[9px] text-gray-500 font-bold"
                          >LINE HEIGHT</label
                        >
                        <span
                          class="text-[9px] font-mono bg-white px-1.5 rounded border border-gray-100"
                          >{{ exportSettings.lineHeight }}px</span
                        >
                      </div>
                      <input
                        type="range"
                        v-model="exportSettings.lineHeight"
                        @input="drawCard"
                        min="30"
                        max="150"
                        step="2"
                        class="w-full accent-black h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                    </div>
                  </div>
                </div>

                <!-- C. åŠ¨ä½œæŒ‰é’® (åº•éƒ¨ç•™ç™½é˜²æ­¢ç”±äºå®‰å…¨åŒºé®æŒ¡) -->
                <div class="pb-10">
                  <p
                    class="text-[10px] text-gray-400 tracking-widest mb-3 uppercase font-bold"
                  >
                    ACTIONS
                  </p>
                  <div class="grid grid-cols-2 gap-3">
                    <button
                      @click="downloadAsText"
                      class="py-3 border border-gray-200 text-black text-[10px] font-bold tracking-widest rounded-lg hover:bg-gray-50 active:scale-95 transition-all"
                    >
                      COPY TEXT
                    </button>
                    <button
                      @click="downloadAsImage"
                      class="py-3 bg-black text-white text-[10px] font-bold tracking-widest rounded-lg shadow-lg hover:bg-gray-800 active:scale-95 transition-all"
                    >
                      SAVE IMAGE
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ä¸Šä¼ /ç¼–è¾‘ æ¨¡æ€æ¡† -->
        <!-- è§’è‰²å¡å†å²è®°å½•æ¨¡æ€æ¡† -->
        <div
          v-if="showHistoryModal && currentHistoryItem"
          class="fixed inset-0 z-[110] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="showHistoryModal = false; currentHistoryItem = null"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>

          <div
            class="bg-white w-full max-w-md shadow-2xl border border-gray-100 relative z-10 animate-slide-up flex flex-col max-h-[80vh] rounded-xl overflow-hidden"
          >
            <div
              class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"
            >
              <div>
                <h3
                  class="text-xs font-bold font-serif tracking-widest text-black"
                >
                  VERSION HISTORY
                </h3>
                <p class="text-[9px] text-sub mt-0.5">
                  {{ getRoleCardData(currentHistoryItem).name }}
                </p>
              </div>
              <button
                @click="showHistoryModal = false"
                class="text-xl hover:text-red-500"
              >
                &times;
              </button>
            </div>
            <!-- ä¿®æ”¹åçš„æ—¶é—´è½´å®¹å™¨ï¼šé™åˆ¶é«˜åº¦å¹¶å…è®¸æ»šåŠ¨ -->
            <div
              class="overflow-y-auto p-0 custom-scrollbar"
              style="max-height: 60vh"
            >
              <div
                v-if="!getRoleCardData(currentHistoryItem).history?.length"
                class="p-8 text-center text-[10px] text-gray-400"
              >
                æš‚æ— å†å²è®°å½•
              </div>

              <!-- æ—¶é—´è½´åˆ—è¡¨ -->
              <div v-else class="relative pb-6">
                <!-- å·¦ä¾§çº¿æ¡ -->
                <div
                  class="absolute left-6 top-0 bottom-0 w-px bg-gray-100"
                ></div>

                <div
                  v-for="(ver, idx) in getRoleCardData(currentHistoryItem).history"
                  :key="idx"
                  class="relative pl-12 pr-6 py-6 border-b border-gray-50 hover:bg-gray-50/50 transition-colors group"
                >
                  <!-- æ—¶é—´ç‚¹ -->
                  <div
                    class="absolute left-[21px] top-8 w-1.5 h-1.5 rounded-full border border-white shadow-sm"
                    :class="idx === 0 ? 'bg-green-500 ring-2 ring-green-100' : 'bg-gray-300'"
                  ></div>

                  <div class="flex flex-col mb-3">
                    <span
                      class="text-[10px] font-bold tracking-widest"
                      :class="idx === 0 ? 'text-green-600' : 'text-gray-500'"
                    >
                      {{ formatDate(ver.date) }} {{ idx === 0 ? '(LATEST)' : ''
                      }}
                    </span>
                    <!-- æ–°å¢ï¼šæ˜¾ç¤ºæ›´æ–°æ—¥å¿— -->
                    <div
                      v-if="ver.note"
                      class="mt-1.5 p-2 bg-gray-100 rounded text-[10px] text-gray-600 leading-relaxed font-serif"
                    >
                      {{ ver.note }}
                    </div>
                  </div>

                  <div class="flex gap-2">
                    <!-- é¢„è§ˆå°å›¾ -->
                    <div
                      class="w-12 h-16 bg-gray-100 rounded overflow-hidden shrink-0 border border-gray-200 cursor-pointer hover:border-black transition-colors"
                      @click="openLightbox(ver.png)"
                    >
                      <img :src="ver.png" class="w-full h-full object-cover" />
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex flex-col gap-2 flex-1">
                      <button
                        @click="downloadSingleFile(ver.png, `${getRoleCardData(currentHistoryItem).name}_${formatDate(ver.date)}.png`)"
                        class="flex items-center justify-between px-3 py-1.5 bg-white border border-gray-200 rounded hover:border-black hover:bg-black hover:text-white transition-all text-[10px]"
                      >
                        <span>PNG Card</span>
                        <span class="text-[9px] opacity-50">â†“</span>
                      </button>

                      <button
                        @click="downloadRoleCardPackage(currentHistoryItem, ver)"
                        class="flex items-center justify-between px-3 py-1.5 bg-white border border-gray-200 rounded hover:border-black hover:bg-black hover:text-white transition-all text-[10px]"
                      >
                        <span>Full Package (.zip)</span>
                        <span class="text-[9px] opacity-50">ZIP</span>
                      </button>
                    </div>
                  </div>

                  <div class="mt-2 flex gap-2 text-[9px] text-gray-300">
                    <span v-if="ver.json" class="text-blue-400">JSON âœ“</span>
                    <span v-if="ver.qr" class="text-purple-400">QR âœ“</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          v-if="showUpload"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 fullscreen-layer"
        >
          <div
            @click="showUpload = false; editingId = null;"
            class="absolute inset-0 bg-white/90 backdrop-blur-md transition-all"
          ></div>
          <div
            class="bg-white w-full max-w-md shadow-2xl border border-gray-100 relative z-10 animate-slide-up flex flex-col max-h-[90vh]"
          >
            <div
              class="px-8 py-6 border-b border-gray-50 flex justify-between items-center"
            >
              <span class="text-[10px] tracking-[0.2em] font-bold uppercase"
                >{{ editingId ? 'ç¼–è¾‘å†…å®¹' : 'å…¥åº“' }}</span
              >
              <button
                @click="showUpload = false; editingId = null;"
                class="text-lg text-gray-300 hover:text-black"
              >
                &times;
              </button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto">
              <div
                class="flex gap-6 border-b border-gray-100 pb-px overflow-x-auto no-scroll"
              >
                <button
                  v-for="(label, key) in uploadTypes"
                  :key="key"
                  @click="!editingId && (uploadForm.type = key)"
                  class="text-[10px] tracking-widest pb-3 transition-all relative shrink-0"
                  :class="[
                    uploadForm.type === key ? 'text-black' : 'text-gray-400',
                    editingId ? 'cursor-not-allowed opacity-50' : 'hover:text-gray-600'
                  ]"
                >
                  {{ label }}<span
                    v-if="uploadForm.type === key"
                    class="absolute bottom-0 left-0 w-full h-[1px] bg-black"
                  ></span>
                </button>
              </div>

              <div class="space-y-4">
                <!-- === ä¿®æ”¹å¼€å§‹ï¼šæ ‡ç­¾è¾“å…¥æ¡†æ”¹ä¸ºå¸¦è”æƒ³åŠŸèƒ½çš„å®¹å™¨ === -->
                <div class="relative group/tag-input">
                  <input
                    v-model="uploadForm.category"
                    type="text"
                    placeholder="æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€)"
                    class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                    @input="showTagList = true"
                    @focus="showTagList = true"
                    @blur="setTimeout(() => showTagList = false, 200)"
                  />

                  <!-- è”æƒ³èœå•ä¸‹æ‹‰åˆ—è¡¨ -->
                  <div
                    v-if="showTagList && tagSuggestions.length > 0"
                    class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-100 shadow-xl max-h-40 overflow-y-auto z-50 rounded-sm"
                  >
                    <div
                      v-for="tag in tagSuggestions"
                      :key="tag"
                      @click="applyTagSuggestion(tag)"
                      class="px-4 py-2 text-[10px] text-gray-500 hover:bg-black hover:text-white cursor-pointer transition-colors border-b border-gray-50 last:border-0 flex justify-between items-center"
                    >
                      <span># {{ tag }}</span>
                      <span class="text-[9px] opacity-50">TAB</span>
                    </div>
                  </div>
                </div>
                <!-- === ä¿®æ”¹ç»“æŸ === -->
                <!-- é€šç”¨æ ‡é¢˜/é“¾æ¥è¾“å…¥ -->
                <input
                  v-if="uploadForm.type !== 'text' && uploadForm.type !== 'role_card'"
                  v-model="uploadForm.title"
                  type="text"
                  :placeholder="uploadForm.type === 'beautify' ? 'ç¾åŒ–ä¸»é¢˜åç§° (å¦‚: iOSå›¾æ ‡åŒ…)' : 'æ ‡é¢˜ (å¯é€‰)'"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <input
                  v-if="uploadForm.type === 'link'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="é“¾æ¥åœ°å€ (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>
              <!-- === æ–°å¢ï¼šç±»å‹ï¼šè§’è‰²å¡ === -->
              <div
                v-if="uploadForm.type === 'role_card'"
                class="space-y-4 pt-2"
              >
                <input
                  v-model="roleCardForm.name"
                  type="text"
                  placeholder="è§’è‰²åç§°"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
                <!-- === æ–°å¢ï¼šè§’è‰²ä»‹ç»è¾“å…¥æ¡† === -->
                <textarea
                  v-model="roleCardForm.description"
                  rows="4"
                  placeholder="è§’è‰²ä»‹ç» / èƒŒæ™¯æ•…äº‹ (æ˜¾ç¤ºåœ¨å¡ç‰‡èƒŒé¢ï¼Œæ”¯æŒæ¢è¡Œ)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all resize-none custom-scrollbar"
                ></textarea>
                <!-- === ç»“æŸ === -->

                <!-- æ–°å¢ï¼šæ›´æ–°æ—¥å¿—è¾“å…¥æ¡† -->
                <textarea
                  v-model="roleCardForm.note"
                  rows="2"
                  placeholder="æ›´æ–°æ—¥å¿— (ä¾‹å¦‚: v1.2 ä¿®å¤äº†æ‰‹éƒ¨ç»†èŠ‚...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all resize-none"
                ></textarea>

                <!-- PNG å¡é¢ (å¿…å¡«/å°é¢) -->
                <div class="relative">
                  <label
                    class="text-[9px] text-sub uppercase tracking-widest mb-1 block"
                    >è§’è‰²å¡å›¾ (PNG) <span class="text-red-400">*</span></label
                  >
                  <input
                    type="file"
                    accept="image/png,image/jpeg"
                    @change="e => roleCardForm.pngFile = e.target.files[0]"
                    class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:bg-gray-100 file:text-black hover:file:bg-gray-200"
                  />
                </div>

                <!-- JSON æ•°æ® (å¯é€‰) -->
                <div class="relative">
                  <label
                    class="text-[9px] text-sub uppercase tracking-widest mb-1 block"
                    >æ•°æ®æ–‡ä»¶ (JSON)
                    <span class="text-gray-300">å¯é€‰</span></label
                  >
                  <input
                    type="file"
                    accept=".json"
                    @change="e => roleCardForm.jsonFile = e.target.files[0]"
                    class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:bg-gray-100 file:text-black hover:file:bg-gray-200"
                  />
                </div>

                <!-- QR ç  (å¯é€‰) -->
                <div class="relative">
                  <label
                    class="text-[9px] text-sub uppercase tracking-widest mb-1 block"
                    >äºŒç»´ç  (QR) <span class="text-gray-300">å¯é€‰</span></label
                  >
                  <input
                    type="file"
                    accept="image/*"
                    @change="e => roleCardForm.qrFile = e.target.files[0]"
                    class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:bg-gray-100 file:text-black hover:file:bg-gray-200"
                  />
                </div>

                <p class="text-[9px] text-gray-400 pt-2">
                  æç¤ºï¼šæ¯æ¬¡ä¸Šä¼ æ–°æ–‡ä»¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¶é—´è½´èŠ‚ç‚¹ã€‚
                </p>
              </div>
              <!-- === æ–°å¢ï¼šç±»å‹ï¼šå­—ä½“ === -->
              <div v-if="uploadForm.type === 'font'" class="space-y-4 pt-2">
                <!-- å­—ä½“åç§°è¾“å…¥ -->
                <input
                  v-model="uploadForm.content"
                  type="text"
                  placeholder="å­—ä½“åç§° (ç”¨äºé¢„è§ˆæ˜¾ç¤º)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />

                <!-- æ¥æºé€‰æ‹©å¼€å…³ -->
                <div class="flex gap-4 border-b border-gray-100 pb-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="radio"
                      v-model="uploadForm.fontSourceType"
                      value="file"
                      class="accent-black"
                    />
                    <span class="text-[10px] text-sub">ä¸Šä¼ æ–‡ä»¶</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="radio"
                      v-model="uploadForm.fontSourceType"
                      value="url"
                      class="accent-black"
                    />
                    <span class="text-[10px] text-sub">å¤–éƒ¨é“¾æ¥</span>
                  </label>
                </div>

                <!-- é€‰é¡¹A: ä¸Šä¼ æ–‡ä»¶ -->
                <div
                  v-if="uploadForm.fontSourceType === 'file' && !editingId"
                  class="border border-dashed border-gray-200 h-24 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
                >
                  <input
                    type="file"
                    @change="handleFileSelect"
                    accept=".ttf,.otf,.woff,.woff2"
                    class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  />
                  <span
                    class="text-xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                    >+</span
                  >
                  <span
                    class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >
                    {{ uploadForm.files.length > 0 ? uploadForm.files[0].name :
                    'é€‰æ‹©å­—ä½“æ–‡ä»¶ (.ttf/.otf/woff)' }}
                  </span>
                </div>

                <!-- é€‰é¡¹B: URL è¾“å…¥ -->
                <input
                  v-if="uploadForm.fontSourceType === 'url'"
                  v-model="uploadForm.url"
                  type="text"
                  placeholder="å­—ä½“æ–‡ä»¶ç›´é“¾ (https://...)"
                  class="w-full bg-gray-50 px-4 py-3 text-xs focus:bg-white focus:outline-none focus:ring-1 focus:ring-black transition-all"
                />
              </div>

              <!-- ç±»å‹ï¼šå›¾ç‰‡ -->
              <div v-if="uploadForm.type === 'image'" class="pt-2">
                <label
                  class="flex items-center gap-2 cursor-pointer select-none"
                >
                  <input
                    type="checkbox"
                    v-model="uploadForm.useAlbum"
                    class="accent-black w-3 h-3"
                  />
                  <span class="text-[10px] tracking-widest text-gray-500"
                    >å½’æ¡£è‡³ç›¸å†Œ</span
                  >
                </label>
                <input
                  v-if="uploadForm.useAlbum"
                  v-model="uploadForm.albumName"
                  list="albums"
                  placeholder="è¾“å…¥ç›¸å†Œåç§°..."
                  class="mt-3 w-full border-b border-gray-200 py-2 text-xs focus:border-black outline-none bg-transparent"
                />
                <datalist id="albums">
                  <option
                    v-for="a in albumList"
                    :value="a.displayName"
                    :key="a.realName"
                  ></option>
                </datalist>
              </div>

              <!-- ç±»å‹ï¼šæ–‡å­— -->
              <textarea
                v-if="uploadForm.type === 'text'"
                v-model="uploadForm.content"
                rows="5"
                placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—å†…å®¹..."
                class="w-full bg-gray-50 p-4 text-sm font-serif leading-relaxed focus:outline-none focus:bg-white focus:ring-1 focus:ring-black resize-none"
              ></textarea>

              <!-- ç±»å‹ï¼šå›¾ç‰‡/HTML/Chat çš„æ–‡ä»¶ä¸Šä¼  -->
              <div
                v-if="!editingId && (uploadForm.type === 'image' || uploadForm.type === 'html' || uploadForm.type === 'chat')"
                class="border border-dashed border-gray-200 h-28 flex flex-col items-center justify-center relative group cursor-pointer hover:border-black hover:bg-gray-50 transition-all rounded-sm"
              >
                <input
                  type="file"
                  @change="handleFileSelect"
                  multiple
                  class="absolute inset-0 opacity-0 z-10 cursor-pointer"
                  :accept="uploadForm.type === 'image' ? 'image/*' : (uploadForm.type === 'html' ? '.html,.htm' : '*/*')"
                />
                <span
                  class="text-2xl text-gray-300 font-light group-hover:text-black transition-colors mb-1"
                  >+</span
                >
                <span
                  class="text-[9px] tracking-widest text-gray-400 group-hover:text-black"
                  >{{ fileStatusText }}</span
                >
              </div>

              <!-- ç±»å‹ï¼šç¾åŒ– (Beautify) çš„ç‰¹æ®Šä¸Šä¼ ç•Œé¢ -->
              <div v-if="uploadForm.type === 'beautify'" class="space-y-6">
                <!-- æ–°å¢ï¼šç¾åŒ–åŒ…ä¸“ç”¨å¯¼å…¥åŒºåŸŸ -->
                <div
                  class="border-2 border-dashed border-blue-100 bg-blue-50/50 hover:bg-blue-50 hover:border-blue-300 transition-all rounded-lg p-6 flex flex-col items-center justify-center relative cursor-pointer group"
                >
                  <input
                    type="file"
                    accept=".zip"
                    @change="handleBeautifyZipImport"
                    class="absolute inset-0 opacity-0 cursor-pointer z-10"
                  />
                  <div
                    class="text-blue-500 mb-2 group-hover:scale-110 transition-transform"
                  >
                    <!-- å›¾æ ‡ -->
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="7 10 12 15 17 10" />
                      <line x1="12" y1="15" x2="12" y2="3" />
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                    </svg>
                  </div>
                  <span
                    class="text-[10px] font-bold tracking-widest text-blue-600 uppercase"
                    >å¯¼å…¥ç¾åŒ–èµ„æºåŒ… (.ZIP)</span
                  >
                  <span class="text-[9px] text-blue-400 mt-1"
                    >è‡ªåŠ¨è¯†åˆ«é…è‰²ã€é¢„è§ˆå›¾å’Œæºæ–‡ä»¶</span
                  >
                </div>
                <div
                  v-for="(item, index) in uploadForm.beautifyVariations"
                  :key="index"
                  class="bg-gray-50 p-4 relative border border-gray-200"
                >
                  <button
                    v-if="uploadForm.beautifyVariations.length > 1"
                    @click="removeBeautifyItem(index)"
                    class="absolute top-2 right-2 text-gray-400 hover:text-red-500"
                    title="åˆ é™¤æ­¤æ–¹æ¡ˆ"
                  >
                    &times;
                  </button>
                  <div class="space-y-3">
                    <div class="flex gap-2 items-center">
                      <!-- é¢œè‰²é€‰æ‹©å™¨ -->
                      <input
                        type="color"
                        v-model="item.colorValue"
                        class="h-8 w-8 p-0 border-0 bg-transparent cursor-pointer shrink-0 rounded overflow-hidden"
                        title="ç‚¹å‡»é€‰æ‹©é¢œè‰²"
                      />
                      <!-- é¢œè‰²ä»£ç è¾“å…¥æ¡† -->
                      <input
                        type="text"
                        v-model="item.colorValue"
                        placeholder="#000000"
                        class="flex-1 bg-white px-2 text-xs border border-gray-200 focus:border-black outline-none h-8 font-mono uppercase tracking-widest"
                      />
                    </div>

                    <!-- é¢„è§ˆå›¾ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >é¢„è§ˆå›¾</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰é¢„è§ˆå›¾ -->
                      <div
                        v-if="item.previewUrl && !item.previewFile"
                        class="mb-2 flex items-center gap-2"
                      >
                        <img
                          :src="item.previewUrl"
                          class="w-10 h-10 object-cover rounded border border-gray-200"
                        />
                        <span class="text-[9px] text-gray-400">å½“å‰é¢„è§ˆå›¾</span>
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.previewFile = e.target.files[0]"
                        accept="image/*"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.previewFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°å›¾: {{ item.previewFile.name }}</span
                      >
                    </div>

                    <!-- çœŸå®æ–‡ä»¶ä¸Šä¼  -->
                    <div class="relative">
                      <label class="block text-[9px] text-gray-400 mb-1"
                        >çœŸå®æ–‡ä»¶ (ä¸‹è½½ç”¨)</label
                      >
                      <!-- æ˜¾ç¤ºç°æœ‰æ–‡ä»¶çŠ¶æ€ -->
                      <div
                        v-if="item.realUrl && !item.realFile"
                        class="mb-1 text-[9px] text-blue-500"
                      >
                        âœ“ å·²åŒ…å«æ–‡ä»¶ (æ— éœ€é‡æ–°ä¸Šä¼ ï¼Œé™¤éè¦æ›¿æ¢)
                      </div>

                      <input
                        type="file"
                        @change="(e) => item.realFile = e.target.files[0]"
                        class="w-full text-[9px]"
                      />
                      <span
                        v-if="item.realFile"
                        class="text-[9px] text-green-600 block mt-1"
                        >âœ“ å°†ä¸Šä¼ æ–°æ–‡ä»¶: {{ item.realFile.name }}</span
                      >
                    </div>
                  </div>
                </div>
                <button
                  @click="addBeautifyItem"
                  class="w-full py-2 border border-dashed border-gray-300 text-gray-400 text-[10px] hover:border-black hover:text-black transition-colors"
                >
                  + æ·»åŠ å¦ä¸€ç§é¢œè‰²æ–¹æ¡ˆ
                </button>
              </div>
            </div>
            <button
              @click="submitUpload"
              :disabled="uploading"
              class="w-full py-5 bg-black text-white text-[10px] tracking-[0.3em] hover:bg-gray-800 disabled:bg-gray-300 transition-colors"
            >
              {{ uploading ? 'å¤„ç†ä¸­...' : (editingId ? 'ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤å…¥åº“')
              }}
            </button>
          </div>
        </div>
        <!-- ä¸»é¢˜åˆ‡æ¢ æ¨¡æ€æ¡† -->
        <div
          v-if="showThemeModal"
          class="fixed inset-0 z-[100] flex items-center justify-center p-8 fullscreen-layer"
        >
          <div
            @click="showThemeModal = false"
            class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-all"
          ></div>
          <div
            class="bg-panel w-full max-w-sm shadow-2xl border border-border relative z-10 animate-slide-up p-8 flex flex-col gap-6"
            :class="{'border-2 border-black': currentTheme === 'pixel'}"
          >
            <div
              class="flex justify-between items-center border-b border-border pb-4"
            >
              <span
                class="text-xs tracking-[0.2em] font-bold uppercase text-black"
                >THEME GALLERY</span
              >
              <button
                @click="showThemeModal = false"
                class="text-lg hover:text-accent"
              >
                &times;
              </button>
            </div>

            <div class="grid grid-cols-1 gap-4">
              <button
                v-for="t in themeOptions"
                :key="t.key"
                @click="setTheme(t.key)"
                class="flex items-center gap-4 p-3 border border-transparent hover:border-border transition-all group"
                :class="{'bg-gray-50 border-border': currentTheme === t.key}"
              >
                <!-- é¢„è§ˆåœ†ç‚¹ -->
                <div
                  class="w-8 h-8 rounded-full shadow-inner border border-black/5"
                  :style="t.previewStyle"
                ></div>
                <div class="text-left">
                  <div
                    class="text-xs font-bold text-black uppercase tracking-wider"
                  >
                    {{ t.name }}
                  </div>
                  <div class="text-[9px] text-sub">{{ t.desc }}</div>
                </div>
                <div
                  v-if="currentTheme === t.key"
                  class="ml-auto text-black text-xs"
                >
                  â—
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- iOS å®‰è£…å¼•å¯¼å¼¹çª— -->
        <div id="ios-install-guide" class="ios-install-guide">
          <div class="flex items-start gap-4">
            <div class="bg-gray-100 p-2 rounded-lg shrink-0">
              <img
                src="https://images.unsplash.com/photo-1599305445671-ac291c95aaa9?w=192&h=192&fit=crop"
                class="w-10 h-10 rounded-md"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-black mb-1">æ·»åŠ åˆ°ä¸»å±å¹•</h3>
              <p class="text-xs text-gray-500 leading-relaxed">
                ä¸ºäº†è·å¾—æ›´å¥½çš„å…¨å±ä½“éªŒï¼Œè¯·ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„
                <span class="font-bold text-blue-600">åˆ†äº«æŒ‰é’®</span>ï¼Œç„¶åé€‰æ‹©
                <span class="font-bold text-black">â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span>ã€‚
              </p>
            </div>
            <button
              onclick="
                document
                  .getElementById('ios-install-guide')
                  .classList.remove('show')
              "
              class="text-gray-400 hover:text-black"
            >
              &times;
            </button>
          </div>
          <div class="ios-install-arrow"></div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

      createApp({
        setup() {
          const config = ref({
            url: "", //ä»¥æ­¤ä¸ºç©ºï¼Œè®©ç”¨æˆ·è‡ªå·±å¡«
            key: "",
          });
          const auth = ref({ email: "", password: "" });
          const session = ref(null);
          const items = ref([]);
          const showThemeModal = ref(false);
          const currentTheme = ref("default");

          const themeOptions = [
            {
              key: "default",
              name: "Original",
              desc: "æç®€ç´ ç™½ / ç»å…¸é£æ ¼",
              previewStyle: "background: #FCFCFC; border: 1px solid #eee",
            },
            {
              key: "pure-black",
              name: "Pure Black",
              desc: "çº¯é»‘ / OLED / æè‡´å¯¹æ¯”",
              previewStyle: "background: #000000; border: 1px solid #333",
            },
            {
              key: "sakura",
              name: "Sakura",
              desc: "è½æ¨± / è½¯èŒç²‰è‰² / å°‘å¥³å¿ƒ",
              previewStyle: "background: #fff0f3; border: 1px solid #ffdae2",
            },
            {
              key: "cyan",
              name: "Cyan",
              desc: "é’é»› / å›½é£é›…éŸµ / é™¶ç“·è´¨æ„Ÿ",
              previewStyle: "background: #f2f5f4; border: 1px solid #dae3e1",
            },
            {
              key: "paper",
              name: "Paper",
              desc: "ç¾Šçš®å· / æ¸©æš–é˜…è¯» / å¤å¤",
              previewStyle: "background: #f7f3e8",
            },
            {
              key: "lavender",
              name: "Lavender",
              desc: "è¿·å¹»ç´« / æ¢¦å¢ƒæ°›å›´",
              previewStyle:
                "background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            },
            {
              key: "morandi",
              name: "Morandi",
              desc: "è«å…°è¿ª / ç°ç»¿å†·æ·¡é£",
              previewStyle: "background: #E0E5DF",
            },
            {
              key: "magazine",
              name: "Magazine",
              desc: "Vogue / æ‚å¿—æ’ç‰ˆ / è¡¬çº¿ä½“",
              previewStyle: "background: #f2f2f2; border: 1px solid #000;",
            },
            {
              key: "cream",
              name: "Cream Puff",
              desc: "å¥¶æ²¹æ³¡èŠ™ / è½¯èŒ / æ²»æ„ˆç³»",
              previewStyle: "background: #fffbf0; border: 2px solid #fff;",
            },
            {
              key: "deep-sea",
              name: "Deep Sea",
              desc: "æ·±æµ· / è“è°ƒæš—å¤œ / æ²‰æµ¸",
              previewStyle: "background: #0f172a",
            },
            {
              key: "pixel",
              name: "8-Bit",
              desc: "åƒç´ é£ / è¡—æœºæ¸¸æˆ",
              previewStyle:
                "background: #d0d0d0; background-image: radial-gradient(#000 1px, transparent 1px); background-size: 4px 4px;",
            },
          ];

          const filter = ref("all");
          const currentAlbum = ref(null);
          const currentTag = ref(null);
          const showUpload = ref(false);
          const lightboxImage = ref(null);
          const showExport = ref(false);
          const exportItem = ref(null);
          const exportStyle = ref("classic");
          // === æ–°å¢ï¼šä¹¦æ‘˜æ’ç‰ˆè®¾ç½® ===
          const exportSettings = ref({
            fontSize: 36,
            lineHeight: 68,
            textAlign: "left", // left, center, right
            fontFamily: "default", // é»˜è®¤è·Ÿéšä¸»é¢˜ï¼Œæˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“çš„ ID
          });
          const previewScale = ref(60);
          // === æ–°å¢ï¼šè·å–ä¸Šä¼ çš„å­—ä½“åˆ—è¡¨ä¾›ä¹¦æ‘˜é€‰æ‹© ===
          const fontList = computed(() => {
            return items.value.filter((i) => i.type === "font");
          });
          const quoteCanvas = ref(null);
          const loading = ref(false);
          const uploading = ref(false);
          const errorMsg = ref("");
          const editingId = ref(null);
          const currentGlobalFontId = ref(null); // è®°å½•å½“å‰æ­£åœ¨ä½¿ç”¨çš„å­—ä½“ID
          // === æ–°å¢ï¼šç¿»è½¬çŠ¶æ€ç®¡ç† ===
          const flippedCards = ref({}); // å­˜å‚¨æ¯ä¸ªå¡ç‰‡çš„ç¿»è½¬çŠ¶æ€ { id: boolean }
          const toggleFlip = (id) => {
            flippedCards.value[id] = !flippedCards.value[id];
          };
          // === è¯·æ·»åŠ ä¸‹é¢è¿™æ®µä»£ç  ===
          const expandedTextItems = ref({}); // å­˜å‚¨æ–‡å­—å¡ç‰‡çš„å±•å¼€çŠ¶æ€
          const toggleTextExpand = (id) => {
            expandedTextItems.value[id] = !expandedTextItems.value[id];
          };
          // =========================
          // === æ–°å¢ï¼šè§’è‰²å¡å†å²è®°å½•æ¨¡æ€æ¡†çŠ¶æ€ ===
          const showHistoryModal = ref(false);
          const currentHistoryItem = ref(null);

          // è§’è‰²å¡è¡¨å•ä¸“å±æ•°æ®
          const roleCardForm = ref({
            name: "",
            description: "", // <--- æ–°å¢è¿™ä¸€è¡Œ
            pngFile: null,
            jsonFile: null,
            qrFile: null,
            note: "",
          });

          // ç¾åŒ–ç›¸å…³çš„çŠ¶æ€ç®¡ç†ï¼šå­˜å‚¨æ¯ä¸ªå¡ç‰‡å½“å‰é€‰ä¸­çš„é¢œè‰²ç´¢å¼• { itemId: index }
          const beautifyStates = ref({});

          const showInstallBtn = ref(false);
          const deferredPrompt = ref(null);
          const isIOS =
            /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          const isStandalone =
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true;

          onMounted(() => {
            // 1. æ¢å¤è¯»å– URL ç¼“å­˜
            const u = localStorage.getItem("sb_url");
            const k = localStorage.getItem("sb_key");
            const savedEmail = localStorage.getItem("sb_email");
            const savedPass = localStorage.getItem("sb_pass");

            if (savedEmail) auth.value.email = savedEmail;
            if (savedPass) auth.value.password = savedPass;

            // 2. æ¢å¤ä¸»é¢˜è¯»å–
            const savedTheme = localStorage.getItem("museum_theme");
            if (savedTheme) {
              setTheme(savedTheme);
            }
            // æ¢å¤ä¸Šæ¬¡åº”ç”¨çš„å­—ä½“
            const savedFontId = localStorage.getItem("museum_active_font_id");
            if (savedFontId) {
              currentGlobalFontId.value = parseInt(savedFontId);
              // æ³¨æ„ï¼šå®é™…çš„ CSS åº”ç”¨ä¼šåœ¨ fetchData -> loadFontsFromItems ä¹‹åï¼Œ
              // æˆ‘ä»¬è¿™é‡Œå…ˆè®¾ç½® IDï¼Œç­‰å­—ä½“åŠ è½½å®Œæ¯•åï¼Œæˆ‘ä»¬åœ¨ loadFontsFromItems é‡Œè¡¥ä¸€ä¸‹é€»è¾‘
            }

            // 3. å¦‚æœæœ‰ç¼“å­˜çš„ URLï¼Œèµ‹å€¼ç»™ config
            if (u) config.value.url = u;

            // 4. åˆ¤æ–­é€»è¾‘ï¼šå¿…é¡» URL å’Œ Key éƒ½æœ‰æ‰è‡ªåŠ¨ç™»å½•
            if (config.value.url && k) {
              config.value.key = k;
              initSupabase();
            }

            if (!isStandalone) {
              if (isIOS) {
                showInstallBtn.value = true;
              } else {
                window.addEventListener("beforeinstallprompt", (e) => {
                  e.preventDefault();
                  deferredPrompt.value = e;
                  showInstallBtn.value = true;
                });
              }
            }
          });

          const triggerInstall = () => {
            if (isIOS) {
              document
                .getElementById("ios-install-guide")
                .classList.add("show");
            } else {
              if (deferredPrompt.value) {
                deferredPrompt.value.prompt();
                deferredPrompt.value.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === "accepted")
                    showInstallBtn.value = false;
                  deferredPrompt.value = null;
                });
              }
            }
          };

          const filterMap = {
            all: "å…¨éƒ¨",
            role_card: "è§’è‰²å¡", // <--- æ–°å¢
            text: "æ–‡å­—",
            image: "å½±åƒ",
            albums: "ç›¸å†Œ",
            font: "å­—ä½“",
            beautify: "ç¾åŒ–",
            html: "ç½‘é¡µ",
            link: "é“¾æ¥",
            chat: "èŠå¤©",
          };
          const uploadTypes = {
            role_card: "è§’è‰²å¡", // <--- æ–°å¢ï¼Œå»ºè®®æ”¾åœ¨å‰é¢æ–¹ä¾¿ç‚¹
            text: "æ–‡å­—",
            image: "å›¾ç‰‡",
            font: "å­—ä½“",
            beautify: "ç¾åŒ–",
            html: "æ–‡ä»¶",
            link: "é“¾æ¥",
            chat: "èŠå¤©",
          };
          const uploadForm = ref({
            type: "text",
            category: "",
            title: "",
            url: "",
            content: "",
            files: [],
            useAlbum: false,
            albumName: "",
            fontSourceType: "file",
            // ç¾åŒ–ä¸“ç”¨æ•°æ®ç»“æ„
            beautifyVariations: [
              {
                colorName: "é»˜è®¤",
                colorValue: "#000000",
                previewFile: null,
                realFile: null,
                previewUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
                realUrl: null, // ç¼–è¾‘æ—¶çš„æ—§é“¾æ¥
              },
            ],
          });
          // === æ–°å¢ï¼šæ ‡ç­¾è”æƒ³åŠŸèƒ½é€»è¾‘ ===
          const showTagList = ref(false);

          // 1. æå–æ‰€æœ‰å·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå»é‡ï¼‰
          const allExistingTags = computed(() => {
            const tags = new Set();
            items.value.forEach((item) => {
              if (item.category) {
                // æ”¯æŒé€—å·ã€ä¸­æ–‡é€—å·ã€ç©ºæ ¼åˆ†éš”
                const parts = item.category.split(/[,ï¼Œ\s]+/);
                parts.forEach((p) => {
                  if (p && p.trim()) tags.add(p.trim());
                });
              }
            });
            return Array.from(tags);
          });

          // 2. æ ¹æ®å½“å‰è¾“å…¥å†…å®¹ç­›é€‰æ ‡ç­¾
          const tagSuggestions = computed(() => {
            const val = uploadForm.value.category || "";
            // å¦‚æœæ²¡è¾“å…¥æˆ–æœ€åä¸€ä½æ˜¯åˆ†éš”ç¬¦ï¼Œä¸æ˜¾ç¤º
            if (!val || /[,ï¼Œ\s]$/.test(val)) return [];

            // è·å–å…‰æ ‡æ‰€åœ¨æˆ–æœ€åä¸€ä¸ªæ­£åœ¨è¾“å…¥çš„è¯
            const separators = /[,ï¼Œ\s]/;
            let lastIndex = -1;
            // ä»åå¾€å‰æ‰¾æœ€åä¸€ä¸ªåˆ†éš”ç¬¦
            for (let i = val.length - 1; i >= 0; i--) {
              if (separators.test(val[i])) {
                lastIndex = i;
                break;
              }
            }

            const currentInput = val.substring(lastIndex + 1).trim();
            if (!currentInput) return [];

            const search = currentInput.toLowerCase();

            // ç­›é€‰åŒ…å«æœç´¢è¯çš„æ ‡ç­¾ï¼Œå¹¶è¿›è¡Œæ’åºï¼ˆä»¥æœç´¢è¯å¼€å¤´çš„æ’å‰é¢ï¼‰
            return allExistingTags.value
              .filter(
                (tag) =>
                  tag.toLowerCase().includes(search) &&
                  tag.toLowerCase() !== search,
              )
              .sort((a, b) => {
                const aStarts = a.toLowerCase().startsWith(search);
                const bStarts = b.toLowerCase().startsWith(search);
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return a.length - b.length;
              })
              .slice(0, 10); // æœ€å¤šæ˜¾ç¤º10ä¸ª
          });

          // 3. ç‚¹å‡»è”æƒ³è¯å¡«å…¥
          const applyTagSuggestion = (tag) => {
            const val = uploadForm.value.category || "";
            const separators = /[,ï¼Œ\s]/;
            let lastIndex = -1;
            for (let i = val.length - 1; i >= 0; i--) {
              if (separators.test(val[i])) {
                lastIndex = i;
                break;
              }
            }

            // ä¿ç•™åˆ†éš”ç¬¦ä¹‹å‰çš„å†…å®¹ï¼Œæ›¿æ¢æœ€åä¸€ä¸ªè¯
            let prefix = "";
            if (lastIndex !== -1) {
              prefix = val.substring(0, lastIndex + 1);
            }

            // å¡«å…¥æ ‡ç­¾å¹¶è‡ªåŠ¨è¡¥ä¸€ä¸ªç©ºæ ¼ï¼Œæ–¹ä¾¿è¾“å…¥ä¸‹ä¸€ä¸ª
            uploadForm.value.category = prefix + tag + " ";

            // ä¿æŒç„¦ç‚¹ä»¥ä¾¿ç»§ç»­è¾“å…¥ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦æ›´æµç•…ä½“éªŒï¼‰
            // nextTick(() => document.querySelector('.group\\/tag-input input')?.focus());
            showTagList.value = false;
          };
          const styles = {
            classic: {
              name: "ç´ ç™½",
              btnColor: "#fff",
              bg: "#ffffff",
              text: "#111",
              sub: "#999",
              font: "serif",
            },
            dark: {
              name: "å¤œèˆª",
              btnColor: "#1a1a1a",
              bg: "#121212",
              text: "#e0e0e0",
              sub: "#666",
              font: "serif",
            },
            cream: {
              name: "ç¾Šçš®",
              btnColor: "#f5f2e9",
              bg: "#f5f2e9",
              text: "#2c2c2c",
              sub: "#8b8b80",
              font: "serif",
            },
            ink: {
              name: "æ°´å¢¨",
              btnColor: "#e6e6e6",
              bg: "#e8e8e8",
              text: "#000",
              sub: "#555",
              font: "serif",
              border: true,
            },
            film: {
              name: "èƒ¶ç‰‡",
              btnColor: "#000",
              bg: "#000",
              text: "#ffc107",
              sub: "#888",
              font: "sans",
              letter: true,
            },
            red: {
              name: "èµ¤çº¢",
              btnColor: "#8B0000",
              bg: "#fff",
              text: "#8B0000",
              sub: "#D98880",
              font: "serif",
              borderRed: true,
            },
            // ... (ä¿ç•™ classic, dark, cream, ink, film, red) ...

            // --- æ›¿æ¢ä¸ºæ–°çš„è«å…°è¿ª/å¯çˆ±é£æ ¼ ---
            pixel: {
              name: "æµ®å…‰", // æ¢¦å¹» OS é£æ ¼
              btnColor: "#F4D0D2", // è«å…°è¿ªç²‰
              bg: "#F9F3F3", // èƒŒæ™¯ææ·¡ç²‰
              text: "#5E5050", // æš–ç°å­—
              sub: "#9E8E8E",
              font: "sans", // æ— è¡¬çº¿å­—ä½“æ›´ç°ä»£
              type: "dream_os",
            },
            game: {
              name: "ç©ä¼´", // åŠ¨æ£®ç»¿æŒæœºé£æ ¼
              btnColor: "#B5C9C3", // è«å…°è¿ªè±†æ²™ç»¿
              bg: "#B5C9C3",
              text: "#465D58", // æ·±ç»¿ç°å­—
              sub: "#7A918D",
              font: "sans",
              type: "cute_console",
            },
            terminal: {
              name: "ç¦…æ„", // é«˜çº§ç¼–è¾‘å™¨é£æ ¼
              btnColor: "#2E3440", // Nord æ·±è“ç°
              bg: "#2E3440",
              text: "#D8DEE9", // æŸ”å’Œç™½
              sub: "#5C677D", // æ³¨é‡Šç°
              font: "mono",
              type: "zen_editor",
            },
            // ... (ä¿ç•™ä¹‹å‰çš„æ ·å¼) ...

            // --- æ–°å¢ï¼šæƒ…ç»ªç³»è®¾è®¡ ---
            receipt: {
              name: "å­˜æ ¹", // è¶…å¸‚å°ç¥¨é£æ ¼
              btnColor: "#fff",
              bg: "#eee", // èƒŒæ™¯æ·±ä¸€ç‚¹ï¼Œä¸ºäº†å‡¸æ˜¾ç™½è‰²å°ç¥¨
              text: "#222",
              sub: "#666",
              font: "mono", // ç­‰å®½å­—ä½“æ›´æœ‰å°ç¥¨æ„Ÿ
              type: "receipt",
            },
            letter: {
              name: "ä¿¡ç¬º", // ä¸­å¼ä¿¡çº¸
              btnColor: "#fdfbf7", // æš–ç±³è‰²
              bg: "#fdfbf7",
              text: "#333",
              sub: "#8c4e4e", // ä¹Ÿæ˜¯çº¢æ£•è‰²
              font: "serif",
              type: "letter",
            },
            diffusion: {
              name: "å¼¥æ•£", // æµä½“æ¸å˜
              btnColor: "#cba6f7", // ç´«è‰²ç¤ºæ„
              bg: "#1e1e2e", // è¿™é‡ŒèƒŒæ™¯è‰²ä¸é‡è¦ï¼Œä¼šè¢«æ¸å˜è¦†ç›–
              text: "#fff",
              sub: "rgba(255,255,255,0.7)",
              font: "sans",
              type: "diffusion",
            },
          };

          let supabase = null;

          // æ‰¾åˆ°åŸæœ‰çš„ formatDate å‡½æ•°ï¼Œæ›¿æ¢ä¸ºï¼š
          const formatDate = (str) => {
            if (!str) return "";
            const d = new Date(str);
            const pad = (n) => String(n).padStart(2, "0");
            // è¿”å›æ ¼å¼ï¼šYYYY.MM.DD HH:mm
            return `${d.getFullYear()}.${pad(d.getMonth() + 1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
          };

          const getRealContent = (item) => {
            if (item.type === "beautify") return null; // ç¾åŒ–ç±»å‹å•ç‹¬å¤„ç†
            if (!item.content) return null;
            if (item.content.startsWith("hidden:")) return null;
            // å¦‚æœæ˜¯ç¾åŒ–ç±»å‹JSONï¼ˆæ—§æ•°æ®å…¼å®¹ï¼‰ï¼Œä¸ç›´æ¥æ˜¾ç¤º
            if (item.content.trim().startsWith("{") && item.type === "beautify")
              return null;
            return item.content;
          };

          const getTags = (item) => {
            if (!item.category) return ["æœªåˆ†ç±»"];
            return item.category
              .replace(/ï¼Œ/g, ",")
              .split(/[, \s]+/)
              .filter((t) => t && t.trim().length > 0);
          };

          const fileStatusText = computed(() =>
            uploadForm.value.files.length === 0
              ? "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶"
              : `å·²é€‰ ${uploadForm.value.files.length} ä¸ªæ–‡ä»¶`,
          );

          const albumList = computed(() => {
            const albums = {};
            items.value.forEach((item) => {
              if (item.type === "image" && item.album_name) {
                if (!albums[item.album_name])
                  albums[item.album_name] = {
                    realName: item.album_name,
                    displayName: item.album_name.startsWith(".")
                      ? item.album_name.substring(1)
                      : item.album_name,
                    isHidden: item.album_name.startsWith("."),
                    count: 0,
                    cover: item.file_url,
                  };
                albums[item.album_name].count++;
              }
            });
            return Object.values(albums);
          });

          const filteredItems = computed(() => {
            if (currentAlbum.value)
              return items.value.filter(
                (i) => i.album_name === currentAlbum.value,
              );
            if (currentTag.value)
              return items.value.filter((i) =>
                getTags(i).includes(currentTag.value),
              );
            if (filter.value === "all") return items.value;
            if (filter.value === "albums") return [];
            if (filter.value === "image") {
              return items.value.filter((i) => {
                if (i.type !== "image") return false;
                if (!i.album_name) return true;
                return !i.album_name.startsWith(".");
              });
            }
            return items.value.filter((i) => i.type === filter.value);
          });
          // 1. å¢åŠ  isRestoring å‚æ•°ï¼Œé»˜è®¤ä¸º false
          const applyFont = (item, isRestoring = false) => {
            const fontName = `font_${item.id}`;
            const styleId = "museum-global-font-style";

            // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨äºè¦†ç›–å­—ä½“çš„ <style> æ ‡ç­¾
            let styleTag = document.getElementById(styleId);
            if (!styleTag) {
              styleTag = document.createElement("style");
              styleTag.id = styleId;
              document.head.appendChild(styleTag);
            }

            // 2. ä¿®æ”¹è¿™é‡Œï¼šå¦‚æœä¸æ˜¯æ¢å¤æ¨¡å¼(!isRestoring)ï¼Œä¸”IDç›¸åŒï¼Œæ‰æ‰§è¡Œå–æ¶ˆé€»è¾‘
            if (!isRestoring && currentGlobalFontId.value === item.id) {
              styleTag.innerHTML = "";
              currentGlobalFontId.value = null;
              localStorage.removeItem("museum_active_font_id"); // æ¸…é™¤ç¼“å­˜
              return;
            }

            // 3. å¼ºåˆ¶è¦†ç›–å…¨ç«™å­—ä½“ (!important ç¡®ä¿è¦†ç›–æ‰ä¸»é¢˜çš„é»˜è®¤å­—ä½“)
            styleTag.innerHTML = `
    body, 
    [data-theme] body, 
    .font-sans, 
    .font-serif, 
    .font-pixel { 
      font-family: '${fontName}', sans-serif !important; 
    }
  `;

            // 4. æ›´æ–°çŠ¶æ€å¹¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            currentGlobalFontId.value = item.id;
            localStorage.setItem("museum_active_font_id", item.id);
          };

          const initSupabase = async () => {
            try {
              if (!config.value.url) return;

              // ä»ç¼“å­˜å– Key
              let k = config.value.key;

              // åŒæ ·è¿›è¡Œæ¸…æ´—
              if (k) {
                k = k.trim();
              }

              // å¦‚æœ Key åŒ…å«éæ³•å­—ç¬¦æˆ–è€…æ˜¯ç©ºçš„ï¼Œå°±ä¸è¦åˆå§‹åŒ–äº†ï¼Œç­‰ç”¨æˆ·æ‰‹åŠ¨ç‚¹ç™»å½•
              if (!k || k.length < 20) return;

              supabase = window.supabase.createClient(
                config.value.url.trim(),
                k,
              );
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                session.value = data.session;
                fetchData();
              }
            } catch (e) {
              // åˆå§‹åŒ–å¤±è´¥ä¸å¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•ï¼Œé¿å…å“åˆ°ç”¨æˆ·
              console.log("è‡ªåŠ¨ç™»å½•æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç™»å½•", e);
            }
          };

          const handleLogin = async () => {
            loading.value = true;
            errorMsg.value = "";
            try {
              const u = config.value.url.trim();

              // === ä¿®å¤æ ¸å¿ƒï¼šæš´åŠ›æ¸…æ´— Key ===
              // 1. è·å–è¾“å…¥æ¡†çš„å€¼
              let rawKey = config.value.key;

              const k = rawKey.trim();

              if (!k) throw new Error("Key ä¸èƒ½ä¸ºç©º");

              // 3. æ›´æ–°å›è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¸…æ´—åçš„ç»“æœ
              config.value.key = k;

              // 4. å­˜å…¥ç¼“å­˜
              localStorage.setItem("sb_url", u);
              localStorage.setItem("sb_key", k);
              localStorage.setItem("sb_email", auth.value.email.trim());
              localStorage.setItem("sb_pass", auth.value.password.trim());
              // === ä¿®å¤æ ¸å¿ƒï¼šå¼ºåˆ¶é‡å»ºå®¢æˆ·ç«¯ ===
              // ä¸è¦åˆ¤æ–­ if (!supabase)ï¼Œç›´æ¥è¦†ç›–ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ Key
              supabase = window.supabase.createClient(u, k);

              const { data, error } = await supabase.auth.signInWithPassword({
                email: auth.value.email.trim(),
                password: auth.value.password.trim(),
              });
              if (error) throw error;
              session.value = data.session;
              fetchData();
            } catch (e) {
              console.error(e);
              errorMsg.value = "ç™»å½•å¤±è´¥: " + e.message;
              supabase = null; // å‡ºé”™åç½®ç©ºï¼Œä¸‹æ¬¡å¼ºåˆ¶é‡å»º
            } finally {
              loading.value = false;
            }
          };

          const handleLogout = async () => {
            if (supabase) await supabase.auth.signOut();
            session.value = null;
            items.value = [];
          };

          // ... ä¿®æ”¹ fetchData å‡½æ•°ï¼Œåœ¨è·å–æ•°æ®åè°ƒç”¨ä¸Šé¢è¿™ä¸ªå‡½æ•° ...
          const fetchData = async () => {
            if (!supabase) return;
            loading.value = true;
            const { data } = await supabase
              .from("fragments")
              .select("*")
              .order("created_at", { ascending: false });
            items.value = data || [];

            nextTick(() => {
              loadFontsFromItems();
            });

            loading.value = false;
          };

          const loadFontsFromItems = () => {
            items.value.forEach((item) => {
              if (item.type === "font" && item.file_url) {
                const fontName = `font_${item.id}`;
                const isLoaded = Array.from(document.fonts).some(
                  (f) => f.family === fontName,
                );
                if (!isLoaded) {
                  const font = new FontFace(fontName, `url(${item.file_url})`);
                  font
                    .load()
                    .then((loadedFace) => {
                      document.fonts.add(loadedFace);
                      // === ä¿®æ”¹è¿™é‡Œï¼šä¼ å…¥ true ===
                      if (currentGlobalFontId.value === item.id) {
                        applyFont(item, true);
                      }
                    })
                    .catch((err) => {
                      console.error(`å­—ä½“åŠ è½½å¤±è´¥: ${item.content}`, err);
                    });
                } else {
                  // === ä¿®æ”¹è¿™é‡Œï¼šä¼ å…¥ true ===
                  if (currentGlobalFontId.value === item.id) {
                    applyFont(item, true);
                  }
                }
              }
            });
          };

          // ç¾åŒ–æ¨¡å—è¾…åŠ©å‡½æ•°
          const getBeautifyData = (item) => {
            if (!item.content) return { title: "æ•°æ®å¼‚å¸¸", variations: [] };
            try {
              const data = JSON.parse(item.content);
              return data || { title: "æ— æ ‡é¢˜", variations: [] };
            } catch (e) {
              return { title: "è§£æé”™è¯¯", variations: [] };
            }
          };

          const getBeautifyIndex = (id) => {
            return beautifyStates.value[id] || 0;
          };
          const setTheme = (themeKey) => {
            currentTheme.value = themeKey;
            document.body.setAttribute("data-theme", themeKey);
            localStorage.setItem("museum_theme", themeKey);
            // åƒç´ é£éœ€è¦è§¦å‘ä¸€æ¬¡é‡ç»˜æˆ–ç‰¹å®šå¤„ç†ï¼ˆå¯é€‰ï¼‰
          };

          const setBeautifyIndex = (id, idx) => {
            beautifyStates.value[id] = idx;
          };

          const getBeautifyPreview = (item) => {
            const data = getBeautifyData(item);
            const idx = getBeautifyIndex(item.id);
            if (data.variations && data.variations[idx]) {
              return data.variations[idx].preview;
            }
            return item.file_url; // é™çº§
          };

          const addBeautifyItem = () => {
            uploadForm.value.beautifyVariations.push({
              colorName: "",
              colorValue: "#000000",
              previewFile: null,
              realFile: null,
              previewUrl: null,
              realUrl: null,
            });
          };

          const removeBeautifyItem = (index) => {
            uploadForm.value.beautifyVariations.splice(index, 1);
          };

          const changeExportStyle = (s) => {
            exportStyle.value = s;
            drawCard();
          };
          // --- æ–°å¢ï¼šå¤„ç†ç¾åŒ–åŒ…å¯¼å…¥ ---
          const handleBeautifyZipImport = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // ç®€å•çš„åŠ è½½åŠ¨ç”»æˆ–æç¤º
            const originalText = e.target.nextElementSibling?.innerText; // è·å–ä¸åˆ°DOMä¹Ÿæ²¡å…³ç³»ï¼Œè¿™è¡Œåªæ˜¯ä¸ºäº†ä¸¥è°¨

            try {
              const zip = await JSZip.loadAsync(file);

              // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ¸…å•æ–‡ä»¶
              if (!zip.file("manifest.json")) {
                alert("æ— æ³•è¯†åˆ«ï¼šå‹ç¼©åŒ…å†…ç¼ºå°‘ manifest.json è¯´æ˜æ–‡ä»¶ã€‚");
                return;
              }

              const manifestStr = await zip
                .file("manifest.json")
                .async("string");
              const manifest = JSON.parse(manifestStr);

              // 2. è‡ªåŠ¨å¡«å…¥æ ‡é¢˜
              if (manifest.title) {
                uploadForm.value.title = manifest.title;
              }
              if (manifest.category) {
                uploadForm.value.category = manifest.category;
              }
              // 3. å‡†å¤‡å˜ä½“æ•°ç»„
              const newVariations = [];

              // 4. éå†è§£å‹æ–‡ä»¶
              if (manifest.variations && Array.isArray(manifest.variations)) {
                for (const v of manifest.variations) {
                  const variationItem = {
                    colorName: v.name || "é»˜è®¤", // å…¼å®¹æ—§ç‰ˆ
                    colorValue: v.color || "#000000",
                    previewFile: null,
                    realFile: null,
                    previewUrl: null,
                    realUrl: null,
                  };

                  // è¿˜åŸé¢„è§ˆå›¾ (Blob -> File)
                  if (v.previewFile && zip.file(v.previewFile)) {
                    const blob = await zip.file(v.previewFile).async("blob");
                    // å¿…é¡»åˆ›å»º File å¯¹è±¡ï¼Œè¿™æ ·æäº¤é€»è¾‘æ‰èƒ½è¯†åˆ«è¿™æ˜¯æ–°æ–‡ä»¶
                    variationItem.previewFile = new File(
                      [blob],
                      v.previewFile,
                      { type: blob.type },
                    );
                  }

                  // è¿˜åŸçœŸå®æ–‡ä»¶ (Blob -> File)
                  if (v.realFile && zip.file(v.realFile)) {
                    const blob = await zip.file(v.realFile).async("blob");
                    variationItem.realFile = new File([blob], v.realFile, {
                      type: blob.type,
                    });
                  }

                  newVariations.push(variationItem);
                }
              }

              // 5. æ›´æ–°è¡¨å•
              if (newVariations.length > 0) {
                uploadForm.value.beautifyVariations = newVariations;
                alert(
                  `æˆåŠŸå¯¼å…¥ "${manifest.title}"ï¼ŒåŒ…å« ${newVariations.length} ç§é…è‰²æ–¹æ¡ˆï¼`,
                );
              }
            } catch (err) {
              console.error(err);
              alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®");
            } finally {
              // æ¸…ç©º inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶
              e.target.value = "";
            }
          };

          // === ã€ä¿®æ”¹ä»£ç ã€‘æ”¯æŒå·¦ä¸­å³å¯¹é½çš„æ–‡å­—æ¢è¡Œå‡½æ•° ===
          const wrapText = (
            ctx,
            text,
            x,
            y,
            maxWidth,
            lineHeight,
            align = "left",
          ) => {
            const paragraphs = text.split("\n");
            let currentY = y;

            // æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®—æ¯ä¸€è¡Œçš„èµ·å§‹ X åæ ‡
            let drawX = x;
            if (align === "center") {
              ctx.textAlign = "center";
              drawX = x + maxWidth / 2;
            } else if (align === "right") {
              ctx.textAlign = "right";
              drawX = x + maxWidth;
            } else {
              ctx.textAlign = "left";
              drawX = x;
            }

            paragraphs.forEach((paragraph) => {
              const words = paragraph.split("");
              let line = "";
              for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                  ctx.fillText(line, drawX, currentY);
                  line = words[n];
                  currentY += lineHeight;
                } else {
                  line = testLine;
                }
              }
              ctx.fillText(line, drawX, currentY);
              currentY += lineHeight * 1.5; // æ®µè½é—´è·
            });
            return currentY;
          };

          // --- æ–°å¢ï¼šç”»åœ†è§’çŸ©å½¢çš„å·¥å…·å‡½æ•° ---
          const roundRect = (ctx, x, y, w, h, r) => {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
          };
          // === ã€ä¿®æ”¹ä»£ç ã€‘ç»˜åˆ¶å¡ç‰‡å‡½æ•° ===
          const drawCard = () => {
            const cvs = quoteCanvas.value;
            if (!cvs || !exportItem.value) return;
            const ctx = cvs.getContext("2d");
            const s = styles[exportStyle.value];
            const text = exportItem.value.content || "";
            const date = formatDate(exportItem.value.created_at);

            // 1. è¯»å–è®¾ç½® (é˜²æ­¢æŠ¥é”™ï¼ŒåŠ äº† ?. ä¿æŠ¤)
            const settings = exportSettings.value || {
              fontSize: 36,
              lineHeight: 68,
              textAlign: "left",
              fontFamily: "default",
            };
            const fontSize = Number(settings.fontSize);
            const lineHeight = Number(settings.lineHeight);
            const align = settings.textAlign;

            // 2. åŸºç¡€å¸ƒå±€å‚æ•°
            const W = 900;
            let paddingX = 80;
            let paddingTop = 80;
            let paddingBottom = 80;

            // é’ˆå¯¹ç‰¹å®šæ ·å¼çš„å‚æ•°è°ƒæ•´
            if (s.type === "dream_os") {
              paddingTop = 140;
              paddingX = 100;
            }
            if (s.type === "cute_console") {
              paddingTop = 140;
              paddingBottom = 160;
              paddingX = 120;
            }
            if (s.type === "zen_editor") {
              paddingTop = 120;
              paddingX = 100;
            }
            if (s.type === "receipt") {
              paddingX = 70;
              paddingTop = 120;
              paddingBottom = 160;
            }
            if (s.type === "letter") {
              paddingX = 100;
              paddingTop = 120;
            }
            if (s.type === "diffusion") {
              paddingX = 90;
              paddingTop = 150;
              paddingBottom = 150;
            }

            // 3. ç¡®å®šå­—ä½“
            let fontName = '"Noto Serif SC"';
            if (s.font === "sans")
              fontName = '"Inter", "PingFang SC", sans-serif';
            if (s.font === "mono") fontName = '"Menlo", "Consolas", monospace';

            // å¦‚æœç”¨æˆ·é€‰æ‹©äº†è‡ªå®šä¹‰å­—ä½“
            if (settings.fontFamily !== "default") {
              // è¿™é‡Œçš„ 'font_ID' å¿…é¡»å’Œä¹‹å‰åŠ è½½å­—ä½“æ—¶çš„åç§°ä¸€è‡´
              fontName = `'font_${settings.fontFamily}', sans-serif`;
            }

            // 4. è®¡ç®—é«˜åº¦ (Measure)
            // ä¸´æ—¶è®¾ç½®å­—ä½“ç”¨äºè®¡ç®—
            let fontWeight = "300";
            if (
              s.type === "zen_editor" ||
              s.type === "diffusion" ||
              s.type === "receipt"
            )
              fontWeight = "400";
            if (settings.fontFamily !== "default") fontWeight = "normal"; // è‡ªå®šä¹‰å­—ä½“é€šå¸¸ä¸ç”¨300

            ctx.font = `${fontWeight} ${fontSize}px ${fontName}`;

            let textWidthLimit = W - paddingX * 2;
            if (s.type === "receipt") textWidthLimit = 560;

            // æ¨¡æ‹Ÿè®¡ç®—é«˜åº¦ï¼ˆæ³¨æ„è¿™é‡Œä¹Ÿä¼ å…¥äº† align å‚æ•°ï¼Œè™½ç„¶è®¡ç®—é«˜åº¦ä¸éœ€è¦å®ƒï¼Œä½†ä¿æŒå‚æ•°ä¸€è‡´ï¼‰
            const measureWrapTextHeight = (
              ctx,
              text,
              x,
              y,
              maxWidth,
              lineHeight,
            ) => {
              const paragraphs = text.split("\n");
              let currentY = y;
              paragraphs.forEach((paragraph) => {
                const words = paragraph.split("");
                let line = "";
                for (let n = 0; n < words.length; n++) {
                  const testLine = line + words[n];
                  const metrics = ctx.measureText(testLine);
                  if (metrics.width > maxWidth && n > 0) {
                    line = words[n];
                    currentY += lineHeight;
                  } else {
                    line = testLine;
                  }
                }
                currentY += lineHeight * 1.5;
              });
              return currentY;
            };

            const textEndY = measureWrapTextHeight(
              ctx,
              text,
              paddingX,
              paddingTop,
              textWidthLimit,
              lineHeight,
            );
            let H = textEndY + paddingBottom + 60;
            if (s.type === "cute_console") H = textEndY + 300;
            if (s.type === "receipt") H = textEndY + 200;
            H = Math.max(H, 600);

            // 5. ç»˜åˆ¶èƒŒæ™¯ (ä¿æŒåŸæœ‰é€»è¾‘)
            cvs.width = W;
            cvs.height = H;
            ctx.fillStyle = s.bg;
            ctx.fillRect(0, 0, W, H);

            // ... (æ­¤å¤„çœç•¥èƒŒæ™¯è£…é¥°ç»˜åˆ¶ä»£ç ï¼Œå¦‚ dream_os, cute_console ç­‰ï¼Œä¿æŒæ‚¨åŸæ¥çš„å³å¯) ...
            // ä¸ºäº†ä»£ç ç®€æ´ï¼Œè¯·æŠŠåŸæ¥ drawCard ä¸­é—´ç»˜åˆ¶è£…é¥°çš„é‚£ä¸€å¤§æ®µ IF/ELSE å¤åˆ¶å›æ¥æ”¾åœ¨è¿™é‡Œ
            // ===========================================
            // ------ A. ğŸŒ¸ æµ®å…‰ Dream OS ------
            if (s.type === "dream_os") {
              const winMargin = 40;
              const winW = W - winMargin * 2;
              const winH = H - winMargin * 2;
              ctx.shadowColor = "rgba(0,0,0,0.05)";
              ctx.shadowBlur = 30;
              ctx.shadowOffsetY = 15;
              ctx.fillStyle = "#ffffff";
              roundRect(ctx, winMargin, winMargin, winW, winH, 24);
              ctx.fill();
              ctx.shadowColor = "transparent";
              const grad = ctx.createLinearGradient(
                winMargin,
                winMargin,
                winMargin,
                winMargin + 60,
              );
              grad.addColorStop(0, "#FCF6F6");
              grad.addColorStop(1, "#FFFBFB");
              ctx.save();
              roundRect(ctx, winMargin, winMargin, winW, 60, 24);
              ctx.clip();
              ctx.fillStyle = grad;
              ctx.fillRect(winMargin, winMargin, winW, 60);
              ctx.restore();
              ctx.fillStyle = "#EDA6A6";
              ctx.beginPath();
              ctx.arc(winMargin + 40, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#E8D595";
              ctx.beginPath();
              ctx.arc(winMargin + 70, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#A8C8A6";
              ctx.beginPath();
              ctx.arc(winMargin + 100, winMargin + 30, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.strokeStyle = "#F2EBEB";
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(winMargin, winMargin + 60);
              ctx.lineTo(winMargin + winW, winMargin + 60);
              ctx.stroke();
            }
            // ------ B. ğŸ® ç©ä¼´ Cute Console ------
            if (s.type === "cute_console") {
              const screenMargin = 50;
              ctx.fillStyle = "#F7F9F8";
              ctx.shadowColor = "rgba(0,0,0,0.1)";
              ctx.shadowBlur = 0;
              ctx.shadowOffsetX = 4;
              ctx.shadowOffsetY = 4;
              roundRect(
                ctx,
                screenMargin,
                screenMargin,
                W - screenMargin * 2,
                H - 220,
                30,
              );
              ctx.fill();
              ctx.shadowColor = "transparent";
              ctx.strokeStyle = "#DDE4E2";
              ctx.lineWidth = 2;
              roundRect(
                ctx,
                screenMargin + 10,
                screenMargin + 10,
                W - screenMargin * 2 - 20,
                H - 220 - 20,
                20,
              );
              ctx.stroke();
              const controlsY = H - 120;
              ctx.fillStyle = "#A3B8B2";
              const dpadSize = 25;
              const dpadX = 120;
              roundRect(
                ctx,
                dpadX - dpadSize,
                controlsY - 8,
                dpadSize * 3,
                16,
                4,
              );
              ctx.fill();
              roundRect(
                ctx,
                dpadX,
                controlsY - 8 - dpadSize,
                16,
                dpadSize * 3,
                4,
              );
              ctx.fill();
              const btnY = controlsY;
              ctx.fillStyle = "#E6B8B8";
              ctx.beginPath();
              ctx.arc(W - 120, btnY - 20, 24, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = "#E8C8A0";
              ctx.beginPath();
              ctx.arc(W - 180, btnY + 10, 24, 0, Math.PI * 2);
              ctx.fill();
            }
            // ------ C. ğŸŒ™ ç¦…æ„ Zen Editor ------
            if (s.type === "zen_editor") {
              ctx.fillStyle = "#242933";
              ctx.fillRect(0, 0, W, 60);
              ctx.fillStyle = "#2E3440";
              ctx.beginPath();
              ctx.moveTo(20, 60);
              ctx.lineTo(20, 10);
              ctx.arcTo(20, 0, 30, 0, 10);
              ctx.lineTo(200, 0);
              ctx.arcTo(210, 0, 210, 10, 10);
              ctx.lineTo(210, 60);
              ctx.fill();
              ctx.fillStyle = "#88C0D0";
              ctx.font = `italic 20px ${fontName}`;
              ctx.fillText("thought.txt", 40, 35);
              ctx.fillText("Ã—", 180, 35);
              ctx.fillStyle = "#3B4252";
              ctx.fillRect(0, 60, 60, H - 60);
              ctx.fillStyle = "#4C566A";
              // è¡Œå·
              ctx.font = `18px ${fontName}`;
              ctx.textAlign = "right";
              // åŠ¨æ€è®¡ç®—å¤§æ¦‚å¤šå°‘è¡Œ
              const approxLines = Math.floor((H - 100) / lineHeight);
              for (let i = 1; i < approxLines + 5; i++) {
                ctx.fillText(i, 45, 100 + (i - 1) * lineHeight);
              }
            }
            // ------ D. ğŸ§¾ å­˜æ ¹ Receipt ------
            if (s.type === "receipt") {
              const ticketW = 700;
              const ticketX = (W - ticketW) / 2;
              const ticketH = H - 60;
              ctx.shadowColor = "rgba(0,0,0,0.15)";
              ctx.shadowBlur = 20;
              ctx.shadowOffsetY = 10;
              ctx.fillStyle = "#fff";
              ctx.beginPath();
              ctx.moveTo(ticketX, 0);
              ctx.lineTo(ticketX + ticketW, 0);
              let yPos = ticketH;
              let xPos = ticketX + ticketW;
              const toothSize = 10;
              while (xPos > ticketX) {
                ctx.lineTo(xPos - toothSize, yPos - toothSize);
                ctx.lineTo(xPos - 2 * toothSize, yPos);
                xPos -= 2 * toothSize;
              }
              ctx.lineTo(ticketX, 0);
              ctx.fill();
              ctx.shadowColor = "transparent";
              ctx.strokeStyle = "#ddd";
              ctx.lineWidth = 2;
              ctx.setLineDash([10, 10]);
              ctx.beginPath();
              ctx.moveTo(ticketX + 30, 90);
              ctx.lineTo(ticketX + ticketW - 30, 90);
              ctx.stroke();
              const bottomLineY = H - 160;
              ctx.beginPath();
              ctx.moveTo(ticketX + 30, bottomLineY);
              ctx.lineTo(ticketX + ticketW - 30, bottomLineY);
              ctx.stroke();
              ctx.setLineDash([]);
              ctx.fillStyle = "#000";
              ctx.font = `bold 30px "Courier New"`;
              ctx.textAlign = "center";
              ctx.fillText("MUSEUM OF THOUGHTS", W / 2, 60);
            }
            // ------ E. ğŸ§§ ä¿¡ç¬º Letter ------
            if (s.type === "letter") {
              ctx.strokeStyle = "rgba(200, 100, 100, 0.15)";
              ctx.lineWidth = 2;
              const gridW = 60;
              const startX = paddingX - 20;
              const endX = W - paddingX + 20;
              for (let x = startX; x <= endX; x += gridW) {
                ctx.beginPath();
                ctx.moveTo(x, 40);
                ctx.lineTo(x, H - 40);
                ctx.stroke();
              }
              ctx.strokeStyle = "rgba(200, 100, 100, 0.4)";
              ctx.lineWidth = 4;
              ctx.beginPath();
              ctx.moveTo(startX, 80);
              ctx.lineTo(endX, 80);
              ctx.stroke();
            }
            // ------ F. ğŸ«§ å¼¥æ•£ Diffusion ------
            if (s.type === "diffusion") {
              ctx.fillStyle = "#1C1C1E";
              ctx.fillRect(0, 0, W, H);
              let g1 = ctx.createRadialGradient(0, 0, 0, W / 1.2, H / 1.2, W);
              g1.addColorStop(0, "rgba(94, 114, 128, 0.4)");
              g1.addColorStop(1, "transparent");
              ctx.fillStyle = g1;
              ctx.fillRect(0, 0, W, H);
              let g2 = ctx.createRadialGradient(W, H, 0, W / 1.2, H / 1.2, W);
              g2.addColorStop(0, "rgba(156, 136, 136, 0.35)");
              g2.addColorStop(1, "transparent");
              ctx.fillStyle = g2;
              ctx.fillRect(0, 0, W, H);
              ctx.save();
              ctx.fillStyle = "rgba(255,255,255,0.03)";
              for (let i = 0; i < 600; i++) {
                const nx = Math.random() * W;
                const ny = Math.random() * H;
                ctx.fillRect(nx, ny, 2, 2);
              }
              ctx.restore();
              ctx.fillStyle = "rgba(255, 255, 255, 0.02)";
              const cardM = 40;
              roundRect(ctx, cardM, cardM, W - cardM * 2, H - cardM * 2, 24);
              ctx.fill();
              const barY = H - cardM - 70;
              ctx.fillStyle = "rgba(255,255,255,0.15)";
              roundRect(ctx, cardM + 50, barY, 100, 4, 2);
              ctx.fill();
              ctx.fillStyle = "rgba(255,255,255,0.5)";
              roundRect(ctx, cardM + 50, barY, 40, 4, 2);
              ctx.fill();
            }
            // ===========================================

            // 6. ç»˜åˆ¶æ–‡å­— (æ ¸å¿ƒä¿®æ”¹å¤„)
            ctx.fillStyle = s.text;
            ctx.textBaseline = "top";

            // é‡æ–°è®¾ç½®å­—ä½“ (ä¸Šé¢ IF/ELSE é‡Œå¯èƒ½æ”¹äº†)
            ctx.font = `${fontWeight} ${fontSize}px ${fontName}`;
            ctx.letterSpacing = s.letter ? "2px" : "0px";

            let drawX = paddingX;
            let drawY = paddingTop;
            if (s.type === "receipt") drawX = (W - 560) / 2;

            // ä½¿ç”¨æ–°çš„ wrapText å¹¶ä¼ å…¥ align
            wrapText(
              ctx,
              text,
              drawX,
              drawY,
              textWidthLimit,
              lineHeight,
              align,
            );

            // 7. ç»˜åˆ¶åº•éƒ¨ä¿¡æ¯
            const footerY = H - paddingBottom + 50;
            ctx.font = `400 22px ${fontName}`;
            ctx.fillStyle = s.sub;
            ctx.textAlign = "left";
            if (s.type === "diffusion") ctx.fillStyle = "rgba(255,255,255,0.5)";

            let footerX = paddingX;
            let realFooterY = footerY;
            let dateStr = date;

            if (s.type === "cute_console") {
              realFooterY = H - 280;
            }
            if (s.type === "receipt") {
              realFooterY = H - 120;
              footerX = drawX;
              dateStr = date + " " + new Date().toLocaleTimeString();
              ctx.font = `400 20px "Courier New"`;
            }
            if (s.type === "diffusion") realFooterY = H - paddingBottom + 30;

            ctx.fillText(dateStr, footerX, realFooterY);

            // Logo / ç­¾å
            ctx.textAlign = "right";
            if (s.type === "dream_os") {
              ctx.font = `300 22px sans-serif`;
              ctx.fillStyle = "#D0C0C0";
              ctx.fillText("MUSEUM", W - paddingX, realFooterY);
            } else if (s.type === "cute_console") {
              ctx.font = `bold 20px sans-serif`;
              ctx.fillStyle = "#B5C9C3";
              ctx.fillText("MUSEUM", W - paddingX, realFooterY);
            } else if (s.type === "zen_editor") {
              ctx.fillStyle = "#81A1C1";
              ctx.fillText("UTF-8", W - 40, H - 20);
            } else if (s.type === "receipt") {
              const barX = W - footerX - 150;
              const barY = H - 135;
              ctx.fillStyle = "#000";
              for (let i = 0; i < 30; i++) {
                const w = Math.random() > 0.5 ? 2 : 5;
                ctx.fillRect(barX + i * 5, barY, w, 40);
              }
              ctx.font = "16px Courier New";
              ctx.fillText("THANKS", W - footerX, barY + 60);
            } else if (s.type === "letter") {
              const sealSize = 60;
              const sealX = W - paddingX - sealSize;
              const sealY = realFooterY - 20;
              ctx.strokeStyle = "#d66";
              ctx.lineWidth = 3;
              ctx.strokeRect(sealX, sealY, sealSize, sealSize);
              ctx.fillStyle = "#d66";
              ctx.font = `400 28px "Noto Serif SC"`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(
                "åš",
                sealX + sealSize / 2 + 2,
                sealY + sealSize / 2 - 12,
              );
              ctx.fillText(
                "ç‰©",
                sealX + sealSize / 2 - 2,
                sealY + sealSize / 2 + 12,
              );
            } else if (s.type === "diffusion") {
              ctx.font = `italic 24px serif`;
              ctx.fillStyle = "rgba(255,255,255,0.4)";
              ctx.fillText("Museum of Thoughts", W - paddingX, realFooterY);
            } else {
              ctx.font = `300 24px "Noto Serif SC"`;
              ctx.fillText("åšç‰©é¦† | MUSEUM", W - paddingX, realFooterY);
            }
          };

          const getRoleCardData = (item) => {
            if (!item || !item.content)
              return { name: "æœªå‘½å", description: "", history: [] };
            try {
              if (
                typeof item.content === "string" &&
                item.content.trim().startsWith("{")
              ) {
                const data = JSON.parse(item.content);
                if (!Array.isArray(data.history)) data.history = [];
                // ç¡®ä¿è¿”å› description
                return {
                  ...data,
                  description: data.description || "",
                };
              }
              return { name: item.content, description: "", history: [] };
            } catch (e) {
              return { name: "æ•°æ®æŸå", description: "", history: [] };
            }
          };

          // === æ–°å¢ï¼šæ‰“å¼€å†å²è®°å½• ===
          const openHistoryModal = (item) => {
            currentHistoryItem.value = item;
            showHistoryModal.value = true;
          };

          // === ä¿®æ”¹åçš„è§’è‰²å¡æ‰“åŒ…ä¸‹è½½å‡½æ•° ===
          const downloadRoleCardPackage = async (item, versionData = null) => {
            const data = getRoleCardData(item);
            // é»˜è®¤å–æœ€æ–°ï¼ˆhistory[0]ï¼‰
            const target = versionData || (data.history && data.history[0]);

            if (!target) return alert("æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ç‰ˆæœ¬");

            // 1. ã€å…³é”®ä¿®æ”¹ã€‘å…ˆæŠŠæŒ‰é’®å…ƒç´ å­˜åˆ°ä¸€ä¸ªå˜é‡ btn é‡Œï¼Œé˜²æ­¢ await ä¹‹åä¸¢å¤±
            const btn = event?.target;
            const originalText = btn?.innerText;

            // ä¿®æ”¹æ–‡å­—
            if (btn) btn.innerText = "æ‰“åŒ…ä¸­...";

            const zip = new JSZip();
            const folderName = `${data.name}_${formatDate(target.date).replace(/[\s:\.]/g, "_")}`;

            try {
              // ä¸‹è½½ PNG
              if (target.png) {
                const blob = await fetch(target.png).then((r) => r.blob());
                zip.file(`${data.name}.png`, blob);
              }
              // ä¸‹è½½ JSON
              if (target.json) {
                const blob = await fetch(target.json).then((r) => r.blob());
                zip.file(`${data.name}.json`, blob);
              }
              // ä¸‹è½½ QR
              if (target.qr) {
                const blob = await fetch(target.qr).then((r) => r.blob());
                zip.file(`${data.name}_qr.png`, blob);
              }

              const content = await zip.generateAsync({ type: "blob" });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(content);
              a.download = `${folderName}.zip`;
              a.click();
            } catch (e) {
              alert("ä¸‹è½½å¤±è´¥ï¼š" + e.message);
            } finally {
              // 2. ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ä¹‹å‰å­˜å¥½çš„ btn å˜é‡æ¥æ¢å¤æ–‡å­—
              if (btn && originalText) btn.innerText = originalText;
            }
          };

          // === æ–°å¢ï¼šå•ç‹¬ä¸‹è½½æŸä¸ªæ–‡ä»¶ ===
          const downloadSingleFile = (url, filename) => {
            if (!url) return;
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.target = "_blank"; // é˜²æ­¢å¹¶åœ¨å½“å‰é¡µæ‰“å¼€
            a.click();
          };

          const handleDownload = (item) => {
            if (item.type === "text") {
              exportItem.value = item;
              exportStyle.value = "classic";
              showExport.value = true;
              previewScale.value = window.innerWidth < 768 ? 90 : 50;
              nextTick(() => drawCard());
            } else if (item.type === "link") {
              downloadString(
                `[InternetShortcut]\nURL=${item.file_url}`,
                "link.url",
                "text/plain",
              );
            } else if (item.type === "beautify") {
              // ç¾åŒ–æ–‡ä»¶ä¸‹è½½é€»è¾‘ï¼šä¸‹è½½å½“å‰é€‰ä¸­é¢œè‰²çš„çœŸå®æ–‡ä»¶
              const data = getBeautifyData(item);
              const idx = getBeautifyIndex(item.id);
              if (data.variations && data.variations[idx]) {
                const variant = data.variations[idx];
                if (variant.file) {
                  downloadFile(variant.file, `${data.title}-${variant.name}`);
                } else {
                  alert("è¯¥é¢œè‰²æ–¹æ¡ˆæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶");
                }
              }
            } else if (item.type === "role_card") {
              // === ã€æ–°å¢ã€‘è§’è‰²å¡å•ç‹¬å¤„ç†ï¼šè§£æåå­—ä½œä¸ºæ–‡ä»¶å ===
              const data = getRoleCardData(item);
              // downloadFile ä¼šè‡ªåŠ¨è¯†åˆ«åç¼€åï¼Œæ‰€ä»¥è¿™é‡Œåªä¼ åå­—å³å¯
              downloadFile(item.file_url, data.name || "role_card");
            } else {
              // é€šç”¨æ–‡ä»¶ä¸‹è½½ï¼ˆåŒ…å« chat ç±»å‹ï¼‰
              downloadFile(item.file_url, item.content || "file");
            }
          };

          const downloadString = (str, name, type) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([str], { type }));
            a.download = name;
            a.click();
          };

          const downloadFile = async (url, name) => {
            try {
              const res = await fetch(url);
              const blob = await res.blob();
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              let ext = url.split(".").pop().split("?")[0];
              if (ext.length > 4 || ext.includes("/")) {
                const type = blob.type;
                if (type.includes("image")) ext = "png";
                else if (type.includes("zip")) ext = "zip";
                else if (type.includes("text/plain")) ext = "txt";
                else if (type.includes("json")) ext = "json";
                else ext = "file";
              }
              a.download = `${name}.${ext}`;
              a.click();
            } catch {
              window.open(url, "_blank");
            }
          };
          // --- æ–°å¢ï¼šå¯¼å‡ºç¾åŒ–åŒ… ---
          const exportBeautifyPackage = async (item) => {
            const data = getBeautifyData(item);
            if (!data.variations || data.variations.length === 0) return;

            const zip = new JSZip();
            // åœ¨çº¦ 1622 è¡Œå·¦å³
            const manifest = {
              type: "museum-beautify-package", // è¯†åˆ«æš—å·
              version: "1.0",
              title: data.title,
              category: item.category, // <--- ã€æ–°å¢ã€‘è¿™é‡ŒåŠ ä¸Š category
              variations: [],
            };

            // æç¤ºç”¨æˆ·æ­£åœ¨æ‰“åŒ…
            const btn = event.currentTarget;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block">â†»</span>`;

            try {
              // éå†æ‰€æœ‰å˜ä½“ï¼ˆé¢œè‰²ï¼‰
              for (let i = 0; i < data.variations.length; i++) {
                const v = data.variations[i];
                const variantInfo = {
                  color: v.color,
                  name: v.name,
                  previewFile: null,
                  realFile: null,
                };

                // ä¸‹è½½é¢„è§ˆå›¾å¹¶å­˜å…¥ ZIP
                if (v.preview) {
                  const blob = await fetch(v.preview).then((r) => r.blob());
                  // è·å–åç¼€
                  let ext = v.preview.split(".").pop().split("?")[0] || "png";
                  if (ext.length > 4) ext = "png";
                  const filename = `p_${i}.${ext}`;
                  zip.file(filename, blob);
                  variantInfo.previewFile = filename;
                }

                // ä¸‹è½½æºæ–‡ä»¶å¹¶å­˜å…¥ ZIP
                if (v.file) {
                  const blob = await fetch(v.file).then((r) => r.blob());
                  let ext = v.file.split(".").pop().split("?")[0] || "zip";
                  if (ext.length > 5) ext = "zip";
                  const filename = `f_${i}.${ext}`;
                  zip.file(filename, blob);
                  variantInfo.realFile = filename;
                }

                manifest.variations.push(variantInfo);
              }

              // å†™å…¥æè¿°æ–‡ä»¶
              zip.file("manifest.json", JSON.stringify(manifest, null, 2));

              // ç”Ÿæˆå¹¶ä¸‹è½½
              const content = await zip.generateAsync({ type: "blob" });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(content);
              a.download = `${data.title || "ç¾åŒ–åŒ…"}.zip`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            } catch (e) {
              console.error(e);
              alert("æ‰“åŒ…å¤±è´¥ï¼šå¯èƒ½å­˜åœ¨ç½‘ç»œè·¨åŸŸé—®é¢˜æˆ–æ–‡ä»¶å·²å¤±æ•ˆã€‚");
            } finally {
              btn.innerHTML = originalIcon;
            }
          };

          const downloadAsImage = () => {
            const link = document.createElement("a");
            link.download = `excerpt-${Date.now()}.png`;
            link.href = quoteCanvas.value.toDataURL("image/png");
            link.click();
          };

          const downloadAsText = () => {
            navigator.clipboard
              .writeText(exportItem.value.content)
              .then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
          };

          const deleteItem = async (item) => {
            if (!confirm("ç¡®è®¤åˆ é™¤?")) return;
            try {
              if (
                item.file_url &&
                item.type !== "link" &&
                item.type !== "beautify"
              ) {
                const p = item.file_url.split("/uploads/").pop();
                if (p) await supabase.storage.from("uploads").remove([p]);
              }
              // å¦‚æœæ˜¯ç¾åŒ–ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å¤šä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæš‚ä¸å¤„ç†æ·±åº¦æ¸…ç†ï¼Œä»…åˆ é™¤è®°å½•
              await supabase.from("fragments").delete().eq("id", item.id);
              items.value = items.value.filter((i) => i.id !== item.id);
            } catch (e) {
              alert(e.message);
            }
          };

          const handleOpenHtml = async (item) => {
            try {
              const res = await fetch(item.file_url);
              const blob = await res.blob();
              window.open(
                URL.createObjectURL(new Blob([blob], { type: "text/html" })),
                "_blank",
              );
            } catch (e) {
              alert("åŠ è½½å¤±è´¥");
            }
          };

          const openLink = (u) =>
            window.open(u.startsWith("http") ? u : "https://" + u, "_blank");
          // --- ä¿®æ”¹ï¼šæ–‡ä»¶é€‰æ‹©å¤„ç†ï¼ˆå¢åŠ æ™ºèƒ½è¯†åˆ«ï¼‰ ---
          const handleFileSelect = async (e) => {
            const selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length === 0) return;

            // æ£€æŸ¥æ˜¯å¦åªæœ‰ä¸€ä¸ª ZIP æ–‡ä»¶ï¼Œä¸”å½“å‰ä¸åœ¨ç¼–è¾‘æ¨¡å¼
            const file = selectedFiles[0];
            if (
              selectedFiles.length === 1 &&
              file.name.endsWith(".zip") &&
              !editingId.value
            ) {
              try {
                // å°è¯•è§£å‹è¯»å–
                const zip = await JSZip.loadAsync(file);
                if (zip.file("manifest.json")) {
                  const manifestStr = await zip
                    .file("manifest.json")
                    .async("string");
                  const manifest = JSON.parse(manifestStr);

                  // ç¡®è®¤æš—å·ï¼šæ˜¯æˆ‘ä»¬çš„ç¾åŒ–åŒ…å—ï¼Ÿ
                  if (manifest.type === "museum-beautify-package") {
                    if (
                      !confirm(
                        `æ£€æµ‹åˆ°ç¾åŒ–èµ„æºåŒ…ï¼š"${manifest.title}"\nåŒ…å« ${manifest.variations.length} ç§æ ·å¼ã€‚\næ˜¯å¦è‡ªåŠ¨å¡«å…¥ç¾åŒ–è¡¨å•ï¼Ÿ`,
                      )
                    ) {
                      // ç”¨æˆ·é€‰æ‹©äº†â€œå¦â€ï¼Œå½“ä½œæ™®é€šæ–‡ä»¶ä¸Šä¼ 
                      uploadForm.value.files = selectedFiles;
                      return;
                    }

                    // === æ™ºèƒ½å¡«å•æ¨¡å¼ ===
                    uploadForm.value.type = "beautify";
                    uploadForm.value.title = manifest.title;
                    // ã€æ–°å¢ã€‘è‡ªåŠ¨å¡«å…¥æ ‡ç­¾
                    if (manifest.category) {
                      uploadForm.value.category = manifest.category;
                    }
                    uploadForm.value.beautifyVariations = []; // æ¸…ç©ºé»˜è®¤

                    // éå†åŒ…å†…æ•°æ®ï¼Œè¿˜åŸä¸º File å¯¹è±¡
                    for (const v of manifest.variations) {
                      const newItem = {
                        colorName: v.name,
                        colorValue: v.color,
                        previewFile: null,
                        realFile: null,
                        previewUrl: null,
                        realUrl: null,
                      };

                      // ä» Zip æå–æ–‡ä»¶è½¬å› File å¯¹è±¡
                      if (v.previewFile && zip.file(v.previewFile)) {
                        const blob = await zip
                          .file(v.previewFile)
                          .async("blob");
                        newItem.previewFile = new File([blob], v.previewFile, {
                          type: blob.type,
                        });
                      }
                      if (v.realFile && zip.file(v.realFile)) {
                        const blob = await zip.file(v.realFile).async("blob");
                        newItem.realFile = new File([blob], v.realFile, {
                          type: blob.type,
                        });
                      }

                      uploadForm.value.beautifyVariations.push(newItem);
                    }
                    return; // ç»“æŸï¼Œä¸å†æ‰§è¡Œæ™®é€šæ–‡ä»¶èµ‹å€¼
                  }
                }
              } catch (err) {
                console.log("éä¸“ç”¨ç¾åŒ–åŒ…ï¼ŒæŒ‰æ™®é€šæ–‡ä»¶å¤„ç†", err);
              }
            }

            // æ™®é€šæ–‡ä»¶å¤„ç†é€»è¾‘ï¼ˆä¿æŒåŸæ ·ï¼‰
            uploadForm.value.files = selectedFiles;
          };

          const selectTag = (tag) => {
            currentTag.value = tag;
            currentAlbum.value = null;
            filter.value = "all";
          };
          const handleEdit = (item) => {
            editingId.value = item.id;

            // 1. å‡†å¤‡ç¾åŒ–æ•°æ®
            const isBeautify = item.type === "beautify";
            const beautifyData = isBeautify ? getBeautifyData(item) : null;

            // 2. å‡†å¤‡è§’è‰²å¡æ•°æ®
            if (item.type === "role_card") {
              const roleData = getRoleCardData(item);
              roleCardForm.value = {
                name: roleData.name || "",
                description: roleData.description || "", // <--- æ–°å¢ï¼šå›å¡«ä»‹ç»
                pngFile: null,
                jsonFile: null,
                qrFile: null,
                note: "",
              };
            } else {
              // å¦‚æœä¸æ˜¯è§’è‰²å¡ï¼Œé‡ç½®ä¸€ä¸‹ï¼Œå…å¾—æ®‹ç•™
              roleCardForm.value = {
                name: "",
                pngFile: null,
                jsonFile: null,
                qrFile: null,
                note: "",
              };
            }

            // 3. å¡«å…¥é€šç”¨è¡¨å•æ•°æ®
            uploadForm.value = {
              type: item.type,
              category: item.category || "", // æŠŠæ—§æ ‡ç­¾å¡«å›å»ï¼
              // ä¸‹é¢æ˜¯ä¿®æ”¹åçš„é€»è¾‘ï¼šç¾åŒ–ç±»å‹è¦è¯»å–è§£æåçš„ title
              title: isBeautify
                ? beautifyData.title || ""
                : item.type === "font"
                  ? item.content || ""
                  : item.type === "text"
                    ? ""
                    : item.content,
              content: item.type === "font" ? item.content : item.content,
              url:
                item.type === "link" || item.type === "font"
                  ? item.file_url
                  : "",
              files: [],
              useAlbum: !!item.album_name,
              albumName: item.album_name
                ? item.album_name.startsWith(".")
                  ? item.album_name.substring(1)
                  : item.album_name
                : "",
              beautifyVariations:
                isBeautify && beautifyData.variations
                  ? beautifyData.variations.map((v) => ({
                      colorName: v.name,
                      colorValue: v.color,
                      previewUrl: v.preview,
                      realUrl: v.file,
                      previewFile: null,
                      realFile: null,
                    }))
                  : [],
              fontSourceType: item.file_url ? "url" : "file",
            };

            // å¦‚æœæ˜¯ç¾åŒ–ç±»å‹ä½†æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤é¡¹
            if (
              isBeautify &&
              uploadForm.value.beautifyVariations.length === 0
            ) {
              addBeautifyItem();
            }

            showUpload.value = true;
          };

          const toggleAlbumVisibility = async () => {
            if (!currentAlbum.value || !supabase) return;
            const oldName = currentAlbum.value;
            const isHidden = oldName.startsWith(".");
            const newName = isHidden ? oldName.substring(1) : "." + oldName;

            if (
              !confirm(
                `ç¡®è®¤å°†æ­¤ç›¸å†Œè®¾ä¸º "${isHidden ? "å…¬å¼€æ˜¾ç¤º" : "ä»…ç›¸å†Œå†…å¯è§"}" å—ï¼Ÿ\n${isHidden ? "å…¬å¼€åï¼Œå›¾ç‰‡å°†å‡ºç°åœ¨â€œå½±åƒâ€æµä¸­ã€‚" : "éšè—åï¼Œå›¾ç‰‡å°†ä»â€œå½±åƒâ€æµä¸­æ¶ˆå¤±ï¼Œä»…åœ¨æ­¤ç›¸å†Œå†…æ˜¾ç¤ºã€‚"}`,
              )
            )
              return;

            loading.value = true;
            try {
              // 1. å‘é€æ›´æ–°è¯·æ±‚
              const { error } = await supabase
                .from("fragments")
                .update({ album_name: newName })
                .eq("album_name", oldName);

              if (error) throw error;

              // 2. ã€å…³é”®ä¿®æ”¹ã€‘ä¸æ‰‹åŠ¨ä¿®æ”¹æœ¬åœ°æ•°ç»„ï¼Œè€Œæ˜¯é‡æ–°æ‹‰å–æœåŠ¡å™¨æ•°æ®
              // è¿™æ ·èƒ½ä¿è¯å¦‚æœæœåŠ¡å™¨æ²¡å­˜è¿›å»ï¼Œé¡µé¢ä¸Šç«‹é©¬èƒ½çœ‹å‡ºæ¥
              await fetchData();

              // 3. ä¿æŒå½“å‰æµè§ˆçš„ç›¸å†Œè§†å›¾ä¸è¢«å…³é—­
              currentAlbum.value = newName;
            } catch (e) {
              alert("æ“ä½œå¤±è´¥: " + e.message);
            } finally {
              loading.value = false;
            }
          };

          // TUS ä¸Šä¼ è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å¤§æ–‡ä»¶
          const uploadWithTus = (file, fileName) => {
            return new Promise((resolve, reject) => {
              // æ„é€  TUS ä¸Šä¼ ç«¯ç‚¹ï¼š[PROJECT_URL]/storage/v1/upload/resumable
              const endpoint = `${config.value.url.replace(/\/$/, "")}/storage/v1/upload/resumable`;

              const upload = new tus.Upload(file, {
                endpoint: endpoint,
                retryDelays: [0, 3000, 5000, 10000, 20000],
                headers: {
                  authorization: `Bearer ${session.value.access_token}`,
                  "x-client-info": "supabase-js-web",
                },
                metadata: {
                  bucketName: "uploads",
                  objectName: fileName,
                  contentType: file.type,
                  cacheControl: "3600",
                },
                chunkSize: 6 * 1024 * 1024, // 6MB chunks
                onError: (error) => {
                  console.error("TUS Upload Failed:", error);
                  reject(error);
                },
                onSuccess: () => {
                  resolve();
                },
              });
              upload.start();
            });
          };
          const submitUpload = async () => {
            if (!supabase) return;
            uploading.value = true;
            try {
              // è§£æ„å¸¸ç”¨å˜é‡
              const {
                type,
                category,
                content,
                title,
                url,
                files,
                useAlbum,
                albumName,
                beautifyVariations,
                fontSourceType,
              } = uploadForm.value;

              const cat = category || "æœªåˆ†ç±»";
              const uid = session.value.user.id;

              // åˆå§‹åŒ– payloadï¼Œæ‰€æœ‰ç±»å‹å…±ç”¨çš„å­—æ®µ
              let payload = { category: cat, user_id: uid, type: type };

              // ==========================================
              // 1. æ„å»ºæ•°æ®åŒ… (Payload Construction)
              // ==========================================

              // --- A. è§’è‰²å¡é€»è¾‘ (ä¿®å¤æ ¸å¿ƒï¼šä¿ç•™åå­—ã€æ ‡ç­¾å’Œå†å²) ---
              if (type === "role_card") {
                // 1. åˆå§‹åŒ–å˜é‡ï¼šä¼˜å…ˆä½¿ç”¨è¡¨å•é‡Œçš„æ–°è¾“å…¥
                let finalName = roleCardForm.value.name;
                let finalHistory = [];
                let finalFileUrl = null;

                // 2. å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¯»å–æ—§æ•°æ®è¿›è¡Œå›å¡«
                if (editingId.value) {
                  const oldItem = items.value.find(
                    (i) => i.id === editingId.value,
                  );
                  if (oldItem) {
                    finalFileUrl = oldItem.file_url; // é»˜è®¤ä¿ç•™æ—§å°é¢

                    // ã€ä¿®å¤æ ‡ç­¾ã€‘ï¼šå¦‚æœè¡¨å•æ²¡å¡«æ ‡ç­¾ï¼ˆå¯¼è‡´ payload.category ä¸º "æœªåˆ†ç±»"ï¼‰ï¼Œåˆ™å¼ºåˆ¶æ¢å¤æ—§æ ‡ç­¾
                    if (payload.category === "æœªåˆ†ç±»" && oldItem.category) {
                      payload.category = oldItem.category;
                    }

                    try {
                      const parsed = JSON.parse(oldItem.content);

                      // ã€ä¿®å¤åå­—ã€‘ï¼šå¦‚æœè¡¨å•é‡Œçš„åå­—ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨æ—§æ•°æ®çš„åå­—
                      if (!finalName && parsed.name) {
                        finalName = parsed.name;
                      }

                      // ã€ä¿®å¤å†å²ã€‘ï¼šç¡®ä¿æŠŠæ—§çš„å†å²è®°å½•æ‹¿è¿‡æ¥
                      if (
                        parsed &&
                        parsed.history &&
                        Array.isArray(parsed.history)
                      ) {
                        finalHistory = parsed.history;
                      }
                    } catch (e) {
                      console.error("æ—§æ•°æ®è§£æå¤±è´¥", e);
                    }
                  }
                }

                // 3. ç»„è£…å½“å‰æ•°æ®å¯¹è±¡
                let currentData = {
                  name: finalName || "æœªå‘½åè§’è‰²",
                  description: roleCardForm.value.description || "", // <--- æ–°å¢ï¼šä¿å­˜ä»‹ç»
                  history: finalHistory,
                };

                // å®šä¹‰å†…éƒ¨ä¸Šä¼ å‡½æ•°
                const uploadRoleFile = async (file, prefix) => {
                  if (!file) return null;
                  const ext = file.name.split(".").pop();
                  const fname = `role_${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${ext}`;
                  const { error } = await supabase.storage
                    .from("uploads")
                    .upload(fname, file);
                  if (error) throw error;
                  const { data } = supabase.storage
                    .from("uploads")
                    .getPublicUrl(fname);
                  return data.publicUrl;
                };

                // å¹¶è¡Œä¸Šä¼ ä¸‰ä¸ªæ–‡ä»¶
                const [pngUrl, jsonUrl, qrUrl] = await Promise.all([
                  uploadRoleFile(roleCardForm.value.pngFile, "card"),
                  uploadRoleFile(roleCardForm.value.jsonFile, "json"),
                  uploadRoleFile(roleCardForm.value.qrFile, "qr"),
                ]);

                // å¦‚æœæœ‰ä»»ä½•æ–°æ–‡ä»¶ï¼Œç”Ÿæˆæ–°ç‰ˆæœ¬è®°å½•
                if (pngUrl || jsonUrl || qrUrl) {
                  const newVersion = {
                    date: Date.now(),
                    png: pngUrl,
                    json: jsonUrl,
                    qr: qrUrl,
                    note: roleCardForm.value.note || "", // ä¿å­˜æ›´æ–°æ—¥å¿—
                  };

                  // ç»§æ‰¿ä¸Šä¸€ç‰ˆçš„ç©ºç¼ºæ–‡ä»¶ (é˜²æ­¢åªä¼ äº†JSONå¯¼è‡´å°é¢ä¸¢å¤±)
                  if (currentData.history.length > 0) {
                    const last = currentData.history[0];
                    if (!newVersion.png) newVersion.png = last.png;
                    if (!newVersion.json) newVersion.json = last.json;
                    if (!newVersion.qr) newVersion.qr = last.qr;
                  }

                  // æ’å…¥æ–°ç‰ˆæœ¬åˆ°å†å²è®°å½•å¤´éƒ¨
                  currentData.history.unshift(newVersion);

                  // æ›´æ–°å°é¢ï¼šæ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„ PNG
                  if (newVersion.png) {
                    finalFileUrl = newVersion.png;
                  }
                }

                // èµ‹å€¼ç»™ payload
                payload.content = JSON.stringify(currentData);
                payload.file_url = finalFileUrl;

                // æ–°å»ºå¡ç‰‡å¿…é¡»æœ‰å°é¢
                if (!editingId.value && !payload.file_url) {
                  throw new Error("æ–°å»ºè§’è‰²å¡å¿…é¡»ä¸Šä¼  PNG å¡é¢");
                }
              }

              // --- B. å­—ä½“é€»è¾‘ ---
              else if (type === "font") {
                payload.content = content || "æœªå‘½åå­—ä½“";
                if (fontSourceType === "url") {
                  payload.file_url = url;
                }
                // å¦‚æœæ˜¯æ–‡ä»¶æ¨¡å¼ï¼Œå°†åœ¨ä¸‹æ–¹é€šç”¨æ–‡ä»¶å¤„ç†é€»è¾‘ä¸­è¢«è¦†ç›–ï¼Œæˆ–è€…è¿™é‡Œå…ˆè·³è¿‡
              }

              // --- C. æ–‡å­—/é“¾æ¥é€»è¾‘ ---
              else if (type === "text") {
                payload.content = content;
              } else if (type === "link") {
                payload.content = title || url;
                payload.file_url = url;
              }

              // --- D. ç¾åŒ–åŒ…é€»è¾‘ ---
              else if (type === "beautify") {
                if (!beautifyVariations || beautifyVariations.length === 0)
                  throw new Error("è¯·è‡³å°‘æ·»åŠ ä¸€ç§é…è‰²æ–¹æ¡ˆ");

                const variations = [];
                for (const v of beautifyVariations) {
                  let previewUrl = v.previewUrl;
                  if (v.previewFile) {
                    const pExt = v.previewFile.name.split(".").pop();
                    const pName = `beautify_prev_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${pExt}`;
                    const { error: pErr } = await supabase.storage
                      .from("uploads")
                      .upload(pName, v.previewFile);
                    if (pErr) throw pErr;
                    const { data: pData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(pName);
                    previewUrl = pData.publicUrl;
                  }

                  let realUrl = v.realUrl;
                  if (v.realFile) {
                    const fExt = v.realFile.name.split(".").pop();
                    const fName = `beautify_file_${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${fExt}`;
                    if (v.realFile.size > 6 * 1024 * 1024) {
                      await uploadWithTus(v.realFile, fName);
                    } else {
                      const { error: fErr } = await supabase.storage
                        .from("uploads")
                        .upload(fName, v.realFile);
                      if (fErr) throw fErr;
                    }
                    const { data: fData } = supabase.storage
                      .from("uploads")
                      .getPublicUrl(fName);
                    realUrl = fData.publicUrl;
                  }
                  variations.push({
                    name: v.colorValue,
                    color: v.colorValue,
                    preview: previewUrl,
                    file: realUrl,
                  });
                }
                payload.content = JSON.stringify({
                  title: title || "æœªå‘½åä¸»é¢˜",
                  variations: variations,
                });
                payload.file_url = variations[0].preview;
              }

              // --- E. å…¶ä»–é€šç”¨ç±»å‹ (Image/Chat/Html) æ ‡é¢˜å¤„ç† ---
              else {
                payload.content = title;
                if (type === "image") {
                  if (useAlbum && albumName) {
                    const existingHidden = albumList.value.find(
                      (a) => a.isHidden && a.displayName === albumName,
                    );
                    payload.album_name = existingHidden
                      ? existingHidden.realName
                      : albumName;
                  } else {
                    payload.album_name = null;
                  }
                }
              }

              // ==========================================
              // 2. æ•°æ®åº“å†™å…¥ (Database Insertion)
              // ==========================================

              if (editingId.value) {
                // ====== ç¼–è¾‘æ¨¡å¼ (UPDATE) ======
                const { data, error } = await supabase
                  .from("fragments")
                  .update(payload)
                  .eq("id", editingId.value)
                  .select();

                if (error) throw error;
                if (!data || data.length === 0)
                  throw new Error("æ›´æ–°å¤±è´¥ï¼Œè®°å½•å¯èƒ½ä¸å­˜åœ¨");
              } else {
                // ====== æ–°å¢æ¨¡å¼ (INSERT) ======

                // ã€å…³é”®ä¿®å¤ç‚¹ã€‘ï¼šåœ¨è¿™é‡ŒåŠ ä¸Š role_card å’Œ font
                // è¿™äº›ç±»å‹æ˜¯â€œå•æ¡è®°å½•â€æ¨¡å¼ï¼Œä¸éœ€è¦å¾ªç¯ files æ•°ç»„
                if (
                  type === "text" ||
                  type === "link" ||
                  type === "beautify" ||
                  type === "role_card" ||
                  (type === "font" && fontSourceType === "url")
                ) {
                  const { error } = await supabase
                    .from("fragments")
                    .insert(payload); // payload é‡Œå·²ç»åŒ…å«äº† type, user_id ç­‰

                  if (error) throw error;
                } else if (
                  files.length ||
                  (type === "font" && fontSourceType === "file")
                ) {
                  // === æ‰¹é‡æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ (Image, Chat, Html, Font-File) ===

                  // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯å­—ä½“æ–‡ä»¶æ¨¡å¼ï¼Œfiles å…¶å®æ˜¯ç©ºçš„ï¼Œè¦ç”¨ uploadForm.files
                  // ä½†ä¸Šé¢çš„ handleFileSelect é€»è¾‘æ˜¯æŠŠæ–‡ä»¶æ”¾å…¥ uploadForm.files
                  // åªæœ‰ role_card å’Œ beautify æ˜¯ç‰¹ä¾‹ç”¨è‡ªå·±çš„æ•°ç»„

                  const filesToUpload =
                    type === "font" && fontSourceType === "file"
                      ? uploadForm.value.files
                      : files;

                  await Promise.all(
                    filesToUpload.map(async (f) => {
                      const ext = f.name.split(".").pop();
                      const fname = `${Date.now()}-${Math.random().toString(36).substr(2, 5)}.${ext}`;

                      if (f.size > 6 * 1024 * 1024) {
                        await uploadWithTus(f, fname);
                      } else {
                        const { error } = await supabase.storage
                          .from("uploads")
                          .upload(fname, f, {
                            contentType:
                              ext === "html"
                                ? "text/html"
                                : ext === "ttf" ||
                                    ext === "otf" ||
                                    ext === "woff"
                                  ? "font/" + ext
                                  : undefined,
                          });
                        if (error) throw error;
                      }

                      const { data } = supabase.storage
                        .from("uploads")
                        .getPublicUrl(fname);

                      // æ’å…¥æ¯å¼ å›¾ç‰‡çš„è®°å½•
                      return supabase.from("fragments").insert({
                        type,
                        category: cat,
                        content: type === "font" ? content || f.name : title, // å­—ä½“ç”¨è¾“å…¥çš„åå­—ï¼Œå›¾ç‰‡ç”¨æ ‡é¢˜
                        file_url: data.publicUrl,
                        user_id: uid,
                        album_name: payload.album_name,
                      });
                    }),
                  );
                }
              }

              // --- 3. åˆ·æ–°ä¸é‡ç½® ---
              await fetchData();

              showUpload.value = false;
              editingId.value = null;

              // é‡ç½®è¡¨å•
              uploadForm.value = {
                type: "text",
                category: "",
                title: "",
                url: "",
                content: "",
                files: [],
                useAlbum: false,
                albumName: "",
                fontSourceType: "file",
                beautifyVariations: [
                  {
                    colorName: "é»˜è®¤",
                    colorValue: "#000000",
                    previewFile: null,
                    realFile: null,
                    previewUrl: null,
                    realUrl: null,
                  },
                ],
              };
              // é‡ç½®è§’è‰²å¡è¡¨å•
              roleCardForm.value = {
                name: "",
                pngFile: null,
                jsonFile: null,
                qrFile: null,
                note: "", // <--- é‡ç½®
              };
            } catch (e) {
              console.error(e);
              alert("æ“ä½œå¤±è´¥: " + e.message);
            } finally {
              uploading.value = false;
            }
          };
          // === ã€æ–°å¢ã€‘è‡ªåŠ¨ç›‘å¬è®¾ç½®å˜åŒ–ï¼Œå®ç°å®æ—¶é¢„è§ˆ ===
          watch(
            exportSettings,
            () => {
              // åªè¦ exportSettings é‡Œæœ‰ä»»ä½•å˜åŠ¨ï¼Œå°±é‡ç»˜
              // ä½¿ç”¨ requestAnimationFrame é¿å…æ‹–åŠ¨å¤ªå¿«æ—¶å¡é¡¿
              requestAnimationFrame(() => {
                drawCard();
              });
            },
            { deep: true }, // æ·±åº¦ç›‘å¬ï¼šç›‘å¬å¯¹è±¡å†…éƒ¨çš„å±æ€§å˜åŒ–
          );

          return {
            config,
            auth,
            session,
            items,
            filter,
            filterMap,
            currentAlbum,
            currentTag,
            filteredItems,
            albumList,
            styles,
            showUpload,
            uploadForm,
            loading,
            uploading,
            errorMsg,
            fileStatusText,
            uploadTypes,
            lightboxImage,
            showExport,
            exportItem,
            exportStyle,
            quoteCanvas,
            handleLogin,
            handleLogout,
            handleFileSelect,
            submitUpload,
            deleteItem,
            handleOpenHtml,
            openLink,
            setFilter: (f) => {
              filter.value = f;
              currentAlbum.value = null;
              currentTag.value = null;
            },
            openAlbum: (n) => {
              currentAlbum.value = n;
              currentTag.value = null;
            },
            resetFilter: () => {
              if (currentTag.value) currentTag.value = null;
              else if (currentAlbum.value) currentAlbum.value = null;
              else filter.value = "all";
            },
            openLightbox: (u) => (lightboxImage.value = u),
            closeLightbox: () => (lightboxImage.value = null),
            closeExport: () => {
              showExport.value = false;
              exportItem.value = null;
            },
            handleDownload,
            changeExportStyle,
            downloadAsImage,
            downloadAsText,
            formatDate,
            getRealContent,
            getTags,
            selectTag,
            showInstallBtn,
            triggerInstall,
            editingId,
            handleEdit,
            toggleAlbumVisibility,
            handleFileSelect,
            exportBeautifyPackage,
            showThemeModal,
            currentTheme,
            themeOptions,
            setTheme,
            // æ–°å¢ç¾åŒ–ç›¸å…³
            getBeautifyData,
            getBeautifyPreview,
            addBeautifyItem,
            removeBeautifyItem,
            getBeautifyIndex,
            setBeautifyIndex,
            handleBeautifyZipImport,
            currentGlobalFontId, // <--- æ–°å¢
            applyFont,
            roleCardForm,
            getRoleCardData,
            downloadRoleCardPackage,
            downloadSingleFile,
            showHistoryModal,
            currentHistoryItem,
            openHistoryModal,
            toggleFlip, // <--- æ–°å¢
            flippedCards, // <--- æ–°å¢
            expandedTextItems,
            toggleTextExpand,
            showTagList,
            tagSuggestions,
            applyTagSuggestion,
            exportSettings,
            fontList,
            previewScale,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
